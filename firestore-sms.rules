/**
 * Firestore Security Rules for SMS Configuration System
 * 
 * @description
 * Security rules for SMS configuration collections, ensuring proper
 * access control for country-based SMS provider settings and statistics.
 * 
 * @collections
 * - sms_configurations: Country-specific SMS provider settings
 * - sms_statistics: Usage statistics and cost tracking
 * - otp_verifications: OTP verification records (server-only)
 * - rate_limits: Rate limiting data (server-only)
 * 
 * @security_model
 * - Country admins can manage their country's SMS configuration
 * - Super admins have global access
 * - OTP data is server-only for security
 * - Statistics are read-only for admins
 * 
 * @author Request Marketplace Team
 * @version 1.0.0
 * @since 2025-08-16
 */

// === SMS CONFIGURATIONS COLLECTION ===
// Allow country admins to configure SMS providers for their country
match /sms_configurations/{configId} {
  // Country admins can read/write their country's configuration
  allow read, write: if isAdmin() && 
    (isSuperAdmin() || resource.data.country == getUserCountry());
  
  // Allow creation if user is admin and setting their own country
  allow create: if isAdmin() && 
    (isSuperAdmin() || request.resource.data.country == getUserCountry());
}

// === SMS STATISTICS COLLECTION ===
// Allow admins to view SMS usage statistics
match /sms_statistics/{country} {
  // Country admins can read their country's statistics
  // Super admins can read all statistics
  allow read: if isAdmin() && 
    (isSuperAdmin() || country == getUserCountry());
  
  // Only server can write statistics (via Cloud Functions)
  allow write: if false; // Server-only writes
}

// === OTP VERIFICATIONS COLLECTION ===
// Server-only collection for OTP verification records
match /otp_verifications/{otpId} {
  // No client access - only server via Cloud Functions
  allow read, write: if false;
}

// === RATE LIMITS COLLECTION ===
// Server-only collection for rate limiting
match /rate_limits/{limitId} {
  // No client access - only server via Cloud Functions
  allow read, write: if false;
}

// === USER PROFILES COLLECTION ===
// Updated rules to support SMS authentication
match /users/{userId} {
  // Users can read/write their own profile
  allow read, write: if request.auth != null && request.auth.uid == userId;
  
  // Admins can read user profiles for their country
  allow read: if isAdmin() && 
    (isSuperAdmin() || resource.data.country == getUserCountry());
}

// === HELPER FUNCTIONS ===

/**
 * Check if user is authenticated admin
 */
function isAdmin() {
  return request.auth != null && 
    exists(/databases/$(database)/documents/admin_users/$(request.auth.uid));
}

/**
 * Check if user is super admin
 */
function isSuperAdmin() {
  return isAdmin() && 
    get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.role == 'super_admin';
}

/**
 * Get user's assigned country
 */
function getUserCountry() {
  return get(/databases/$(database)/documents/admin_users/$(request.auth.uid)).data.country;
}

/**
 * Check if user can access country data
 */
function canAccessCountry(country) {
  return isSuperAdmin() || getUserCountry() == country;
}
