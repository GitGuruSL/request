<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Marketplace - Complete Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            height: 100vh;
            background: linear-gradient(145deg, #667eea 0%, #764ba2 100%);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }
        .main-content {
            margin-left: 250px;
            background-color: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }
        .stat-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .nav-link {
            color: white !important;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 2px 10px;
            transition: all 0.3s ease;
        }
        .nav-link:hover, .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: white !important;
        }
        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 20px;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-active { background-color: #d4edda; color: #155724; }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-rejected { background-color: #f8d7da; color: #721c24; }
        .status-completed { background-color: #d1ecf1; color: #0c5460; }
        
        /* Business Products Collapsible Styles */
        .collapse {
            display: none;
        }
        .collapse.show {
            display: block;
        }
        .product-card-header:hover {
            background-color: #f8f9fa;
        }
        .toggle-icon {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar text-white" style="width: 250px;">
        <div class="p-3">
            <h4><i class="fas fa-store me-2"></i>Admin Panel</h4>
        </div>
        <nav class="nav flex-column mt-3">
            <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
            </a>
            <a class="nav-link position-relative" href="#" onclick="showSection('users')">
                <i class="fas fa-users me-2"></i>Users
                <span id="usersBadge" class="notification-badge" style="display: none;">0</span>
            </a>
            <a class="nav-link position-relative" href="#" onclick="showSection('drivers')">
                <i class="fas fa-car me-2"></i>Drivers
                <span id="driversBadge" class="notification-badge" style="display: none;">0</span>
            </a>
            <a class="nav-link position-relative" href="#" onclick="showSection('business')">
                <i class="fas fa-building me-2"></i>Business
                <span id="businessBadge" class="notification-badge" style="display: none;">0</span>
            </a>
            <a class="nav-link position-relative" href="#" onclick="showSection('requests')">
                <i class="fas fa-clipboard-list me-2"></i>Requests
                <span id="requestsBadge" class="notification-badge">0</span>
            </a>
            
            <!-- Divider -->
            <hr class="mx-3 my-3" style="border-color: rgba(255,255,255,0.3);">
            
            <!-- Products Section -->
            <a class="nav-link position-relative" href="#" onclick="showSection('master-products')">
                <i class="fas fa-box me-2"></i>Master Products
                <span id="masterProductsBadge" class="notification-badge" style="display: none;">0</span>
            </a>
            <a class="nav-link position-relative" href="#" onclick="showSection('business-products')">
                <i class="fas fa-shopping-bag me-2"></i>Business Products
                <span id="businessProductsBadge" class="notification-badge">0</span>
            </a>
            <a class="nav-link" href="#" onclick="showSection('categories')">
                <i class="fas fa-tags me-2"></i>Categories
            </a>
            <a class="nav-link" href="#" onclick="showSection('brands')">
                <i class="fas fa-award me-2"></i>Brands
            </a>
            <a class="nav-link" href="#" onclick="showSection('subcategories')">
                <i class="fas fa-sitemap me-2"></i>Subcategories
            </a>
            <a class="nav-link" href="#" onclick="showSection('product-variables')">
                <i class="fas fa-palette me-2"></i>Product Variables
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Auto-refresh controls -->
        <div class="d-flex justify-content-end mb-3">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="manualRefresh()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh Now
                </button>
                <button type="button" class="btn btn-outline-success btn-sm" id="refreshToggleBtn" onclick="toggleAutoRefresh()">
                    <i class="fas fa-pause me-1"></i>Pause Auto-Refresh
                </button>
            </div>
        </div>
        
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-tachometer-alt me-2"></i>Dashboard Overview</h2>
                <div id="refreshIndicator"></div>
            </div>
            <div class="row mt-4">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stat-card card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="card-title">Total Users</h6>
                                    <h3 class="mb-0" id="totalUsers">0</h3>
                                </div>
                                <div class="flex-shrink-0">
                                    <i class="fas fa-users fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stat-card card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="card-title">Active Drivers</h6>
                                    <h3 class="mb-0" id="totalDrivers">0</h3>
                                </div>
                                <div class="flex-shrink-0">
                                    <i class="fas fa-car fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stat-card card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="card-title">Businesses</h6>
                                    <h3 class="mb-0" id="totalBusinesses">0</h3>
                                </div>
                                <div class="flex-shrink-0">
                                    <i class="fas fa-building fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="stat-card card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="card-title">Active Requests</h6>
                                    <h3 class="mb-0" id="totalRequests">0</h3>
                                </div>
                                <div class="flex-shrink-0">
                                    <i class="fas fa-clipboard-list fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="table-container">
                <h4><i class="fas fa-clock me-2"></i>Recent Activity</h4>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivityTable">
                            <!-- Recent activity will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="users-section" class="section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-users me-2"></i>Users Management</h2>
                <button class="btn btn-primary" onclick="showAddUserModal()">
                    <i class="fas fa-plus me-2"></i>Add User
                </button>
            </div>
            
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Drivers Section -->
        <div id="drivers-section" class="section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-car me-2"></i>Drivers Management</h2>
                <button class="btn btn-primary" onclick="showAddDriverModal()">
                    <i class="fas fa-plus me-2"></i>Add Driver
                </button>
            </div>
            
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Vehicle</th>
                                <th>License</th>
                                <th>Status</th>
                                <th>Rating</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="driversTable">
                            <!-- Drivers will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Business Section -->
        <div id="business-section" class="section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-building me-2"></i>Business Management</h2>
                <button class="btn btn-primary" onclick="showAddBusinessModal()">
                    <i class="fas fa-plus me-2"></i>Add Business
                </button>
            </div>
            
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Business Name</th>
                                <th>Email</th>
                                <th>Category</th>
                                <th>Status</th>
                                <th>Products</th>
                                <th>Registered</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="businessTable">
                            <!-- Businesses will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Requests Section -->
        <div id="requests-section" class="section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-clipboard-list me-2"></i>Service Requests</h2>
                <div>
                    <button class="btn btn-outline-primary me-2" onclick="filterRequests('all')">All</button>
                    <button class="btn btn-outline-warning me-2" onclick="filterRequests('pending')">Pending</button>
                    <button class="btn btn-outline-success me-2" onclick="filterRequests('active')">Active</button>
                    <button class="btn btn-outline-info" onclick="filterRequests('completed')">Completed</button>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Request ID</th>
                                <th>User</th>
                                <th>Type</th>
                                <th>Location</th>
                                <th>Driver</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTable">
                            <!-- Requests will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Master Products Section -->
        <div id="master-products-section" class="section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-box me-2"></i>Master Products</h2>
                <div>
                    <button class="btn btn-primary" onclick="showAddMasterProductModal()">
                        <i class="fas fa-plus me-2"></i>Add Master Product
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Brand</th>
                                <th>Category</th>
                                <th>Status</th>
                                <th>Business Listings</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="masterProductsTable">
                            <!-- Master products will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Business Products Section -->
        <div id="business-products-section" class="section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-shopping-bag me-2"></i>Business Product Listings</h2>
                <div>
                    <button class="btn btn-outline-secondary me-2" onclick="debugBusinessProductsData()">
                        <i class="fas fa-bug me-2"></i>Debug Data
                    </button>
                    <button class="btn btn-outline-primary me-2" onclick="refreshBusinessProducts()">
                        <i class="fas fa-refresh me-2"></i>Refresh
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div id="businessProductsContainer">
                        <!-- Business products will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories Section -->
        <div id="categories-section" class="section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-tags me-2"></i>Product Categories</h2>
                <div>
                    <button class="btn btn-primary" onclick="showAddCategoryModal()">
                        <i class="fas fa-plus me-2"></i>Add Category
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Applicable For</th>
                                <th>Products Count</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesTable">
                            <!-- Categories will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    <!-- Brands Section -->
    <div id="brands-section" class="section" style="display: none;">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-award me-2"></i>Brands</h2>
                <div>
                    <button class="btn btn-primary" onclick="showAddBrandModal()">
                        <i class="fas fa-plus me-2"></i>Add Brand
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Website</th>
                                <th>Products Count</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="brandsTable">
                            <!-- Brands will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Subcategories Section -->
    <div id="subcategories-section" class="section" style="display: none;">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-sitemap me-2"></i>Subcategories</h2>
                <div>
                    <button class="btn btn-primary" onclick="showAddSubcategoryModal()">
                        <i class="fas fa-plus me-2"></i>Add Subcategory
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Parent Category</th>
                                <th>Description</th>
                                <th>Products Count</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="subcategoriesTable">
                            <!-- Subcategories will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Variables Section -->
    <div id="product-variables-section" class="section" style="display: none;">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-palette me-2"></i>Product Variables</h2>
                <div>
                    <button class="btn btn-primary" onclick="showAddVariableModal()">
                        <i class="fas fa-plus me-2"></i>Add Variable
                    </button>
                </div>
            </div>
            
            <!-- Variable Types Tabs -->
            <ul class="nav nav-tabs mb-4" id="variableTabs" role="tablist" style="border: 2px solid red; background-color: #f8f9fa;">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="colors-tab" data-bs-toggle="tab" data-bs-target="#colors" type="button" role="tab" style="border: 1px solid blue;">
                        <i class="fas fa-palette me-2"></i>Colors
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sizes-tab" data-bs-toggle="tab" data-bs-target="#sizes" type="button" role="tab" style="border: 1px solid green;">
                        <i class="fas fa-expand-arrows-alt me-2"></i>Sizes
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="materials-tab" data-bs-toggle="tab" data-bs-target="#materials" type="button" role="tab" style="border: 1px solid orange;">
                        <i class="fas fa-cube me-2"></i>Materials
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="custom-tab" data-bs-toggle="tab" data-bs-target="#custom" type="button" role="tab" style="border: 1px solid purple;">
                        <i class="fas fa-cogs me-2"></i>Custom Variables
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="variableTabContent">
                <!-- Colors Tab -->
                <div class="tab-pane fade show active" id="colors" role="tabpanel">
                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Color Name</th>
                                        <th>Hex Code</th>
                                        <th>Color Preview</th>
                                        <th>Usage Count</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="colorsTable">
                                    <!-- Colors will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Sizes Tab -->
                <div class="tab-pane fade" id="sizes" role="tabpanel">
                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Size Name</th>
                                        <th>Category</th>
                                        <th>Description</th>
                                        <th>Usage Count</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="sizesTable">
                                    <!-- Sizes will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Materials Tab -->
                <div class="tab-pane fade" id="materials" role="tabpanel">
                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Material Name</th>
                                        <th>Description</th>
                                        <th>Properties</th>
                                        <th>Usage Count</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="materialsTable">
                                    <!-- Materials will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Custom Variables Tab -->
                <div class="tab-pane fade" id="custom" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5><i class="fas fa-cogs me-2"></i>Custom Variables</h5>
                            <p class="text-muted mb-0">These variables are automatically available in product creation</p>
                        </div>
                        <div>
                            <button class="btn btn-info btn-sm me-2" onclick="loadCustomVariables()" title="Manual Refresh">
                                <i class="fas fa-sync-alt me-1"></i>Refresh
                            </button>
                            <button class="btn btn-primary btn-sm me-2" onclick="debugCustomVariables()" title="Debug & Show All Variables">
                                <i class="fas fa-bug me-1"></i>Debug Variables
                            </button>
                            <button class="btn btn-success btn-sm me-2" onclick="createSampleCustomVariables()">
                                <i class="fas fa-database me-1"></i>Create Sample Variables
                            </button>
                            <button class="btn btn-warning btn-sm me-2" onclick="fixCapacityVariables()">
                                <i class="fas fa-wrench me-1"></i>Fix Variables
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteAllCustomVariables()">
                                <i class="fas fa-trash me-1"></i>Delete All
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="table table-striped" id="customVariablesTable">
                                <thead>
                                    <tr>
                                        <th>Variable Name</th>
                                        <th>Type</th>
                                        <th>Possible Values</th>
                                        <th>Required</th>
                                        <th>Usage Count</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="customVariablesTableBody">
                                    <!-- Custom variables will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Driver View Modal - This will be dynamically created -->
    <div id="driverModalContainer">
        <!-- Comprehensive driver modal will be inserted here dynamically -->
    </div>

    <!-- User View Modal Container -->
    <div id="userModalContainer">
        <!-- User modal will be inserted here dynamically -->
    </div>

    <!-- Request View Modal Container -->
    <div id="requestModalContainer">
        <!-- Request modal will be inserted here dynamically -->
    </div>

    <!-- Modals will go here... -->
    <!-- (Previous modal code would be included here) -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            getDoc,
            updateDoc, 
            deleteDoc,
            doc,
            setDoc,
            orderBy,
            query,
            where,
            onSnapshot,
            Timestamp,
            deleteField,
            arrayRemove,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCtuD42SzwxKmSY5p-x5olFex2U_S9YrMk",
            authDomain: "request-marketplace.firebaseapp.com",
            projectId: "request-marketplace",
            storageBucket: "request-marketplace.appspot.com",
            messagingSenderId: "355474518888",
            appId: "1:355474518888:web:7b3a7f6f7d7a8b0d8e8f9f"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make available globally
        window.db = db;
        window.addDoc = addDoc;
        window.collection = collection;
        window.getDocs = getDocs;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.setDoc = setDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.onSnapshot = onSnapshot;
        window.Timestamp = Timestamp;
        window.deleteField = deleteField;
        window.arrayRemove = arrayRemove;
        window.serverTimestamp = serverTimestamp;

        console.log('🔥 Firebase initialized successfully!');
        console.log('📄 Page loaded successfully! Custom Variables debug button is available in: Product Variables → Custom Variables tab');
        console.log('🔍 To debug custom variables: 1) Click "Product Variables" in sidebar, 2) Click "Custom Variables" tab, 3) Click "Debug Variables" button');
        
        // Debug: Check if tabs exist
        setTimeout(() => {
            const tabsContainer = document.getElementById('variableTabs');
            const customTab = document.getElementById('custom-tab');
            console.log('🔍 TABS DEBUG:');
            console.log('  - variableTabs container:', tabsContainer);
            console.log('  - custom-tab button:', customTab);
            console.log('  - All tabs:', document.querySelectorAll('#variableTabs .nav-link'));
        }, 1000);
    </script>
    <script>
        // Global variables
        let users = [];
        let drivers = [];
        let businesses = [];
        let requests = [];
        let masterProducts = [];
        let businessProducts = [];
        let categories = [];
        
        // Auto-refresh configuration
        let autoRefreshInterval = null;
        let autoRefreshEnabled = true;
        const REFRESH_INTERVAL = 30000; // 30 seconds
        let currentSection = 'dashboard';
        
        // Auto-refresh functionality
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            if (autoRefreshEnabled) {
                autoRefreshInterval = setInterval(() => {
                    // Only refresh if not in a modal
                    if (!document.querySelector('.modal.show')) {
                        refreshCurrentSection();
                        updateRefreshIndicator();
                    }
                }, REFRESH_INTERVAL);
            }
        }
        
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            
            if (autoRefreshEnabled) {
                startAutoRefresh();
                showToast('Auto-refresh enabled', 'success');
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                showToast('Auto-refresh disabled', 'info');
            }
            
            updateRefreshButton();
        }
        
        function refreshCurrentSection() {
            switch(currentSection) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'drivers':
                    loadDrivers();
                    break;
                case 'businesses':
                    loadBusinesses();
                    break;
                case 'requests':
                    loadRequests();
                    break;
                case 'products':
                    loadMasterProducts();
                    break;
                case 'business-products':
                    loadBusinessProducts();
                    break;
                case 'categories':
                    loadCategories();
                    break;
                case 'product-variables':
                    // Refresh all product variables (Custom Variables now integrated into product creation)
                    loadColors();
                    loadSizes();
                    loadMaterials();
                    break;
            }
        }
        
        function updateRefreshIndicator() {
            // Add refresh indicator to header if it doesn't exist
            let indicator = document.getElementById('refreshIndicator');
            if (!indicator) {
                const header = document.querySelector('.top-bar .navbar-nav');
                if (header) {
                    header.insertAdjacentHTML('afterbegin', `
                        <li class="nav-item">
                            <span class="navbar-text" id="refreshIndicator"></span>
                        </li>
                    `);
                    indicator = document.getElementById('refreshIndicator');
                }
            }
            
            if (indicator && autoRefreshEnabled) {
                indicator.innerHTML = `
                    <small class="text-success">
                        <i class="fas fa-sync-alt fa-spin me-1"></i>
                        Refreshing...
                    </small>
                `;
                
                // Clear after 2 seconds
                setTimeout(() => {
                    if (indicator) {
                        indicator.innerHTML = `
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                ${new Date().toLocaleTimeString()}
                            </small>
                        `;
                    }
                }, 2000);
            }
        }
        
        function manualRefresh() {
            refreshCurrentSection();
            updateRefreshIndicator();
            showToast('Data refreshed manually', 'success');
        }
        
        // Toast notification system
        function showToast(message, type = 'info') {
            const toastContainer = getOrCreateToastContainer();
            const toastId = 'toast-' + Date.now();
            
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // Remove after toast is hidden
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }
        
        function getOrCreateToastContainer() {
            let container = document.getElementById('toastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'toast-container position-fixed top-0 end-0 p-3';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
            }
            return container;
        }

        // Navigation
        function showSection(sectionName) {
            // Update current section
            currentSection = sectionName;
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Update nav active state
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Find and activate the correct nav link
            const targetLink = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
            if (targetLink) {
                targetLink.classList.add('active');
            }
            
            // Show selected section
            const sectionElement = document.getElementById(sectionName + '-section');
            if (sectionElement) {
                sectionElement.style.display = 'block';
            }
            
            // Load data for the section
            switch(sectionName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'drivers':
                    loadDrivers();
                    break;
                case 'business':
                    loadBusinesses();
                    break;
                case 'requests':
                    loadRequests();
                    break;
                case 'master-products':
                    loadMasterProducts();
                    break;
                case 'business-products':
                    loadBusinessProducts();
                    break;
                case 'categories':
                    loadCategories();
                    break;
                case 'brands':
                    loadBrands();
                    break;
                case 'subcategories':
                    loadSubcategories();
                    break;
                case 'product-variables':
                    loadProductVariables();
                    break;
            }
        }

        // Dashboard functions
        async function loadDashboard() {
            try {
                // Load all collections for stats
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const driversSnapshot = await getDocs(collection(db, 'drivers'));
                const businessesSnapshot = await getDocs(collection(db, 'businesses'));
                const requestsSnapshot = await getDocs(collection(db, 'requests'));

                // Update dashboard stats
                document.getElementById('totalUsers').textContent = usersSnapshot.size;
                document.getElementById('totalDrivers').textContent = driversSnapshot.size;
                document.getElementById('totalBusinesses').textContent = businessesSnapshot.size;
                document.getElementById('totalRequests').textContent = requestsSnapshot.size;

                // Update notification badges
                updateNotificationBadges();
                
                // Load recent activity
                loadRecentActivity();
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadUsers() {
            try {
                const snapshot = await getDocs(collection(db, 'users'));
                users = [];
                snapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });

                const tbody = document.getElementById('usersTable');
                tbody.innerHTML = '';

                users.forEach(user => {
                    const row = tbody.insertRow();
                    const joinedDate = user.createdAt ? 
                        new Date(user.createdAt.seconds * 1000).toLocaleDateString() : 
                        'Unknown';

                    row.innerHTML = `
                        <td>${user.displayName || user.name || 'N/A'}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td>${user.phone || 'N/A'}</td>
                        <td><span class="status-badge ${user.isActive ? 'status-active' : 'status-pending'}">${user.isActive ? 'Active' : 'Inactive'}</span></td>
                        <td>${joinedDate}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewUser('${user.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="editUser('${user.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading users:', error);
                showError('Error loading users: ' + error.message);
            }
        }

        async function loadDrivers() {
            try {
                const snapshot = await getDocs(collection(db, 'drivers'));
                drivers = [];
                snapshot.forEach(doc => {
                    drivers.push({ id: doc.id, ...doc.data() });
                });

                const tbody = document.getElementById('driversTable');
                tbody.innerHTML = '';

                drivers.forEach(driver => {
                    const isApproved = driver.status === 'approved' || driver.isVerified === true;
                    const statusText = isApproved ? 'Approved' : (driver.status || 'Pending');
                    const statusClass = isApproved ? 'status-active' : 'status-pending';

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${driver.name || 'N/A'}</td>
                        <td>${driver.email || 'N/A'}</td>
                        <td>${driver.vehicleType || 'N/A'} - ${driver.vehicleModel || ''}</td>
                        <td>${driver.licenseNumber || 'N/A'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${driver.rating || 'N/A'} ⭐</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewDriver('${driver.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            ${!isApproved ? `
                                <button class="btn btn-sm btn-outline-success" onclick="approveDriver('${driver.id}')">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-outline-warning" onclick="editDriver('${driver.id}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            `}
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading drivers:', error);
                showError('Error loading drivers: ' + error.message);
            }
        }

        async function loadBusinesses() {
            try {
                businesses = [];
                
                // Load businesses from the dedicated businesses collection
                const businessesSnapshot = await getDocs(collection(db, 'businesses'));
                businessesSnapshot.forEach(doc => {
                    const businessData = { id: doc.id, ...doc.data() };
                    console.log(`📄 Business ${doc.id} structure:`, {
                        hasBasicInfo: !!businessData.basicInfo,
                        hasVerification: !!businessData.verification,
                        flatName: businessData.businessName,
                        nestedName: businessData.basicInfo?.name,
                        flatEmail: businessData.email,
                        nestedEmail: businessData.basicInfo?.email,
                        flatEmailVerified: businessData.isEmailVerified,
                        nestedEmailVerified: businessData.verification?.isEmailVerified
                    });
                    businesses.push(businessData);
                });

                // Also load business profiles from users collection
                const usersSnapshot = await getDocs(collection(db, 'users'));
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.businessProfile) {
                        const businessProfile = userData.businessProfile;
                        const businessData = {
                            id: doc.id, // Use user ID as business ID
                            source: 'users', // Mark the source
                            businessName: businessProfile.businessName,
                            email: businessProfile.email || '', // Get email from businessProfile
                            businessType: businessProfile.businessType,
                            businessCategories: businessProfile.businessCategories || [],
                            businessAddress: businessProfile.businessAddress,
                            verificationStatus: businessProfile.verificationStatus,
                            isActive: businessProfile.isActive,
                            averageRating: businessProfile.averageRating || 0,
                            totalReviews: businessProfile.totalReviews || 0,
                            createdAt: userData.createdAt,
                            // Additional user info
                            userName: userData.name,
                            userPhone: userData.phoneNumber,
                            userRoles: userData.roles || []
                        };
                        console.log(`📱 User business profile ${doc.id}:`, businessData);
                        businesses.push(businessData);
                    }
                });

                const tbody = document.getElementById('businessTable');
                tbody.innerHTML = '';

                for (const business of businesses) {
                    // Count products for this business
                    const productsQuery = query(
                        collection(db, 'business_products'),
                        where('businessId', '==', business.id)
                    );
                    const productsSnapshot = await getDocs(productsQuery);
                    const productCount = productsSnapshot.size;

                    const registeredDate = business.createdAt ? 
                        new Date(business.createdAt.seconds * 1000).toLocaleDateString() : 
                        'Unknown';

                    // Handle both new nested structure, legacy flat structure, and user business profiles
                    let businessName, businessEmail, businessCategory, isVerified;
                    
                    if (business.source === 'users') {
                        // Data from users collection with businessProfile
                        businessName = business.businessName || business.userName || 'N/A';
                        businessEmail = business.email || 'N/A';
                        businessCategory = business.businessCategories?.[0] || business.businessType || 'N/A';
                        isVerified = business.verificationStatus === 'approved' || false;
                    } else {
                        // Data from businesses collection (legacy)
                        businessName = business.basicInfo?.name || business.businessName || 'N/A';
                        businessEmail = business.basicInfo?.email || business.email || 'N/A';
                        businessCategory = business.basicInfo?.categories?.[0] || business.category || business.businessType || 'N/A';
                        isVerified = business.verification?.overallStatus === 'verified' || business.isVerified || false;
                    }

                    const statusText = isVerified ? 'Verified' : (business.verificationStatus || 'Pending');
                    const statusClass = isVerified ? 'status-active' : 'status-pending';

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${businessName}${business.source === 'users' ? ' <small class="text-muted">(Mobile App)</small>' : ''}</td>
                        <td>${businessEmail}</td>
                        <td>${businessCategory}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${productCount}</td>
                        <td>${registeredDate}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBusiness('${business.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="verifyBusiness('${business.id}')">
                                <i class="fas fa-check"></i> Verify
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteBusiness('${business.id}', '${businessName}', '${business.source || 'businesses'}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                }
            } catch (error) {
                console.error('Error loading businesses:', error);
                showError('Error loading businesses: ' + error.message);
            }
        }

        async function loadRequests() {
            try {
                const snapshot = await getDocs(collection(db, 'requests'));
                requests = [];
                snapshot.forEach(doc => {
                    requests.push({ id: doc.id, ...doc.data() });
                });

                const tbody = document.getElementById('requestsTable');
                tbody.innerHTML = '';

                requests.forEach(request => {
                    const createdDate = request.createdAt ? 
                        new Date(request.createdAt.seconds * 1000).toLocaleDateString() : 
                        'Unknown';

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>#${request.id.substring(0, 8)}</td>
                        <td>${request.userName || request.userId || 'N/A'}</td>
                        <td>${request.type || request.serviceType || 'N/A'}</td>
                        <td>${request.location || request.pickupLocation || 'N/A'}</td>
                        <td>${request.driverName || request.driverId || 'Unassigned'}</td>
                        <td><span class="status-badge status-${request.status || 'pending'}">${request.status || 'Pending'}</span></td>
                        <td>${createdDate}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewRequest('${request.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="assignDriver('${request.id}')">
                                <i class="fas fa-user"></i> Assign
                            </button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading requests:', error);
                showError('Error loading requests: ' + error.message);
            }
        }

        async function loadMasterProducts() {
            try {
                const snapshot = await getDocs(collection(db, 'master_products'));
                masterProducts = [];
                snapshot.forEach(doc => {
                    masterProducts.push({ id: doc.id, ...doc.data() });
                });

                const tbody = document.getElementById('masterProductsTable');
                tbody.innerHTML = '';

                for (const product of masterProducts) {
                    // Count business listings for this product
                    const listingsQuery = query(
                        collection(db, 'business_products'),
                        where('masterProductId', '==', product.id)
                    );
                    const listingsSnapshot = await getDocs(listingsQuery);
                    const listingCount = listingsSnapshot.size;

                    const category = categories.find(c => c.id === product.categoryId || c.category === product.category) || { category: product.category || 'Unknown' };

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${product.name}</td>
                        <td>${product.brand}</td>
                        <td>${category.category}</td>
                        <td><span class="status-badge ${product.isActive ? 'status-active' : 'status-pending'}">${product.isActive ? 'Active' : 'Inactive'}</span></td>
                        <td>${listingCount}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewMasterProduct('${product.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="editMasterProduct('${product.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteMasterProduct('${product.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                }
            } catch (error) {
                console.error('Error loading master products:', error);
                showError('Error loading master products: ' + error.message);
            }
        }

        async function loadBusinessProducts() {
            try {
                // First, ensure we have all the required data loaded
                console.log('Loading business products...');
                
                // Load all required collections in parallel
                const [businessProductsSnapshot, masterProductsSnapshot, businessesSnapshot] = await Promise.all([
                    getDocs(collection(db, 'business_products')),
                    getDocs(collection(db, 'master_products')),
                    getDocs(collection(db, 'businesses'))
                ]);

                // Update global arrays
                businessProducts = [];
                businessProductsSnapshot.forEach(doc => {
                    businessProducts.push({ id: doc.id, ...doc.data() });
                });

                masterProducts = [];
                masterProductsSnapshot.forEach(doc => {
                    masterProducts.push({ id: doc.id, ...doc.data() });
                });

                businesses = [];
                businessesSnapshot.forEach(doc => {
                    businesses.push({ id: doc.id, ...doc.data() });
                });

                console.log(`Loaded: ${businessProducts.length} business products, ${masterProducts.length} master products, ${businesses.length} businesses`);

                const container = document.getElementById('businessProductsContainer');
                container.innerHTML = '';

                if (businessProducts.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Business Products Found</h5>
                            <p class="text-muted">No businesses have added products yet.</p>
                        </div>
                    `;
                    return;
                }

                // Group products by master product
                const productGroups = {};
                
                for (const product of businessProducts) {
                    // Find master product with better error handling
                    let masterProduct = masterProducts.find(mp => mp.id === product.masterProductId);
                    
                    if (!masterProduct) {
                        // Try to fetch the specific master product if not found
                        try {
                            const masterProductDoc = await getDoc(doc(db, 'master_products', product.masterProductId));
                            if (masterProductDoc.exists()) {
                                masterProduct = { id: masterProductDoc.id, ...masterProductDoc.data() };
                                masterProducts.push(masterProduct); // Add to cache
                            } else {
                                masterProduct = { 
                                    id: product.masterProductId,
                                    name: `Product ${product.masterProductId.substring(0, 8)}...`, 
                                    description: 'Master product not found in database',
                                };
                            }
                        } catch (error) {
                            console.error('Error fetching master product:', error);
                            masterProduct = { 
                                id: product.masterProductId,
                                name: 'Product Data Error', 
                                description: 'Error loading product details',
                            };
                        }
                    }
                    
                    if (!productGroups[masterProduct.id]) {
                        productGroups[masterProduct.id] = {
                            masterProduct: masterProduct,
                            listings: []
                        };
                    }
                    
                    // Find business with better error handling
                    let business = businesses.find(b => b.id === product.businessId);
                    
                    if (!business) {
                        // Try to fetch the specific business if not found
                        try {
                            const businessDoc = await getDoc(doc(db, 'businesses', product.businessId));
                            if (businessDoc.exists()) {
                                business = { id: businessDoc.id, ...businessDoc.data() };
                                businesses.push(business); // Add to cache
                            } else {
                                business = { 
                                    businessName: `Business ${product.businessId.substring(0, 8)}...`,
                                    contactName: 'Contact not available',
                                    phone: 'Phone not available',
                                    email: 'Email not available'
                                };
                            }
                        } catch (error) {
                            console.error('Error fetching business:', error);
                            business = { 
                                businessName: 'Business Data Error',
                                contactName: 'Contact unavailable',
                                phone: 'Phone unavailable',
                                email: 'Email unavailable'
                            };
                        }
                    }
                    
                    productGroups[masterProduct.id].listings.push({
                        ...product,
                        business: business
                    });
                }

                // Create HTML for each product group
                for (const [masterProductId, group] of Object.entries(productGroups)) {
                    const totalListings = group.listings.length;
                    const minPrice = Math.min(...group.listings.map(l => l.price || 0));
                    const maxPrice = Math.max(...group.listings.map(l => l.price || 0));
                    const totalStock = group.listings.reduce((sum, l) => sum + (l.stock || 0), 0);
                    
                    const priceRange = minPrice === maxPrice ? 
                        `LKR ${minPrice.toFixed(2)}` : 
                        `LKR ${minPrice.toFixed(2)} - ${maxPrice.toFixed(2)}`;

                    const productCard = document.createElement('div');
                    productCard.className = 'border rounded mb-3';
                    productCard.innerHTML = `
                        <div class="p-3 cursor-pointer" onclick="toggleProductDetails('${masterProductId}')" style="cursor: pointer;">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <h6 class="mb-1">${group.masterProduct.name}</h6>
                                    <small class="text-muted">${group.masterProduct.description || 'No description available'}</small>
                                </div>
                                <div class="col-md-2">
                                    <strong>${priceRange}</strong>
                                </div>
                                <div class="col-md-2">
                                    <span class="badge bg-primary">${totalListings} Seller${totalListings > 1 ? 's' : ''}</span>
                                </div>
                                <div class="col-md-2">
                                    <span class="text-muted">Stock: ${totalStock}</span>
                                </div>
                                <div class="col-md-2 text-end">
                                    <i class="fas fa-chevron-down toggle-icon-${masterProductId}"></i>
                                </div>
                            </div>
                        </div>
                        <div id="details-${masterProductId}" class="collapse">
                            <div class="border-top p-3 bg-light">
                                <h6 class="mb-3">Sellers & Pricing Details</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered mb-0">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Business Name</th>
                                                <th>Contact</th>
                                                <th>Price</th>
                                                <th>Stock</th>
                                                <th>Variables</th>
                                                <th>Date Added</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${group.listings.map(listing => {
                                                const submittedDate = listing.createdAt ? 
                                                    new Date(listing.createdAt.seconds * 1000).toLocaleDateString() : 
                                                    'Unknown';
                                                
                                                const variables = listing.selectedVariables ? 
                                                    Object.entries(listing.selectedVariables).map(([key, value]) => 
                                                        `${key}: ${value}`
                                                    ).join(', ') : 'No variables';

                                                return `
                                                    <tr>
                                                        <td>
                                                            <strong>${listing.business.businessName}</strong><br>
                                                            <small class="text-muted">ID: ${listing.businessId}</small>
                                                        </td>
                                                        <td>
                                                            <small>
                                                                ${listing.business.contactName || 'No contact'}<br>
                                                                ${listing.business.phone || 'No phone'}<br>
                                                                ${listing.business.email || 'No email'}
                                                            </small>
                                                        </td>
                                                        <td><strong>LKR ${listing.price.toFixed(2)}</strong></td>
                                                        <td>${listing.stock || 0}</td>
                                                        <td><small>${variables}</small></td>
                                                        <td><small>${submittedDate}</small></td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(productCard);
                }

                if (Object.keys(productGroups).length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Business Products Found</h5>
                            <p class="text-muted">No businesses have added products yet.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading business products:', error);
                showToast('Error loading business products: ' + error.message, 'error');
            }
        }

        // Toggle function for expanding/collapsing product details
        function toggleProductDetails(masterProductId) {
            const detailsDiv = document.getElementById(`details-${masterProductId}`);
            const toggleIcon = document.querySelector(`.toggle-icon-${masterProductId}`);
            
            if (detailsDiv.classList.contains('show')) {
                detailsDiv.classList.remove('show');
                toggleIcon.className = `fas fa-chevron-down toggle-icon-${masterProductId}`;
            } else {
                detailsDiv.classList.add('show');
                toggleIcon.className = `fas fa-chevron-up toggle-icon-${masterProductId}`;
            }
        }

        // Refresh function
        function refreshBusinessProducts() {
            console.log('Refreshing business products...');
            loadBusinessProducts();
            showToast('Business products refreshed', 'success');
        }

        // Debug function to check data integrity
        function debugBusinessProductsData() {
            console.log('=== BUSINESS PRODUCTS DEBUG ===');
            console.log('Business Products:', businessProducts.length, businessProducts);
            console.log('Master Products:', masterProducts.length, masterProducts);
            console.log('Businesses:', businesses.length, businesses);
            
            // Check for missing references
            const missingMasterProducts = businessProducts.filter(bp => 
                !masterProducts.find(mp => mp.id === bp.masterProductId)
            );
            const missingBusinesses = businessProducts.filter(bp => 
                !businesses.find(b => b.id === bp.businessId)
            );
            
            console.log('Missing Master Products:', missingMasterProducts);
            console.log('Missing Businesses:', missingBusinesses);
        }

        async function loadCategories() {
            try {
                const snapshot = await getDocs(collection(db, 'categories'));
                categories = [];
                snapshot.forEach(doc => {
                    categories.push({ id: doc.id, ...doc.data() });
                });

                console.log('Loaded categories:', categories);

                const tbody = document.getElementById('categoriesTable');
                tbody.innerHTML = '';

                if (categories.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-3x mb-3"></i><br>
                                <h5>No Categories Found</h5>
                                <p>Click "Import from Mobile App" to create the category structure</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                for (const category of categories) {
                    // Count products in this category
                    const productsQuery = query(
                        collection(db, 'master_products'),
                        where('categoryId', '==', category.id)
                    );
                    const productsSnapshot = await getDocs(productsQuery);
                    const productCount = productsSnapshot.size;

                    // Count subcategories in this category
                    const subcategoriesQuery = query(
                        collection(db, 'subcategories'),
                        where('category_id', '==', category.id)
                    );
                    const subcategoriesSnapshot = await getDocs(subcategoriesQuery);
                    const subcategoryCount = subcategoriesSnapshot.size;

                    // Format type badge
                    const typeBadge = category.type === 'item' ? 
                        '<span class="badge bg-success">Item</span>' : 
                        '<span class="badge bg-warning">Service</span>';

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>
                            <strong>${category.category}</strong>
                            <br><small class="text-muted">${subcategoryCount} subcategories</small>
                        </td>
                        <td>
                            <small class="text-muted">
                                ${category.type === 'item' ? 
                                    'Used for item requests and master products' : 
                                    'Used for service requests only'
                                }
                            </small>
                        </td>
                        <td>${typeBadge}</td>
                        <td>${productCount}</td>
                        <td><span class="badge bg-success">Active</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewCategoryDetails('${category.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="editCategory('${category.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory('${category.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                }
            } catch (error) {
                console.error('Error loading categories:', error);
                showToast('Error loading categories: ' + error.message, 'error');
            }
        }
        
        async function createInitialCategories() {
            try {
                console.log('Creating initial categories with new structure...');
                
                // Define categories for different types
                const itemCategories = [
                    'Electronics',
                    'Vehicles', 
                    'Fashion & Clothing',
                    'Home & Garden',
                    'Sports & Recreation',
                    'Books & Media',
                    'Health & Beauty'
                ];
                
                const serviceCategories = [
                    'Home Services',
                    'Transportation',
                    'Professional Services',
                    'Health & Wellness',
                    'Education & Training',
                    'Entertainment',
                    'Business Services'
                ];
                
                // Create item categories
                const itemCategoryIds = {};
                for (const categoryName of itemCategories) {
                    const docRef = await addDoc(collection(db, 'categories'), {
                        category: categoryName,
                        type: 'item'
                    });
                    itemCategoryIds[categoryName] = docRef.id;
                    console.log(`Created item category: ${categoryName}`);
                }
                
                // Create service categories  
                const serviceCategoryIds = {};
                for (const categoryName of serviceCategories) {
                    const docRef = await addDoc(collection(db, 'categories'), {
                        category: categoryName,
                        type: 'service'
                    });
                    serviceCategoryIds[categoryName] = docRef.id;
                    console.log(`Created service category: ${categoryName}`);
                }
                
                // Create subcategories for items
                const itemSubcategories = [
                    { category: 'Electronics', subcategories: ['Mobile Phones', 'Laptops & Computers', 'Audio & Video', 'Gaming'] },
                    { category: 'Vehicles', subcategories: ['Cars', 'Motorcycles', 'Bicycles', 'Parts & Accessories'] },
                    { category: 'Fashion & Clothing', subcategories: ['Clothing', 'Shoes', 'Accessories', 'Jewelry'] },
                    { category: 'Home & Garden', subcategories: ['Furniture', 'Tools', 'Appliances', 'Decor'] },
                    { category: 'Sports & Recreation', subcategories: ['Fitness Equipment', 'Outdoor Gear', 'Sports Equipment', 'Games'] }
                ];
                
                for (const categoryGroup of itemSubcategories) {
                    const categoryId = itemCategoryIds[categoryGroup.category];
                    if (categoryId) {
                        for (const subcategoryName of categoryGroup.subcategories) {
                            await addDoc(collection(db, 'subcategories'), {
                                subcategory: subcategoryName,
                                category_id: categoryId
                            });
                            console.log(`Created item subcategory: ${subcategoryName} under ${categoryGroup.category}`);
                        }
                    }
                }
                
                // Create subcategories for services
                const serviceSubcategories = [
                    { category: 'Home Services', subcategories: ['Cleaning', 'Plumbing', 'Electrical', 'Repairs'] },
                    { category: 'Transportation', subcategories: ['Delivery', 'Moving Services', 'Taxi Services', 'Logistics'] },
                    { category: 'Professional Services', subcategories: ['Tutoring', 'Photography', 'Design', 'Consulting'] },
                    { category: 'Health & Wellness', subcategories: ['Fitness Training', 'Nutrition', 'Therapy', 'Medical Services'] },
                    { category: 'Education & Training', subcategories: ['Academic Tutoring', 'Language Learning', 'Skills Training', 'Test Preparation'] }
                ];
                
                for (const categoryGroup of serviceSubcategories) {
                    const categoryId = serviceCategoryIds[categoryGroup.category];
                    if (categoryId) {
                        for (const subcategoryName of categoryGroup.subcategories) {
                            await addDoc(collection(db, 'subcategories'), {
                                subcategory: subcategoryName,
                                category_id: categoryId
                            });
                            console.log(`Created service subcategory: ${subcategoryName} under ${categoryGroup.category}`);
                        }
                    }
                }
                
                const totalCategories = itemCategories.length + serviceCategories.length;
                const totalSubcategories = itemSubcategories.reduce((sum, group) => sum + group.subcategories.length, 0) + 
                                          serviceSubcategories.reduce((sum, group) => sum + group.subcategories.length, 0);
                
                showToast(`Created ${totalCategories} categories and ${totalSubcategories} subcategories successfully`, 'success');
                console.log(`✅ Created ${totalCategories} categories and ${totalSubcategories} subcategories with new structure`);
                
            } catch (error) {
                console.error('Error creating initial categories:', error);
                showToast('Error creating initial categories: ' + error.message, 'error');
            }
        }

        async function activateAllCategories() {
            try {
                console.log('🔄 Activating all categories...');
                
                // Show loading indication
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Activating...';
                button.disabled = true;

                const snapshot = await getDocs(collection(db, 'product_categories'));
                let activatedCount = 0;

                const updatePromises = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (!data.isActive) {
                        const docRef = doc.ref;
                        updatePromises.push(
                            updateDoc(docRef, {
                                isActive: true,
                                updatedAt: new Date()
                            })
                        );
                        activatedCount++;
                    }
                });

                await Promise.all(updatePromises);

                // Restore button
                button.innerHTML = originalText;
                button.disabled = false;

                if (activatedCount > 0) {
                    showSuccess(`✅ Successfully activated ${activatedCount} categories!`);
                    console.log(`✅ Activated ${activatedCount} categories`);
                    
                    // Reload categories to show updated status
                    await loadCategories();
                } else {
                    showSuccess('ℹ️ All categories are already active!');
                }

            } catch (error) {
                console.error('❌ Error activating categories:', error);
                showError('Error activating categories: ' + error.message);
                
                // Restore button on error
                const button = event.target;
                button.innerHTML = '<i class="fas fa-check-circle me-2"></i>Activate All Categories';
                button.disabled = false;
            }
        }

        // Delete all categories function
        async function deleteAllCategories() {
            const confirmDelete = confirm('⚠️ This will delete ALL categories and subcategories permanently. Are you sure?');
            if (!confirmDelete) return;

            try {
                console.log('🗑️ Deleting all categories and subcategories...');
                
                // Show loading indication
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';
                button.disabled = true;

                // Delete all categories
                const categoriesSnapshot = await getDocs(collection(db, 'categories'));
                const deletePromises = [];
                
                categoriesSnapshot.forEach(doc => {
                    deletePromises.push(deleteDoc(doc.ref));
                });

                await Promise.all(deletePromises);

                // Restore button
                button.innerHTML = originalText;
                button.disabled = false;

                showToast(`✅ Deleted ${categoriesSnapshot.size} categories successfully!`, 'success');
                
                // Reload categories to show empty table
                await loadCategories();

            } catch (error) {
                console.error('❌ Error deleting categories:', error);
                showToast('Error deleting categories: ' + error.message, 'error');
                
                // Restore button on error
                const button = event.target;
                button.innerHTML = '<i class="fas fa-trash me-2"></i>Delete All Categories';
                button.disabled = false;
            }
        }

        // Import categories from mobile app function
        async function importCategoriesFromMobileApp() {
            const confirmImport = confirm('This will import the clean category structure from mobile app. Continue?');
            if (!confirmImport) return;

            try {
                console.log('� Importing categories from mobile app...');
                
                // Show loading indication
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Importing...';
                button.disabled = true;

                // Simple clean category structure
                const simpleCategories = [
                    // ITEM CATEGORIES (for Request Item + Master Products)
                    {
                        category: 'Electronics',
                        type: 'item'
                    },
                    {
                        category: 'Vehicles',
                        type: 'item'
                    },
                    {
                        category: 'Home & Garden',
                        type: 'item'
                    },
                    {
                        category: 'Fashion',
                        type: 'item'
                    },
                    {
                        category: 'Sports & Recreation',
                        type: 'item'
                    },
                    {
                        category: 'Baby & Kids',
                        type: 'item'
                    },
                    {
                        category: 'Books & Education',
                        type: 'item'
                    },
                    
                    // SERVICE CATEGORIES (for Request Service only)
                    {
                        category: 'Home Services',
                        type: 'service'
                    },
                    {
                        category: 'Transportation',
                        type: 'service'
                    },
                    {
                        category: 'Professional Services',
                        type: 'service'
                    },
                    {
                        category: 'Personal Services',
                        type: 'service'
                    },
                    {
                        category: 'Technical Services',
                        type: 'service'
                    },
                    {
                        category: 'Event Services',
                        type: 'service'
                    },
                    {
                        category: 'Education & Training',
                        type: 'service'
                    }
                ];

                // Create categories
                const categoryPromises = [];
                for (const categoryData of simpleCategories) {
                    categoryPromises.push(
                        addDoc(collection(db, 'categories'), categoryData)
                    );
                }

                const categoryRefs = await Promise.all(categoryPromises);
                console.log(`✅ Created ${categoryRefs.length} categories`);

                // Now create subcategories with category_id references
                const subcategoriesData = [
                    // Electronics subcategories
                    { subcategory: 'Mobile Phones', categoryName: 'Electronics' },
                    { subcategory: 'Laptops & Computers', categoryName: 'Electronics' },
                    { subcategory: 'Gaming Consoles', categoryName: 'Electronics' },
                    { subcategory: 'TV & Audio', categoryName: 'Electronics' },
                    { subcategory: 'Cameras', categoryName: 'Electronics' },
                    { subcategory: 'Accessories', categoryName: 'Electronics' },
                    
                    // Vehicles subcategories
                    { subcategory: 'Cars', categoryName: 'Vehicles' },
                    { subcategory: 'Motorcycles', categoryName: 'Vehicles' },
                    { subcategory: 'Bicycles', categoryName: 'Vehicles' },
                    { subcategory: 'Parts & Accessories', categoryName: 'Vehicles' },
                    
                    // Home & Garden subcategories
                    { subcategory: 'Tools', categoryName: 'Home & Garden' },
                    { subcategory: 'Furniture', categoryName: 'Home & Garden' },
                    { subcategory: 'Appliances', categoryName: 'Home & Garden' },
                    { subcategory: 'Kitchen Items', categoryName: 'Home & Garden' },
                    { subcategory: 'Garden', categoryName: 'Home & Garden' },
                    
                    // Fashion subcategories
                    { subcategory: 'Clothing', categoryName: 'Fashion' },
                    { subcategory: 'Shoes', categoryName: 'Fashion' },
                    { subcategory: 'Bags', categoryName: 'Fashion' },
                    { subcategory: 'Jewelry', categoryName: 'Fashion' },
                    { subcategory: 'Watches', categoryName: 'Fashion' },
                    
                    // Home Services subcategories
                    { subcategory: 'Cleaning', categoryName: 'Home Services' },
                    { subcategory: 'Plumbing', categoryName: 'Home Services' },
                    { subcategory: 'Electrical', categoryName: 'Home Services' },
                    { subcategory: 'Carpentry', categoryName: 'Home Services' },
                    { subcategory: 'Painting', categoryName: 'Home Services' },
                    { subcategory: 'Gardening', categoryName: 'Home Services' },
                    
                    // Transportation subcategories
                    { subcategory: 'Delivery', categoryName: 'Transportation' },
                    { subcategory: 'Moving Services', categoryName: 'Transportation' },
                    { subcategory: 'Taxi/Ride', categoryName: 'Transportation' },
                    { subcategory: 'Vehicle Repair', categoryName: 'Transportation' },
                    
                    // Professional Services subcategories
                    { subcategory: 'Tutoring', categoryName: 'Professional Services' },
                    { subcategory: 'Photography', categoryName: 'Professional Services' },
                    { subcategory: 'Design', categoryName: 'Professional Services' },
                    { subcategory: 'Writing', categoryName: 'Professional Services' },
                    { subcategory: 'Legal', categoryName: 'Professional Services' },
                    
                    // Technical Services subcategories
                    { subcategory: 'Computer Repair', categoryName: 'Technical Services' },
                    { subcategory: 'Phone Repair', categoryName: 'Technical Services' },
                    { subcategory: 'Software Development', categoryName: 'Technical Services' },
                    { subcategory: 'IT Support', categoryName: 'Technical Services' }
                ];

                // Get category IDs by fetching the created categories
                const categoriesSnapshot = await getDocs(collection(db, 'categories'));
                const categoryIdMap = {};
                categoriesSnapshot.forEach(doc => {
                    const data = doc.data();
                    categoryIdMap[data.category] = doc.id;
                });

                // Create subcategories with proper category_id references
                const subcategoryPromises = [];
                for (const subData of subcategoriesData) {
                    const categoryId = categoryIdMap[subData.categoryName];
                    if (categoryId) {
                        subcategoryPromises.push(
                            addDoc(collection(db, 'subcategories'), {
                                subcategory: subData.subcategory,
                                category_id: categoryId
                            })
                        );
                    }
                }

                const subcategoryRefs = await Promise.all(subcategoryPromises);
                console.log(`✅ Created ${subcategoryRefs.length} subcategories`);

                // Restore button
                button.innerHTML = originalText;
                button.disabled = false;

                showToast(`✅ Successfully imported ${categoryRefs.length} categories and ${subcategoryRefs.length} subcategories!`, 'success');
                
                // Reload categories to show new data
                await loadCategories();

            } catch (error) {
                console.error('❌ Error importing categories:', error);
                showToast('Error importing categories: ' + error.message, 'error');
                
                // Restore button on error
                const button = event.target;
                button.innerHTML = '<i class="fas fa-download me-2"></i>Import from Mobile App';
                button.disabled = false;
            }
        }

        function viewCategoryDetails(categoryId) {
            // For now, just edit the category (can be expanded to show a detailed view)
            editCategory(categoryId);
        }

        async function updateNotificationBadges() {
            try {
                // Pending business products
                const pendingProductsQuery = query(
                    collection(db, 'business_products'),
                    where('status', '==', 'pending')
                );
                const pendingProductsSnapshot = await getDocs(pendingProductsQuery);
                
                const businessProductsBadge = document.getElementById('businessProductsBadge');
                if (pendingProductsSnapshot.size > 0) {
                    businessProductsBadge.textContent = pendingProductsSnapshot.size;
                    businessProductsBadge.style.display = 'flex';
                } else {
                    businessProductsBadge.style.display = 'none';
                }

                // Active requests
                const activeRequestsQuery = query(
                    collection(db, 'requests'),
                    where('status', 'in', ['pending', 'active'])
                );
                const activeRequestsSnapshot = await getDocs(activeRequestsQuery);
                
                const requestsBadge = document.getElementById('requestsBadge');
                requestsBadge.textContent = activeRequestsSnapshot.size;
                if (activeRequestsSnapshot.size > 0) {
                    requestsBadge.style.display = 'flex';
                } else {
                    requestsBadge.style.display = 'none';
                }

            } catch (error) {
                console.error('Error updating notification badges:', error);
            }
        }

        async function loadRecentActivity() {
            // This would load recent activities from various collections
            // For now, showing placeholder
            const tbody = document.getElementById('recentActivityTable');
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted">
                        <i class="fas fa-clock me-2"></i>Recent activity will appear here
                    </td>
                </tr>
            `;
        }

        // Approval functions
        // Utility functions
        function showSuccess(message) {
            alert('Success: ' + message);
        }

        function showError(message) {
            alert('Error: ' + message);
        }

        // Placeholder functions for modal actions
        function showAddUserModal() { console.log('Add user modal'); }
        function showAddDriverModal() { console.log('Add driver modal'); }
        function showAddBusinessModal() { console.log('Add business modal'); }
        
        // Brands Management
        async function loadBrands() {
            try {
                const snapshot = await getDocs(collection(db, 'brands'));
                
                const tbody = document.getElementById('brandsTable');
                tbody.innerHTML = '';

                snapshot.forEach(async (doc) => {
                    const brand = doc.data();
                    
                    // Count products with this brand
                    const productsQuery = query(
                        collection(db, 'master_products'),
                        where('brand', '==', brand.name)
                    );
                    const productsSnapshot = await getDocs(productsQuery);
                    const productCount = productsSnapshot.size;

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${brand.name}</td>
                        <td>${brand.description || ''}</td>
                        <td>${brand.website ? `<a href="${brand.website}" target="_blank">${brand.website}</a>` : ''}</td>
                        <td>${productCount}</td>
                        <td><span class="status-badge ${brand.isActive ? 'status-active' : 'status-pending'}">${brand.isActive ? 'Active' : 'Inactive'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewBrand('${doc.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="editBrand('${doc.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteBrand('${doc.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading brands:', error);
                showError('Error loading brands: ' + error.message);
            }
        }

        // Subcategories Management
        async function loadSubcategories() {
            try {
                const snapshot = await getDocs(collection(db, 'subcategories'));
                const categoriesSnapshot = await getDocs(collection(db, 'categories'));
                
                // Create categories map for lookup
                const categoriesMap = {};
                categoriesSnapshot.forEach(doc => {
                    categoriesMap[doc.id] = doc.data().category;
                });
                
                const tbody = document.getElementById('subcategoriesTable');
                tbody.innerHTML = '';

                for (const doc of snapshot.docs) {
                    const subcategory = doc.data();
                    
                    // Count products with this subcategory
                    const productsQuery = query(
                        collection(db, 'master_products'),
                        where('subcategory', '==', subcategory.subcategory)
                    );
                    const productsSnapshot = await getDocs(productsQuery);
                    const productCount = productsSnapshot.size;

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${subcategory.subcategory}</td>
                        <td>${categoriesMap[subcategory.category_id] || 'Unknown'}</td>
                        <td>${subcategory.description || 'No description'}</td>
                        <td>${productCount}</td>
                        <td><span class="status-badge status-active">Active</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewSubcategory('${doc.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="editSubcategory('${doc.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSubcategory('${doc.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                }
            } catch (error) {
                console.error('Error loading subcategories:', error);
                showToast('Error loading subcategories: ' + error.message, 'error');
            }
        }

        // Product Variables Management
        async function loadProductVariables() {
            console.log('🔄 Loading all product variables...');
            await loadColors();
            await loadSizes();
            await loadMaterials();
            await loadCustomVariables();

            // Restore the last active tab
            const lastTabId = sessionStorage.getItem('lastActiveVariableTab');
            if (lastTabId) {
                const lastTab = document.querySelector(`#variableTabs button[id="${lastTabId}"]`);
                if (lastTab) {
                    console.log(`Restoring last active tab: ${lastTabId}`);
                    const tab = new bootstrap.Tab(lastTab);
                    tab.show();
                }
            }
        }

        async function loadColors() {
            try {
                const snapshot = await getDocs(collection(db, 'product_colors'));
                
                const tbody = document.getElementById('colorsTable');
                tbody.innerHTML = '';

                snapshot.forEach(doc => {
                    const color = doc.data();
                    
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${color.name}</td>
                        <td>${color.hexCode}</td>
                        <td><div style="width: 30px; height: 30px; background-color: ${color.hexCode}; border: 1px solid #ccc; border-radius: 4px;"></div></td>
                        <td>${color.usageCount || 0}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="editColor('${doc.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteColor('${doc.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading colors:', error);
            }
        }

        async function loadSizes() {
            try {
                const snapshot = await getDocs(collection(db, 'product_sizes'));
                
                const tbody = document.getElementById('sizesTable');
                tbody.innerHTML = '';

                snapshot.forEach(doc => {
                    const size = doc.data();
                    
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${size.name}</td>
                        <td>${size.category || ''}</td>
                        <td>${size.description || ''}</td>
                        <td>${size.usageCount || 0}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="editSize('${doc.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSize('${doc.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading sizes:', error);
            }
        }

        async function loadMaterials() {
            try {
                const snapshot = await getDocs(collection(db, 'product_materials'));
                
                const tbody = document.getElementById('materialsTable');
                tbody.innerHTML = '';

                snapshot.forEach(doc => {
                    const material = doc.data();
                    
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${material.name}</td>
                        <td>${material.description || ''}</td>
                        <td>${material.properties ? material.properties.join(', ') : ''}</td>
                        <td>${material.usageCount || 0}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="editMaterial('${doc.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteMaterial('${doc.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading materials:', error);
            }
        }

        // Show modal for adding/editing custom variables
        window.showAddCustomVariableModal = function(variableId = null) {
            const isEdit = variableId !== null;
            const modalTitle = isEdit ? 'Edit Custom Variable' : 'Add New Custom Variable';
            const submitButtonText = isEdit ? 'Update Variable' : 'Create Variable';
            
            const modalContent = `
                <div class="modal fade" id="customVariableModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-cogs me-2"></i>${modalTitle}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="customVariableForm">
                                    <div class="mb-3">
                                        <label for="variableName" class="form-label">Variable Name *</label>
                                        <input type="text" class="form-control" id="variableName" required
                                            placeholder="e.g., Storage Capacity, Screen Size, Color">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="variableType" class="form-label">Variable Type *</label>
                                        <select class="form-select" id="variableType" required>
                                            <option value="">Select Type</option>
                                            <option value="dropdown">Dropdown</option>
                                            <option value="text">Text Input</option>
                                            <option value="number">Number</option>
                                            <option value="checkbox">Checkbox</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="variableDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="variableDescription" rows="2"
                                            placeholder="Brief description of this variable"></textarea>
                                    </div>
                                    
                                    <div class="mb-3" id="possibleValuesSection">
                                        <label class="form-label">Possible Values</label>
                                        <div id="valuesContainer">
                                            <div class="input-group mb-2">
                                                <input type="text" class="form-control" placeholder="Enter a value">
                                                <button type="button" class="btn btn-outline-danger" onclick="removeValueInput(this)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addValueInput()">
                                            <i class="fas fa-plus me-1"></i>Add Value
                                        </button>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="isRequired">
                                            <label class="form-check-label" for="isRequired">
                                                Required field
                                            </label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="submitCustomVariable('${variableId || ''}')">
                                    <i class="fas fa-save me-1"></i>${submitButtonText}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if present
            const existingModal = document.getElementById('customVariableModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Insert new modal
            document.body.insertAdjacentHTML('beforeend', modalContent);
            
            // Set up form behavior
            setupCustomVariableForm();
            
            // Load data for editing if it's an edit operation
            if (isEdit) {
                loadCustomVariableForEdit(variableId);
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('customVariableModal'));
            modal.show();
        };

        // Setup form behavior for custom variables
        function setupCustomVariableForm() {
            const typeSelect = document.getElementById('variableType');
            const valuesSection = document.getElementById('possibleValuesSection');
            
            typeSelect.addEventListener('change', function() {
                if (this.value === 'text' || this.value === 'number') {
                    valuesSection.style.display = 'none';
                } else {
                    valuesSection.style.display = 'block';
                }
            });
        }

        // Add value input field
        window.addValueInput = function() {
            const container = document.getElementById('valuesContainer');
            const newInput = document.createElement('div');
            newInput.className = 'input-group mb-2';
            newInput.innerHTML = `
                <input type="text" class="form-control" placeholder="Enter a value">
                <button type="button" class="btn btn-outline-danger" onclick="removeValueInput(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(newInput);
        };

        // Remove value input field
        window.removeValueInput = function(button) {
            const container = document.getElementById('valuesContainer');
            if (container.children.length > 1) {
                button.closest('.input-group').remove();
            }
        };

        // Load custom variable data for editing
        async function loadCustomVariableForEdit(variableId) {
            try {
                const variableDoc = await getDoc(doc(db, 'custom_product_variables', variableId));
                
                if (variableDoc.exists()) {
                    const variable = variableDoc.data();
                    
                    document.getElementById('variableName').value = variable.name || '';
                    document.getElementById('variableType').value = variable.type || '';
                    document.getElementById('variableDescription').value = variable.description || '';
                    document.getElementById('isRequired').checked = variable.isRequired || false;
                    
                    // Load possible values
                    if (variable.possibleValues && variable.possibleValues.length > 0) {
                        const container = document.getElementById('valuesContainer');
                        container.innerHTML = '';
                        
                        variable.possibleValues.forEach(value => {
                            const inputGroup = document.createElement('div');
                            inputGroup.className = 'input-group mb-2';
                            inputGroup.innerHTML = `
                                <input type="text" class="form-control" value="${value}">
                                <button type="button" class="btn btn-outline-danger" onclick="removeValueInput(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                            container.appendChild(inputGroup);
                        });
                    }
                    
                    // Trigger type change to show/hide values section
                    document.getElementById('variableType').dispatchEvent(new Event('change'));
                }
            } catch (error) {
                console.error('Error loading custom variable for edit:', error);
                showToast('Error loading variable data: ' + error.message, 'error');
            }
        }

        // Submit custom variable (create or update)
        window.submitCustomVariable = async function(variableId) {
            const form = document.getElementById('customVariableForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const name = document.getElementById('variableName').value.trim();
            const type = document.getElementById('variableType').value;
            const description = document.getElementById('variableDescription').value.trim();
            const isRequired = document.getElementById('isRequired').checked;
            
            // Collect possible values
            const possibleValues = [];
            const valueInputs = document.querySelectorAll('#valuesContainer input');
            valueInputs.forEach(input => {
                const value = input.value.trim();
                if (value) {
                    possibleValues.push(value);
                }
            });
            
            const variableData = {
                name,
                type,
                description: description || null,
                possibleValues: type === 'dropdown' || type === 'checkbox' ? possibleValues : [],
                isRequired,
                usageCount: 0,
                updatedAt: new Date().toISOString()
            };
            
            // Add createdAt for new variables
            if (!variableId) {
                variableData.createdAt = new Date().toISOString();
            }
            
            try {
                if (variableId) {
                    // Update existing variable
                    await updateDoc(doc(db, 'custom_product_variables', variableId), variableData);
                    showToast('✅ Custom variable updated successfully!', 'success');
                } else {
                    // Create new variable
                    await addDoc(collection(db, 'custom_product_variables'), variableData);
                    showToast('✅ Custom variable created successfully!', 'success');
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('customVariableModal'));
                modal.hide();
                
                // Custom variables are now managed within product creation
                console.log('💡 Variable saved - can be used in product creation modal');
                
            } catch (error) {
                console.error('Error saving custom variable:', error);
                showToast('❌ Error saving variable: ' + error.message, 'error');
            }
        };

        // Edit custom variable function
        window.editCustomVariable = function(variableId) {
            showAddCustomVariableModal(variableId);
        };

        // Delete single custom variable
        window.deleteCustomVariable = async function(variableId) {
            const confirmDelete = confirm('Are you sure you want to delete this custom variable?');
            if (!confirmDelete) return;
            
            try {
                await deleteDoc(doc(db, 'custom_product_variables', variableId));
                showToast('✅ Custom variable deleted successfully!', 'success');
                
                // Custom variables are now managed within product creation
                console.log('💡 Variable deleted - updated list will appear in product creation modal');
                
            } catch (error) {
                console.error('Error deleting custom variable:', error);
                showToast('❌ Error deleting variable: ' + error.message, 'error');
            }
        };

        // Enhanced function to ensure custom variables are visible (Legacy - function kept for compatibility)
        window.ensureCustomVariablesVisible = async function() {
            console.log('📝 Custom variables are now managed within product creation modal');
            showToast('Custom variables are now managed within product creation', 'info');
            return;
        };

        // Fix capacity variables function (legacy - kept for compatibility)
        window.fixCapacityVariables = async function() {
            try {
                console.log('🔧 Starting capacity variables fix...');
                showToast('Fixing capacity variables...', 'info');
                
                // Step 1: Delete all existing "Capacity" variables
                console.log('🗑️ Step 1: Deleting existing Capacity variables...');
                const capacityQuery = query(
                    collection(db, 'custom_product_variables'),
                    where('name', '==', 'Capacity')
                );
                const capacitySnapshot = await getDocs(capacityQuery);
                
                console.log(`Found ${capacitySnapshot.size} capacity variables to delete`);
                
                const deletePromises = [];
                capacitySnapshot.forEach(doc => {
                    console.log(`Deleting: ${doc.id}`);
                    deletePromises.push(deleteDoc(doc(db, 'custom_product_variables', doc.id)));
                });
                
                await Promise.all(deletePromises);
                console.log(`✅ Deleted ${deletePromises.length} duplicate Capacity variables`);
                
                // Step 2: Create properly formatted capacity variables
                console.log('➕ Step 2: Creating individual capacity variables...');
                
                const capacityVariables = [
                    {
                        name: 'Capacity 128GB',
                        type: 'number',
                        possibleValues: ['128'],
                        usageCount: 0,
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'Capacity 256GB',
                        type: 'number',
                        possibleValues: ['256'],
                        usageCount: 0,
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'Capacity 512GB',
                        type: 'number',
                        possibleValues: ['512'],
                        usageCount: 0,
                        createdAt: new Date().toISOString()
                    }
                ];
                
                const createPromises = [];
                capacityVariables.forEach(variable => {
                    console.log(`Creating: ${variable.name} with value: ${variable.possibleValues[0]}`);
                    createPromises.push(addDoc(collection(db, 'custom_product_variables'), variable));
                });
                
                await Promise.all(createPromises);
                console.log(`✅ Created ${createPromises.length} individual capacity variables`);
                
                showToast('✅ Capacity variables fixed successfully!', 'success');
                
                // Custom variables are now managed within product creation
                console.log('💡 Capacity variables fixed - updates available in product creation modal');
                
            } catch (error) {
                console.error('❌ Error fixing capacity variables:', error);
                showToast('❌ Error fixing capacity variables: ' + error.message, 'error');
            }
        };

        // Delete ALL custom variables function
        window.deleteAllCustomVariables = async function() {
            const confirmDelete = confirm('⚠️ This will delete ALL custom variables permanently. Are you sure?');
            if (!confirmDelete) return;
            
            try {
                console.log('🗑️ Starting deletion of ALL custom variables...');
                showToast('Deleting all custom variables...', 'info');
                
                const snapshot = await getDocs(collection(db, 'custom_product_variables'));
                console.log(`Found ${snapshot.size} custom variables to delete`);
                
                const deletePromises = [];
                snapshot.forEach(doc => {
                    console.log(`Deleting: ${doc.id} - ${doc.data().name || 'unnamed'}`);
                    deletePromises.push(deleteDoc(doc(db, 'custom_product_variables', doc.id)));
                });
                
                await Promise.all(deletePromises);
                console.log(`✅ Deleted ${deletePromises.length} custom variables`);
                
                showToast(`✅ Successfully deleted ${deletePromises.length} custom variables!`, 'success');
                
                // Custom variables are now managed within product creation
                console.log('💡 Variables deleted - updated list available in product creation modal');
                
            } catch (error) {
                console.error('❌ Error deleting custom variables:', error);
                showToast('❌ Error deleting custom variables: ' + error.message, 'error');
            }
        };

        // Create sample custom variables function
        window.createSampleCustomVariables = async function() {
            try {
                console.log('➕ Creating sample custom variables...');
                showToast('Creating sample custom variables...', 'info');
                
                const sampleVariables = [
                    {
                        name: 'Storage Capacity',
                        type: 'dropdown',
                        possibleValues: ['128GB', '256GB', '512GB', '1TB'],
                        usageCount: 0,
                        isRequired: false,
                        description: 'Device storage capacity',
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'Screen Size',
                        type: 'dropdown',
                        possibleValues: ['5.5"', '6.1"', '6.7"', '7.2"'],
                        usageCount: 0,
                        isRequired: false,
                        description: 'Display screen size',
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'RAM',
                        type: 'dropdown',
                        possibleValues: ['4GB', '6GB', '8GB', '12GB', '16GB'],
                        usageCount: 0,
                        isRequired: false,
                        description: 'Memory capacity',
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'Color',
                        type: 'dropdown',
                        possibleValues: ['Black', 'White', 'Blue', 'Red', 'Gold'],
                        usageCount: 0,
                        isRequired: false,
                        description: 'Product color options',
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'Size',
                        type: 'dropdown',
                        possibleValues: ['Small', 'Medium', 'Large', 'XL'],
                        usageCount: 0,
                        isRequired: false,
                        description: 'Product size options',
                        createdAt: new Date().toISOString()
                    }
                ];
                
                const createPromises = [];
                sampleVariables.forEach(variable => {
                    console.log(`Creating: ${variable.name} with values: ${variable.possibleValues.join(', ')}`);
                    createPromises.push(addDoc(collection(db, 'custom_product_variables'), variable));
                });
                
                await Promise.all(createPromises);
                console.log(`✅ Created ${createPromises.length} sample custom variables`);
                
                showToast(`✅ Successfully created ${createPromises.length} sample variables!`, 'success');
                console.log('💡 Custom variables can now be found in the product creation modal');
                
            } catch (error) {
                console.error('❌ Error creating sample variables:', error);
                showToast('❌ Error creating sample variables: ' + error.message, 'error');
            }
        };

        // Debug function to check custom variables status
        window.debugCustomVariables = async function() {
            console.log('🔍 DEBUG: Checking custom variables status...');
            
            let debugResults = [];
            
            try {
                // Check if Firebase is connected
                console.log('🔥 Firebase db object:', window.db);
                debugResults.push('✅ Firebase is connected');
                
                // Check if the tab exists
                const customTab = document.getElementById('custom-tab');
                console.log('📑 Custom tab element:', customTab);
                debugResults.push(customTab ? '✅ Custom tab exists' : '❌ Custom tab missing');
                
                // Check if the table exists
                const customTable = document.getElementById('customVariablesTable');
                console.log('📊 Custom table element:', customTable);
                debugResults.push(customTable ? '✅ Custom table exists' : '❌ Custom table missing');
                
                const customTableBody = document.getElementById('customVariablesTableBody');
                console.log('📋 Custom table body element:', customTableBody);
                debugResults.push(customTableBody ? '✅ Custom table body exists' : '❌ Custom table body missing');
                
                // Check database
                const snapshot = await getDocs(collection(db, 'custom_product_variables'));
                console.log(`💾 Database has ${snapshot.size} custom variables`);
                debugResults.push(`💾 Database contains: ${snapshot.size} custom variables`);
                
                if (!snapshot.empty) {
                    debugResults.push('\n📝 Variables found in database:');
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        console.log(`📝 Variable: ${doc.id} -`, data);
                        debugResults.push(`  • ${data.name} (${data.type}) - ${data.values ? data.values.length : 0} values`);
                        if (data.values && data.values.length > 0) {
                            debugResults.push(`    Values: ${data.values.join(', ')}`);
                        }
                    });
                } else {
                    debugResults.push('📭 No variables found in database');
                }
                
                // Try to load variables
                console.log('🔄 Attempting to load custom variables...');
                debugResults.push('\n🔄 Attempting to reload variables...');
                await loadCustomVariables();
                debugResults.push('✅ loadCustomVariables() completed');
                
                // Show results in alert and console
                const resultText = debugResults.join('\n');
                alert('🔍 Debug Results:\n\n' + resultText);
                console.log('🔍 Complete Debug Results:\n' + resultText);
                
            } catch (error) {
                console.error('❌ Debug error:', error);
                debugResults.push('❌ Error: ' + error.message);
                alert('❌ Debug Error:\n\n' + debugResults.join('\n') + '\n\nError: ' + error.message);
            }
        };

        async function loadCustomVariables() {
            try {
                console.log('🔄 Loading custom variables...');
                const snapshot = await getDocs(collection(db, 'custom_product_variables'));
                console.log(`📊 Database query returned ${snapshot.size} custom variables`);
                
                const tbody = document.getElementById('customVariablesTableBody');
                if (!tbody) {
                    console.log('⚠️ Custom variables table not found - tab may not be active');
                    console.log('Available elements:', document.querySelectorAll('#custom *').length);
                    return;
                }
                
                tbody.innerHTML = '';
                
                if (snapshot.empty) {
                    console.log('📭 No custom variables found in database');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                <div class="py-4">
                                    <i class="fas fa-inbox fa-3x mb-3 text-muted"></i>
                                    <p class="mb-0">No custom variables found</p>
                                    <small>Click "Create Sample Variables" to get started</small>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                console.log(`📊 Found ${snapshot.size} custom variables`);
                
                snapshot.forEach(doc => {
                    const variable = doc.data();
                    const variableId = doc.id;
                    
                    console.log(`📝 Loading variable: ${variable.name} (${variable.type})`);
                    
                    const possibleValues = Array.isArray(variable.possibleValues) 
                        ? variable.possibleValues.join(', ') 
                        : (variable.possibleValues || 'N/A');
                    
                    const usageCount = variable.usageCount || 0;
                    const isRequired = variable.isRequired ? 'Yes' : 'No';
                    
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>
                            <strong>${variable.name || 'Unnamed'}</strong>
                            ${variable.description ? `<br><small class="text-muted">${variable.description}</small>` : ''}
                        </td>
                        <td>
                            <span class="badge bg-primary">${variable.type || 'text'}</span>
                        </td>
                        <td>
                            <div class="values-list" style="max-width: 200px;">
                                ${possibleValues.length > 50 
                                    ? possibleValues.substring(0, 50) + '...' 
                                    : possibleValues}
                            </div>
                        </td>
                        <td>
                            <span class="badge ${variable.isRequired ? 'bg-warning' : 'bg-secondary'}">${isRequired}</span>
                        </td>
                        <td>
                            <span class="badge bg-info">${usageCount}</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editCustomVariable('${variableId}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteCustomVariable('${variableId}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                });
                
                console.log('✅ Custom variables loaded successfully');
                
            } catch (error) {
                console.error('❌ Error loading custom variables:', error);
                showToast('Error loading custom variables: ' + error.message, 'error');
                
                const tbody = document.getElementById('customVariablesTableBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Error loading custom variables: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }
        
        function showAddMasterProductModal() { 
            showMasterProductModal();
        }
        
        function showAddCategoryModal() {
            showCategoryModal();
        }
        
        function showCategoryModal(categoryId = null, isEdit = false) {
            // If isEdit is true but no categoryId, treat as edit mode
            if (isEdit && categoryId) {
                const modalTitle = 'Edit Category';
                const submitButtonText = 'Update Category';
                
                const modalContent = `
                    <div class="modal fade" id="categoryModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-tag me-2"></i>${modalTitle}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="categoryForm">
                                        <div class="mb-3">
                                            <label for="categoryName" class="form-label">Category Name *</label>
                                            <input type="text" class="form-control" id="categoryName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="categoryType" class="form-label">Category Type *</label>
                                            <select class="form-control" id="categoryType" required>
                                                <option value="item">Item (for products and item requests)</option>
                                                <option value="service">Service (for service requests)</option>
                                            </select>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="categoryActive" checked>
                                            <label class="form-check-label" for="categoryActive">
                                                Active
                                            </label>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" onclick="submitCategory('${categoryId}')">>
                                        <i class="fas fa-save me-2"></i>${submitButtonText}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if present
                const existingModal = document.getElementById('categoryModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Insert new modal
                document.body.insertAdjacentHTML('beforeend', modalContent);
                
                // Load category data for editing
                setTimeout(() => {
                    loadCategoryForEdit(categoryId);
                }, 100);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
                modal.show();
            } else {
                // Add mode
                const modalTitle = 'Add New Category';
                const submitButtonText = 'Create Category';
                
                const modalContent = `
                    <div class="modal fade" id="categoryModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-tag me-2"></i>${modalTitle}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="categoryForm">
                                        <div class="mb-3">
                                            <label for="categoryName" class="form-label">Category Name *</label>
                                            <input type="text" class="form-control" id="categoryName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="categoryType" class="form-label">Category Type *</label>
                                            <select class="form-control" id="categoryType" required>
                                                <option value="item">Item (for products and item requests)</option>
                                                <option value="service">Service (for service requests)</option>
                                            </select>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="categoryActive" checked>
                                            <label class="form-check-label" for="categoryActive">
                                                Active
                                            </label>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" onclick="submitCategory('')">>
                                        <i class="fas fa-save me-2"></i>${submitButtonText}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if present
                const existingModal = document.getElementById('categoryModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Insert new modal
                document.body.insertAdjacentHTML('beforeend', modalContent);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
                modal.show();
            }
        }
        
        async function loadCategoryForEdit(categoryId) {
            try {
                console.log('Loading category for edit:', categoryId);
                
                const categoryDoc = await getDoc(doc(db, 'categories', categoryId));
                
                if (categoryDoc.exists()) {
                    const category = categoryDoc.data();
                    console.log('Category data loaded:', category);
                    
                    // Wait for elements to be available
                    const nameField = document.getElementById('categoryName');
                    const typeField = document.getElementById('categoryType');
                    const activeField = document.getElementById('categoryActive');
                    
                    if (nameField && typeField && activeField) {
                        nameField.value = category.category || '';
                        typeField.value = category.type || 'item';
                        activeField.checked = category.isActive !== false;
                        
                        console.log('Form fields populated successfully');
                        showToast('Category data loaded for editing', 'success');
                    } else {
                        console.error('Form fields not found');
                        showToast('Error: Form fields not available', 'error');
                    }
                } else {
                    console.error('Category document not found for ID:', categoryId);
                    showToast('Category not found.', 'error');
                }
            } catch (error) {
                console.error('Error loading category for edit:', error);
                showToast('Error loading category data: ' + error.message, 'error');
            }
        }
        
        async function submitCategory(categoryId) {
            const form = document.getElementById('categoryForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const categoryData = {
                category: document.getElementById('categoryName').value.trim(),
                type: document.getElementById('categoryType').value,
                isActive: document.getElementById('categoryActive').checked,
                updatedAt: new Date().toISOString()
            };
            
            try {
                if (categoryId) {
                    // Update existing category
                    await updateDoc(doc(db, 'categories', categoryId), categoryData);
                    showToast('Category updated successfully!', 'success');
                } else {
                    // Create new category
                    categoryData.createdAt = new Date().toISOString();
                    await addDoc(collection(db, 'categories'), categoryData);
                    showToast('Category created successfully!', 'success');
                }
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
                
                // Refresh categories
                loadCategories();
                
            } catch (error) {
                console.error('Error saving category:', error);
                showToast('Error saving category: ' + error.message, 'error');
            }
        }

        // Placeholder functions for view/edit actions
        async function viewUser(id) {
            try {
                const userDoc = await getDoc(doc(db, 'users', id));
                if (!userDoc.exists()) {
                    showError('User not found');
                    return;
                }
                
                const userData = userDoc.data();
                const userId = userDoc.id;
                
                // Get additional user stats
                const userRequestsSnapshot = await getDocs(
                    query(collection(db, 'requests'), where('userId', '==', id))
                );
                const userBusinessSnapshot = await getDocs(
                    query(collection(db, 'businesses'), where('userId', '==', id))
                );
                const userDriverSnapshot = await getDocs(
                    query(collection(db, 'drivers'), where('userId', '==', id))
                );
                
                const modalContent = `
                    <div class="modal fade" id="userDetailsModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-user me-2"></i>User Details: ${userData.displayName || 'Unknown User'}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="text-center mb-3">
                                                <img src="${userData.photoURL || '/api/placeholder/120/120'}" 
                                                     alt="Profile" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover;">
                                                <h5 class="mt-2">${userData.displayName || 'No name provided'}</h5>
                                                <span class="badge ${userData.emailVerified ? 'bg-success' : 'bg-warning'}">
                                                    ${userData.emailVerified ? 'Verified' : 'Unverified'}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6><i class="fas fa-envelope me-2"></i>Contact Information</h6>
                                                    <p><strong>Email:</strong> ${userData.email || 'Not provided'}</p>
                                                    <p><strong>Phone:</strong> ${userData.phoneNumber || 'Not provided'}</p>
                                                    <p><strong>Location:</strong> ${userData.location?.address || 'Not provided'}</p>
                                                    <p><strong>Join Date:</strong> ${userData.createdAt ? new Date(userData.createdAt.toDate()).toLocaleDateString() : 'Unknown'}</p>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6><i class="fas fa-chart-bar me-2"></i>Activity Stats</h6>
                                                    <p><strong>Total Requests:</strong> ${userRequestsSnapshot.size}</p>
                                                    <p><strong>Business Account:</strong> ${userBusinessSnapshot.size > 0 ? 'Yes' : 'No'}</p>
                                                    <p><strong>Driver Account:</strong> ${userDriverSnapshot.size > 0 ? 'Yes' : 'No'}</p>
                                                    <p><strong>Last Active:</strong> ${userData.lastLoginAt ? new Date(userData.lastLoginAt.toDate()).toLocaleDateString() : 'Unknown'}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <hr>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6><i class="fas fa-cog me-2"></i>Account Settings</h6>
                                            <p><strong>User ID:</strong> <code>${userId}</code></p>
                                            <p><strong>Email Verified:</strong> 
                                                <span class="badge ${userData.emailVerified ? 'bg-success' : 'bg-danger'}">
                                                    ${userData.emailVerified ? 'Yes' : 'No'}
                                                </span>
                                            </p>
                                            <p><strong>Phone Verified:</strong> 
                                                <span class="badge ${userData.phoneVerified ? 'bg-success' : 'bg-danger'}">
                                                    ${userData.phoneVerified ? 'Yes' : 'No'}
                                                </span>
                                            </p>
                                            <p><strong>Account Status:</strong> 
                                                <span class="badge ${userData.disabled ? 'bg-danger' : 'bg-success'}">
                                                    ${userData.disabled ? 'Disabled' : 'Active'}
                                                </span>
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6><i class="fas fa-list me-2"></i>User Roles</h6>
                                            <div class="mb-2">
                                                ${(userData.roles || ['consumer']).map(role => 
                                                    `<span class="badge bg-primary me-1">${role}</span>`
                                                ).join('')}
                                            </div>
                                            <p><strong>Preferences:</strong></p>
                                            <small class="text-muted">
                                                Notifications: ${userData.notificationPreferences?.enabled ? 'Enabled' : 'Disabled'}<br>
                                                Language: ${userData.language || 'English'}<br>
                                                Theme: ${userData.theme || 'Light'}
                                            </small>
                                        </div>
                                    </div>
                                    
                                    ${userRequestsSnapshot.size > 0 ? `
                                        <hr>
                                        <h6><i class="fas fa-history me-2"></i>Recent Requests (Last 5)</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Type</th>
                                                        <th>Status</th>
                                                        <th>Date</th>
                                                        <th>Budget</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${userRequestsSnapshot.docs.slice(0, 5).map(req => {
                                                        const reqData = req.data();
                                                        return `
                                                            <tr>
                                                                <td>${reqData.type || 'Unknown'}</td>
                                                                <td><span class="badge bg-info">${reqData.status || 'pending'}</span></td>
                                                                <td>${reqData.createdAt ? new Date(reqData.createdAt.toDate()).toLocaleDateString() : 'Unknown'}</td>
                                                                <td>LKR ${reqData.budget || 'N/A'}</td>
                                                            </tr>
                                                        `;
                                                    }).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-warning" onclick="editUser('${userId}')">
                                        <i class="fas fa-edit me-2"></i>Edit User
                                    </button>
                                    <button type="button" class="btn ${userData.disabled ? 'btn-success' : 'btn-danger'}" 
                                            onclick="toggleUserStatus('${userId}', ${!userData.disabled})">
                                        <i class="fas fa-${userData.disabled ? 'check' : 'ban'} me-2"></i>
                                        ${userData.disabled ? 'Enable' : 'Disable'} User
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if present
                const existingModal = document.getElementById('userDetailsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Insert new modal
                document.getElementById('userModalContainer').innerHTML = modalContent;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error viewing user:', error);
                showError('Error loading user details: ' + error.message);
            }
        }
        function editUser(id) { console.log('Edit user:', id); }
        
        let currentDriverId = null;

        // Helper function to get document status badge
        function getDocumentStatusBadge(doc, hasImage = false) {
            if (!doc || !doc.status) {
                // If there's an image but no document verification status, show as pending
                if (hasImage) {
                    return '<span class="badge bg-warning"><i class="fas fa-clock"></i> Pending Review</span>';
                }
                return '<span class="badge bg-secondary">Not Submitted</span>';
            }
            
            switch(doc.status) {
                case 'approved':
                    return '<span class="badge bg-success"><i class="fas fa-check"></i> Approved</span>';
                case 'rejected':
                    return '<span class="badge bg-danger"><i class="fas fa-times"></i> Rejected</span>';
                case 'pending':
                    return '<span class="badge bg-warning"><i class="fas fa-clock"></i> Pending Review</span>';
                case 'resubmitted':
                    return '<span class="badge bg-info"><i class="fas fa-sync"></i> Resubmitted - Pending Review</span>';
                default:
                    return '<span class="badge bg-secondary">Unknown</span>';
            }
        }

        // Helper function to get the best available image URL
        function getBestImageUrl(driver, imageType) {
            console.log(`🔍 Getting ${imageType} image for driver:`, driver.name);
            
            let candidates = [];
            
            switch(imageType) {
                case 'profile':
                    candidates = [
                        driver.photoUrl,
                        driver.profileImageUrl, 
                        driver.avatarUrl,
                        driver.documentVerification?.driverPhoto?.url,
                        driver.documentVerification?.driverPhoto?.downloadURL,
                        driver.documentVerification?.driverPhoto?.imageUrl
                    ];
                    break;
                    
                case 'license':
                    candidates = [
                        driver.documentVerification?.license?.url,
                        driver.documentVerification?.license?.downloadURL,
                        driver.documentVerification?.license?.imageUrl,
                        driver.documentImageUrls?.find(url => url && url.toLowerCase().includes('license')),
                        driver.documentImageUrls?.[0]
                    ];
                    break;
                    
                case 'insurance':
                    candidates = [
                        driver.documentVerification?.insurance?.url,
                        driver.documentVerification?.insurance?.downloadURL,
                        driver.documentVerification?.insurance?.imageUrl,
                        driver.documentImageUrls?.find(url => url && url.toLowerCase().includes('insurance')),
                        driver.documentImageUrls?.[1]
                    ];
                    break;
                    
                case 'vehicle':
                    candidates = [
                        driver.documentVerification?.vehicleRegistration?.url,
                        driver.documentVerification?.vehicleRegistration?.downloadURL,
                        driver.documentVerification?.vehicleRegistration?.imageUrl,
                        driver.documentImageUrls?.find(url => url && url.toLowerCase().includes('vehicle')),
                        driver.documentImageUrls?.[2]
                    ];
                    break;
                    
                default:
                    candidates = [];
            }
            
            // Filter out null, undefined, empty strings
            const validCandidates = candidates.filter(url => url && url.trim() && url !== 'null' && url !== 'undefined');
            console.log(`  ${imageType} image candidates:`, validCandidates);
            
            if (validCandidates.length > 0) {
                const selectedUrl = validCandidates[0];
                console.log(`  ✅ Selected ${imageType} image URL:`, selectedUrl);
                return selectedUrl;
            } else {
                console.log(`  ❌ No valid ${imageType} image URL found`);
                return null;
            }
        }

        // Enhanced image element generator
        function createImageElement(imageUrl, altText, imageType) {
            if (!imageUrl) {
                return `
                    <div class="alert alert-warning small p-2 mb-2">
                        <i class="fas fa-exclamation-triangle"></i> No ${imageType} submitted
                    </div>`;
            }
            
            return `
                <div class="position-relative">
                    <img 
                        id="${imageType}Image" 
                        src="${imageUrl}" 
                        alt="${altText}" 
                        class="img-fluid mb-2" 
                        style="max-height: 150px; cursor: pointer;" 
                        onclick="window.open('${imageUrl}', '_blank')" 
                        onload="console.log('✅ ${imageType} image loaded successfully:', '${imageUrl}'); this.style.border='2px solid green';"
                        onerror="console.error('❌ ${imageType} image failed to load:', '${imageUrl}'); this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0zNSA0MEw2NSA0MEw2NSA2MEwzNSA2MFoiIGZpbGw9IiNEMUQ1REIiLz4KPHRleHQgeD0iNTAiIHk9IjU1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM2QjczODAiPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K'; this.title='Image failed to load: ${imageUrl}'; this.style.border='2px solid red';">
                    <div class="small text-muted mt-1">
                        📷 ${altText}
                        <br><small style="font-size: 10px; color: #666;">URL: ${imageUrl.substring(0, 50)}...</small>
                    </div>
                </div>`;
        }
        
        function viewDriver(driverId) {
            currentDriverId = driverId;
            console.log('📄 Loading comprehensive driver details for:', driverId);
            
            // Find driver in the loaded drivers array
            const driver = drivers.find(d => d.id === driverId);
            
            if (!driver) {
                alert('Driver not found');
                return;
            }

            const driverData = driver;
            console.log('📄 Driver details:', driverData);
            
            const isApproved = driver.status === 'approved' || driver.isVerified === true;
            
            // Create a comprehensive modal for driver information
            let modalContent = `
                <div class="modal fade" id="driverDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-user-circle me-2"></i>Driver Details - ${driverData.name || 'Unknown'}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-user me-2"></i>Personal Information</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>Name:</strong></td><td>${driverData.name || 'N/A'}</td></tr>
                                            <tr><td><strong>Email:</strong></td><td>${driverData.email || 'N/A'}</td></tr>
                                            <tr><td><strong>Phone:</strong></td><td>${driverData.phone || 'N/A'}</td></tr>
                                            <tr><td><strong>User ID:</strong></td><td><code>${driverData.userId || driverId}</code></td></tr>
                                            <tr><td><strong>License Number:</strong></td><td>${driverData.licenseNumber || 'N/A'}</td></tr>
                                            <tr><td><strong>License Expiry:</strong></td><td>${driverData.licenseExpiry ? new Date(driverData.licenseExpiry.toDate()).toLocaleDateString() : 'N/A'}</td></tr>
                                            <tr><td><strong>Insurance Number:</strong></td><td>${driverData.insuranceNumber || 'N/A'}</td></tr>
                                            <tr><td><strong>Insurance Expiry:</strong></td><td>${driverData.insuranceExpiry ? new Date(driverData.insuranceExpiry.toDate()).toLocaleDateString() : 'N/A'}</td></tr>
                                            <tr><td><strong>Status:</strong></td><td><span class="badge bg-${driverData.status === 'approved' ? 'success' : driverData.status === 'pending' ? 'warning' : 'danger'}">${driverData.status || 'pending'}</span></td></tr>
                                            <tr><td><strong>Verified:</strong></td><td><span class="badge bg-${driverData.isVerified ? 'success' : 'warning'}">${driverData.isVerified ? 'Yes' : 'No'}</span></td></tr>
                                            <tr><td><strong>Active:</strong></td><td><span class="badge bg-${driverData.isActive ? 'success' : 'secondary'}">${driverData.isActive ? 'Yes' : 'No'}</span></td></tr>
                                            <tr><td><strong>Available:</strong></td><td><span class="badge bg-${driverData.availability ? 'success' : 'secondary'}">${driverData.availability ? 'Yes' : 'No'}</span></td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-car me-2"></i>Vehicle Information</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>Vehicle Type:</strong></td><td>${driverData.vehicleType || 'N/A'}</td></tr>
                                            <tr><td><strong>Vehicle Model:</strong></td><td>${driverData.vehicleModel || 'N/A'}</td></tr>
                                            <tr><td><strong>Vehicle Number:</strong></td><td>${driverData.vehicleNumber || 'N/A'}</td></tr>
                                            <tr><td><strong>Vehicle Color:</strong></td><td>${driverData.vehicleColor || 'N/A'}</td></tr>
                                            <tr><td><strong>Vehicle Year:</strong></td><td>${driverData.vehicleYear || 'N/A'}</td></tr>
                                            <tr><td><strong>License Plate:</strong></td><td>${driverData.licensePlate || 'N/A'}</td></tr>
                                            <tr><td><strong>Subscription Plan:</strong></td><td><span class="badge bg-info">${driverData.subscriptionPlan || 'free'}</span></td></tr>
                                            <tr><td><strong>Rating:</strong></td><td>⭐ ${(driverData.rating || 0).toFixed(1)}</td></tr>
                                            <tr><td><strong>Total Rides:</strong></td><td>${driverData.totalRides || driverData.totalTrips || 0}</td></tr>
                                            <tr><td><strong>Total Earnings:</strong></td><td>$${driverData.totalEarnings || 0}</td></tr>
                                        </table>
                                    </div>
                                </div>
                                
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <h6><i class="fas fa-shield-alt me-2"></i>Document Verification</h6>
                                        
                                        <!-- Document List View -->
                                        <div class="list-group">
                                            <!-- Driver Photo -->
                                            <div class="list-group-item">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-user-circle fa-2x text-primary me-3"></i>
                                                        <div>
                                                            <h6 class="mb-1">Driver Photo</h6>
                                                            <small class="text-muted">Profile photo verification</small>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex align-items-center gap-2">
                                                        ${(() => {
                                                            const imageUrl = getBestImageUrl(driverData, 'profile');
                                                            const doc = driverData.documentVerification?.driverPhoto;
                                                            
                                                            if (imageUrl) {
                                                                return `
                                                                    <button class="btn btn-outline-primary btn-sm" onclick="window.open('${imageUrl}', '_blank')">
                                                                        <i class="fas fa-eye me-1"></i>View Image
                                                                    </button>
                                                                    ${getDocumentStatusBadge(doc, !!imageUrl)}
                                                                    ${(!doc || (doc.status !== 'approved' && doc.status !== 'rejected') || doc.status === 'resubmitted') ? `
                                                                        <button class="btn btn-success btn-sm me-1" onclick="event.stopPropagation(); approveDocument('${driverId}', 'driverPhoto', 'drivers'); return false;">
                                                                            <i class="fas fa-check me-1"></i>Approve
                                                                        </button>
                                                                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); rejectDocument('${driverId}', 'driverPhoto', 'drivers'); return false;">
                                                                            <i class="fas fa-times me-1"></i>Reject
                                                                        </button>
                                                                    ` : ''}
                                                                `;
                                                            } else {
                                                                return '<span class="badge bg-warning">No image uploaded</span>';
                                                            }
                                                        })()}
                                                    </div>
                                                </div>
                                                ${(() => {
                                                    const doc = driverData.documentVerification?.driverPhoto;
                                                    if (doc && (doc.status === 'approved' || doc.status === 'rejected')) {
                                                        const isApproved = doc.status === 'approved';
                                                        return `
                                                            <div class="text-muted small mt-2">
                                                                ${isApproved ? `Approved by ${doc.approvedBy || 'Admin'}` : `Rejected by ${doc.rejectedBy || 'Admin'}`}
                                                                ${isApproved && doc.approvedAt ? ` on ${new Date(doc.approvedAt.seconds * 1000 || doc.approvedAt).toLocaleDateString()}` : ''}
                                                                ${!isApproved && doc.rejectedAt ? ` on ${new Date(doc.rejectedAt.seconds * 1000 || doc.rejectedAt).toLocaleDateString()}` : ''}
                                                                ${!isApproved && doc.reason ? `<br><em>Reason: "${doc.reason}"</em>` : ''}
                                                                ${isApproved && doc.note ? `<br><em>Note: "${doc.note}"</em>` : ''}
                                                            </div>
                                                        `;
                                                    }
                                                    return '';
                                                })()}
                                            </div>
                                            
                                            <!-- License Document -->
                                            <div class="list-group-item">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-id-card fa-2x text-info me-3"></i>
                                                        <div>
                                                            <h6 class="mb-1">License Document</h6>
                                                            <small class="text-muted">Driving license verification</small>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex align-items-center gap-2">
                                                        ${(() => {
                                                            const imageUrl = getBestImageUrl(driverData, 'license');
                                                            const doc = driverData.documentVerification?.license;
                                                            
                                                            if (imageUrl) {
                                                                return `
                                                                    <button class="btn btn-outline-primary btn-sm" onclick="window.open('${imageUrl}', '_blank')">
                                                                        <i class="fas fa-eye me-1"></i>View Image
                                                                    </button>
                                                                    ${getDocumentStatusBadge(doc, !!imageUrl)}
                                                                    ${(!doc || doc.status !== 'approved' || (doc.status === 'rejected' && imageUrl)) ? `
                                                                        <button class="btn btn-success btn-sm me-1" onclick="event.stopPropagation(); approveDocument('${driverId}', 'license', 'drivers'); return false;">
                                                                            <i class="fas fa-check me-1"></i>Approve
                                                                        </button>
                                                                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); rejectDocument('${driverId}', 'license', 'drivers'); return false;">
                                                                            <i class="fas fa-times me-1"></i>Reject
                                                                        </button>
                                                                    ` : ''}
                                                                `;
                                                            } else {
                                                                return '<span class="badge bg-warning">No document uploaded</span>';
                                                            }
                                                        })()}
                                                    </div>
                                                </div>
                                                ${(() => {
                                                    const doc = driverData.documentVerification?.license;
                                                    if (doc && (doc.status === 'approved' || doc.status === 'rejected')) {
                                                        const isApproved = doc.status === 'approved';
                                                        return `
                                                            <div class="text-muted small mt-2">
                                                                ${isApproved ? `Approved by ${doc.approvedBy || 'Admin'}` : `Rejected by ${doc.rejectedBy || 'Admin'}`}
                                                                ${isApproved && doc.approvedAt ? ` on ${new Date(doc.approvedAt.seconds * 1000 || doc.approvedAt).toLocaleDateString()}` : ''}
                                                                ${!isApproved && doc.rejectedAt ? ` on ${new Date(doc.rejectedAt.seconds * 1000 || doc.rejectedAt).toLocaleDateString()}` : ''}
                                                                ${!isApproved && doc.reason ? `<br><em>Reason: "${doc.reason}"</em>` : ''}
                                                                ${isApproved && doc.note ? `<br><em>Note: "${doc.note}"</em>` : ''}
                                                            </div>
                                                        `;
                                                    }
                                                    return '';
                                                })()}
                                            </div>
                                            
                                            <!-- Insurance Document -->
                                            <div class="list-group-item">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-shield-alt fa-2x text-success me-3"></i>
                                                        <div>
                                                            <h6 class="mb-1">Insurance Document</h6>
                                                            <small class="text-muted">Vehicle insurance verification</small>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex align-items-center gap-2">
                                                        ${(() => {
                                                            const imageUrl = getBestImageUrl(driverData, 'insurance');
                                                            const doc = driverData.documentVerification?.insurance;
                                                            
                                                            if (imageUrl) {
                                                                return `
                                                                    <button class="btn btn-outline-primary btn-sm" onclick="window.open('${imageUrl}', '_blank')">
                                                                        <i class="fas fa-eye me-1"></i>View Image
                                                                    </button>
                                                                    ${getDocumentStatusBadge(doc, !!imageUrl)}
                                                                    ${(!doc || doc.status !== 'approved' || (doc.status === 'rejected' && imageUrl)) ? `
                                                                        <button class="btn btn-success btn-sm me-1" onclick="event.stopPropagation(); approveDocument('${driverId}', 'insurance', 'drivers'); return false;">
                                                                            <i class="fas fa-check me-1"></i>Approve
                                                                        </button>
                                                                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); rejectDocument('${driverId}', 'insurance', 'drivers'); return false;">
                                                                            <i class="fas fa-times me-1"></i>Reject
                                                                        </button>
                                                                    ` : ''}
                                                                `;
                                                            } else {
                                                                return '<span class="badge bg-warning">No document uploaded</span>';
                                                            }
                                                        })()}
                                                    </div>
                                                </div>
                                                ${(() => {
                                                    const doc = driverData.documentVerification?.insurance;
                                                    if (doc && (doc.status === 'approved' || doc.status === 'rejected')) {
                                                        const isApproved = doc.status === 'approved';
                                                        return `
                                                            <div class="text-muted small mt-2">
                                                                ${isApproved ? `Approved by ${doc.approvedBy || 'Admin'}` : `Rejected by ${doc.rejectedBy || 'Admin'}`}
                                                                ${isApproved && doc.approvedAt ? ` on ${new Date(doc.approvedAt.seconds * 1000 || doc.approvedAt).toLocaleDateString()}` : ''}
                                                                ${!isApproved && doc.rejectedAt ? ` on ${new Date(doc.rejectedAt.seconds * 1000 || doc.rejectedAt).toLocaleDateString()}` : ''}
                                                                ${!isApproved && doc.reason ? `<br><em>Reason: "${doc.reason}"</em>` : ''}
                                                                ${isApproved && doc.note ? `<br><em>Note: "${doc.note}"</em>` : ''}
                                                            </div>
                                                        `;
                                                    }
                                                    return '';
                                                })()}
                                            </div>
                                            
                                            <!-- Vehicle Registration -->
                                            <div class="list-group-item">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-car fa-2x text-warning me-3"></i>
                                                        <div>
                                                            <h6 class="mb-1">Vehicle Registration</h6>
                                                            <small class="text-muted">Vehicle registration verification</small>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex align-items-center gap-2">
                                                        ${(() => {
                                                            const imageUrl = getBestImageUrl(driverData, 'vehicle');
                                                            const doc = driverData.documentVerification?.vehicleRegistration;
                                                            
                                                            if (imageUrl) {
                                                                return `
                                                                    <button class="btn btn-outline-primary btn-sm" onclick="window.open('${imageUrl}', '_blank')">
                                                                        <i class="fas fa-eye me-1"></i>View Image
                                                                    </button>
                                                                    ${getDocumentStatusBadge(doc, !!imageUrl)}
                                                                    ${(!doc || doc.status !== 'approved' || (doc.status === 'rejected' && imageUrl)) ? `
                                                                        <button class="btn btn-success btn-sm me-1" onclick="event.stopPropagation(); approveDocument('${driverId}', 'vehicleRegistration', 'drivers'); return false;">
                                                                            <i class="fas fa-check me-1"></i>Approve
                                                                        </button>
                                                                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); rejectDocument('${driverId}', 'vehicleRegistration', 'drivers'); return false;">
                                                                            <i class="fas fa-times me-1"></i>Reject
                                                                        </button>
                                                                    ` : ''}
                                                                `;
                                                            } else {
                                                                return '<span class="badge bg-warning">No document uploaded</span>';
                                                            }
                                                        })()}
                                                    </div>
                                                </div>
                                                ${(() => {
                                                    const doc = driverData.documentVerification?.vehicleRegistration;
                                                    if (doc && (doc.status === 'approved' || doc.status === 'rejected')) {
                                                        const isApproved = doc.status === 'approved';
                                                        return `
                                                            <div class="text-muted small mt-2">
                                                                ${isApproved ? `Approved by ${doc.approvedBy || 'Admin'}` : `Rejected by ${doc.rejectedBy || 'Admin'}`}
                                                                ${isApproved && doc.approvedAt ? ` on ${new Date(doc.approvedAt.seconds * 1000 || doc.approvedAt).toLocaleDateString()}` : ''}
                                                                ${!isApproved && doc.rejectedAt ? ` on ${new Date(doc.rejectedAt.seconds * 1000 || doc.rejectedAt).toLocaleDateString()}` : ''}
                                                                ${!isApproved && doc.reason ? `<br><em>Reason: "${doc.reason}"</em>` : ''}
                                                                ${isApproved && doc.note ? `<br><em>Note: "${doc.note}"</em>` : ''}
                                                            </div>
                                                        `;
                                                    }
                                                    return '';
                                                })()}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                ${driverData.vehicleImageUrls && driverData.vehicleImageUrls.length > 0 ? `
                                <div class="row mt-3">
                                    <div class="col-12">
                                        ${(() => {
                                            const approvedCount = driverData.vehicleImageApprovals ? driverData.vehicleImageApprovals.filter(approval => approval && approval.status === 'approved').length : 0;
                                            const rejectedCount = driverData.vehicleImageApprovals ? driverData.vehicleImageApprovals.filter(approval => approval && approval.status === 'rejected').length : 0;
                                            const pendingCount = driverData.vehicleImageUrls.length - approvedCount - rejectedCount;
                                            
                                            return `
                                        <h6><i class="fas fa-camera me-2"></i>Vehicle Images 
                                            <span class="badge ${driverData.vehicleImageUrls.length >= 4 ? 'bg-success' : 'bg-warning'}">
                                                ${driverData.vehicleImageUrls.length}/4 Required
                                            </span>
                                            <span class="badge bg-success ms-1">${approvedCount} Approved</span>
                                            ${rejectedCount > 0 ? `<span class="badge bg-danger ms-1">${rejectedCount} Rejected</span>` : ''}
                                            ${pendingCount > 0 ? `<span class="badge bg-warning ms-1">${pendingCount} Pending</span>` : ''}
                                        </h6>
                                        ${driverData.vehicleImageUrls.length < 4 ? `
                                            <div class="alert alert-warning">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                <strong>Minimum 4 vehicle images required for approval.</strong> 
                                                Currently ${4 - driverData.vehicleImageUrls.length} more image(s) needed.
                                            </div>
                                        ` : approvedCount >= 4 ? `
                                            <div class="alert alert-success">
                                                <i class="fas fa-check-circle me-2"></i>
                                                <strong>Vehicle image requirement met!</strong> 
                                                ${approvedCount} out of ${driverData.vehicleImageUrls.length} images approved.
                                            </div>
                                        ` : `
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>Review vehicle images:</strong> 
                                                ${approvedCount} approved, ${pendingCount} pending review, ${rejectedCount} rejected.
                                            </div>
                                        `}`;
                                        })()}
                                        <div class="list-group">
                                            ${driverData.vehicleImageUrls.map((imageUrl, index) => {
                                                const approval = driverData.vehicleImageApprovals && driverData.vehicleImageApprovals[index];
                                                const isApproved = approval && approval.status === 'approved';
                                                const isRejected = approval && approval.status === 'rejected';
                                                
                                                return `
                                                    <div class="list-group-item">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div class="d-flex align-items-center">
                                                                <i class="fas fa-car fa-2x text-info me-3"></i>
                                                                <div>
                                                                    <h6 class="mb-1">Vehicle Image ${index + 1}</h6>
                                                                    <small class="text-muted">Vehicle photo ${index + 1} of ${driverData.vehicleImageUrls.length}</small>
                                                                </div>
                                                            </div>
                                                            <div class="d-flex align-items-center gap-2">
                                                                <button class="btn btn-outline-primary btn-sm" onclick="window.open('${imageUrl}', '_blank')">
                                                                    <i class="fas fa-eye me-1"></i>View Image
                                                                </button>
                                                                ${isApproved ? '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Approved</span>' : 
                                                                  isRejected ? '<span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>Rejected</span>' : 
                                                                  '<span class="badge bg-warning"><i class="fas fa-clock me-1"></i>Pending</span>'}
                                                                ${!isApproved && !isRejected ? `
                                                                    <button class="btn btn-success btn-sm me-1" onclick="event.stopPropagation(); approveVehicleImage('${driverId}', ${index}); return false;">
                                                                        <i class="fas fa-check me-1"></i>Approve
                                                                    </button>
                                                                    <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); rejectVehicleImage('${driverId}', ${index}); return false;">
                                                                        <i class="fas fa-times me-1"></i>Reject
                                                                    </button>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                        ${(isApproved || isRejected) ? `
                                                            <div class="text-muted small mt-2">
                                                                ${isApproved ? `Approved by ${approval.approvedBy || 'Admin'}` : `Rejected by ${approval.rejectedBy || 'Admin'}`}
                                                                ${isApproved && approval.approvedAt ? ` on ${new Date(approval.approvedAt.seconds * 1000 || approval.approvedAt).toLocaleDateString()}` : ''}
                                                                ${isRejected && approval.rejectedAt ? ` on ${new Date(approval.rejectedAt.seconds * 1000 || approval.rejectedAt).toLocaleDateString()}` : ''}
                                                                ${isRejected && approval.reason ? `<br><em>Reason: "${approval.reason}"</em>` : ''}
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                </div>
                                ` : `
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h6><i class="fas fa-camera me-2"></i>Vehicle Images 
                                            <span class="badge bg-danger">0/4 Required</span>
                                        </h6>
                                        <div class="alert alert-danger">
                                            <i class="fas fa-times-circle me-2"></i>
                                            <strong>No vehicle images uploaded.</strong> 
                                            Minimum 4 vehicle images are required for driver approval.
                                        </div>
                                    </div>
                                </div>
                                `}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                ${!isApproved ? `
                                    <button type="button" class="btn btn-success" onclick="approveDriverFromModal(); bootstrap.Modal.getInstance(document.getElementById('driverDetailsModal')).hide();">
                                        <i class="fas fa-check"></i> Approve Driver
                                    </button>
                                ` : `
                                    <span class="badge bg-success me-2">
                                        <i class="fas fa-check-circle"></i> Driver Already Approved
                                    </span>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('driverDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Insert the new modal into the container
            document.getElementById('driverModalContainer').innerHTML = modalContent;
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('driverDetailsModal'));
            
            // Add event listeners for proper cleanup
            const modalElement = document.getElementById('driverDetailsModal');
            modalElement.addEventListener('hidden.bs.modal', function (e) {
                console.log('🔄 Modal closed, cleaning up...');
                // Remove the modal from DOM
                setTimeout(() => {
                    if (document.getElementById('driverDetailsModal')) {
                        document.getElementById('driverDetailsModal').remove();
                    }
                    // Remove any remaining modal backdrops
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => backdrop.remove());
                    // Restore body scroll
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }, 100);
            });
            
            modal.show();
        }
        
        async function approveDriverFromModal() {
            if (currentDriverId) {
                await approveDriver(currentDriverId);
                bootstrap.Modal.getInstance(document.getElementById('viewDriverModal')).hide();
            }
        }
        
        async function approveDriver(driverId) {
            try {
                await updateDoc(doc(db, 'drivers', driverId), {
                    status: 'approved',
                    isVerified: true,
                    isActive: true,
                    updatedAt: Timestamp.now()
                });
                
                showSuccess('Driver approved successfully!');
                loadDrivers(); // Refresh the drivers table
                updateNotificationBadges(); // Update notification counts
            } catch (error) {
                console.error('Error approving driver:', error);
                showError('Error approving driver: ' + error.message);
            }
        }

        // Document approval functions
        async function approveDocument(driverId, documentType, collectionName = 'drivers') {
            try {
                console.log(`🔧 Approving ${documentType} for driver ${driverId}`);
                
                const note = prompt(`Add an optional note for approving ${documentType}:\n(Leave blank if no note needed)`);
                
                const driverRef = doc(db, collectionName, driverId);
                const updateData = {};
                updateData[`documentVerification.${documentType}.status`] = 'approved';
                updateData[`documentVerification.${documentType}.approvedAt`] = Timestamp.now();
                updateData[`documentVerification.${documentType}.approvedBy`] = 'admin@system.local'; // Replace with actual admin email when auth is implemented
                updateData[`documentVerification.${documentType}.note`] = note || null;
                updateData['updatedAt'] = Timestamp.now();
                
                await updateDoc(driverRef, updateData);
                
                const successMessage = note 
                    ? `✅ ${documentType} approved with note: "${note}"`
                    : `✅ ${documentType} approved successfully!`;
                    
                showSuccess(successMessage);
                
                // Refresh the modal view immediately
                setTimeout(() => {
                    viewDriver(driverId);
                }, 500);
                
            } catch (error) {
                console.error('Error approving document:', error);
                showError('Error approving document: ' + error.message);
            }
        }

        async function rejectDocument(driverId, documentType, collectionName = 'drivers') {
            try {
                console.log(`🔧 Rejecting ${documentType} for driver ${driverId}`);
                
                const reason = prompt(`Please provide a reason for rejecting ${documentType}:`);
                if (!reason) {
                    showError('Rejection reason is required');
                    return;
                }
                
                const driverRef = doc(db, collectionName, driverId);
                const updateData = {};
                updateData[`documentVerification.${documentType}.status`] = 'rejected';
                updateData[`documentVerification.${documentType}.rejectedAt`] = Timestamp.now();
                updateData[`documentVerification.${documentType}.rejectedBy`] = 'admin@system.local'; // Replace with actual admin email when auth is implemented
                updateData[`documentVerification.${documentType}.reason`] = reason;
                updateData['updatedAt'] = Timestamp.now();
                
                await updateDoc(driverRef, updateData);
                
                showSuccess(`❌ ${documentType} rejected. Reason: "${reason}"`);
                
                // Refresh the modal view immediately
                setTimeout(() => {
                    viewDriver(driverId);
                }, 500);
                
            } catch (error) {
                console.error('Error rejecting document:', error);
                showError('Error rejecting document: ' + error.message);
            }
        }

        // Vehicle Image Approval Functions
        async function approveVehicleImage(driverId, imageIndex) {
            try {
                console.log(`🔧 Approving vehicle image ${imageIndex} for driver ${driverId}`);
                
                const note = prompt(`Add an optional note for approving Vehicle Photo ${imageIndex + 1}:\n(Leave blank if no note needed)`);
                
                const driverRef = doc(db, 'drivers', driverId);
                const driverDoc = await getDoc(driverRef);
                
                if (!driverDoc.exists()) {
                    throw new Error('Driver document not found');
                }
                
                const driverData = driverDoc.data();
                const vehicleApprovals = driverData.vehicleImageApprovals || [];
                
                // Update the approval status for this specific image
                vehicleApprovals[imageIndex] = {
                    status: 'approved',
                    approvedAt: Timestamp.now(),
                    approvedBy: 'admin@system.local', // Replace with actual admin email when auth is implemented
                    note: note || null
                };
                
                await updateDoc(driverRef, {
                    vehicleImageApprovals: vehicleApprovals,
                    updatedAt: Timestamp.now()
                });
                
                const successMessage = note 
                    ? `✅ Vehicle Photo ${imageIndex + 1} approved with note: "${note}"`
                    : `✅ Vehicle Photo ${imageIndex + 1} approved successfully!`;
                    
                showSuccess(successMessage);
                
                // Refresh the modal view
                setTimeout(() => {
                    viewDriver(driverId);
                }, 1000);
                
            } catch (error) {
                console.error('Error approving vehicle image:', error);
                showError('Error approving vehicle image: ' + error.message);
            }
        }

        async function rejectVehicleImage(driverId, imageIndex) {
            try {
                console.log(`🔧 Rejecting vehicle image ${imageIndex} for driver ${driverId}`);
                
                const reason = prompt(`Please provide a reason for rejecting Vehicle Photo ${imageIndex + 1}:`);
                if (!reason) {
                    showError('Rejection reason is required');
                    return;
                }
                
                const driverRef = doc(db, 'drivers', driverId);
                const driverDoc = await getDoc(driverRef);
                
                if (!driverDoc.exists()) {
                    throw new Error('Driver document not found');
                }
                
                const driverData = driverDoc.data();
                const vehicleApprovals = driverData.vehicleImageApprovals || [];
                
                // Update the approval status for this specific image
                vehicleApprovals[imageIndex] = {
                    status: 'rejected',
                    rejectedAt: Timestamp.now(),
                    rejectedBy: 'admin@system.local', // Replace with actual admin email when auth is implemented
                    reason: reason
                };
                
                await updateDoc(driverRef, {
                    vehicleImageApprovals: vehicleApprovals,
                    updatedAt: Timestamp.now()
                });
                
                showSuccess(`❌ Vehicle Photo ${imageIndex + 1} rejected. Reason: "${reason}"`);
                
                // Refresh the modal view
                setTimeout(() => {
                    viewDriver(driverId);
                }, 1000);
                
            } catch (error) {
                console.error('Error rejecting vehicle image:', error);
                showError('Error rejecting vehicle image: ' + error.message);
            }
        }
        
        function editDriver(id) { console.log('Edit driver:', id); }
        async function viewBusiness(businessId) {
            console.log('📄 Loading comprehensive business details for:', businessId);
            
            // Find business in the loaded businesses array
            const business = businesses.find(b => b.id === businessId);
            
            if (!business) {
                alert('Business not found');
                return;
            }

            try {
                // Load business products
                const productsQuery = query(
                    collection(db, 'business_products'),
                    where('businessId', '==', businessId)
                );
                const productsSnapshot = await getDocs(productsQuery);
                const businessProducts = [];
                productsSnapshot.forEach(doc => {
                    businessProducts.push({ id: doc.id, ...doc.data() });
                });

                const businessData = business;
                console.log('📄 Business details:', businessData);
                console.log('📄 Business structure check:');
                console.log('  - basicInfo present:', !!businessData.basicInfo);
                console.log('  - verification present:', !!businessData.verification);
                console.log('  - documents present:', !!businessData.documents);
                console.log('  - flat email:', businessData.email);
                console.log('  - nested email:', businessData.basicInfo?.email);
                console.log('  - flat emailVerified:', businessData.isEmailVerified);
                console.log('  - nested emailVerified:', businessData.verification?.isEmailVerified);
                
                // Handle both new nested structure and legacy flat structure
                const basicInfo = businessData.basicInfo || {};
                const verification = businessData.verification || {};
                const address = basicInfo.address || {};
                
                // Cross-reference with user data for verification status
                let userVerificationData = {};
                try {
                    if (businessData.userId) {
                        const userDoc = await getDoc(doc(db, 'users', businessData.userId));
                        if (userDoc.exists()) {
                            userVerificationData = userDoc.data();
                            console.log('📄 User verification data:', userVerificationData);
                        }
                    }
                } catch (error) {
                    console.log('Could not fetch user verification data:', error);
                }
                
                // Business basic information - support both structures
                let businessName, businessEmail, businessPhone, ownerName, businessDescription, businessWebsite;
                
                if (businessData.source === 'users') {
                    // Data from users collection with businessProfile
                    businessName = businessData.businessName || businessData.userName || 'N/A';
                    businessEmail = businessData.email || 'N/A';
                    businessPhone = businessData.userPhone || 'N/A';
                    ownerName = businessData.userName || 'N/A';
                    businessDescription = businessData.description || 'N/A';
                    businessWebsite = businessData.website || 'N/A';
                } else {
                    // Data from businesses collection (legacy)
                    businessName = basicInfo.name || businessData.businessName || 'N/A';
                    businessEmail = basicInfo.email || businessData.email || userVerificationData.email || 'N/A';
                    businessPhone = basicInfo.phone || businessData.phone || businessData.phoneNumber || userVerificationData.phone || 'N/A';
                    ownerName = basicInfo.ownerName || businessData.ownerName || businessData.contactPerson || businessData.owner || userVerificationData.name || 'N/A';
                    businessDescription = basicInfo.description || businessData.description || 'N/A';
                    businessWebsite = basicInfo.website || businessData.website || 'N/A';
                }
                
                // Business verification status - check multiple sources
                let isEmailVerified, isPhoneVerified, isVerified, verificationStatus;
                
                if (businessData.source === 'users') {
                    // Data from users collection with businessProfile
                    isEmailVerified = businessData.email && businessData.email !== 'N/A' && businessData.email.includes('@');
                    isPhoneVerified = businessData.userPhone && businessData.userPhone !== 'N/A';
                    isVerified = businessData.verificationStatus === 'approved';
                    verificationStatus = businessData.verificationStatus || 'pending';
                } else {
                    // Data from businesses collection (legacy)
                    isEmailVerified = verification.isEmailVerified || businessData.isEmailVerified || userVerificationData.isEmailVerified || false;
                    isPhoneVerified = verification.isPhoneVerified || businessData.isPhoneVerified || userVerificationData.isPhoneVerified || false;
                    isVerified = verification.overallStatus === 'verified' || businessData.isVerified || false;
                    verificationStatus = verification.overallStatus || (businessData.isVerified ? 'verified' : 'pending');
                }
                
                // Business type and category
                let businessType, businessCategory;
                
                if (businessData.source === 'users') {
                    // Data from users collection with businessProfile
                    businessType = businessData.businessType || 'N/A';
                    businessCategory = businessData.businessCategories?.[0] || businessData.businessType || 'N/A';
                } else {
                    // Data from businesses collection (legacy)
                    businessType = basicInfo.businessType || businessData.businessType || businessData.type || 'N/A';
                    businessCategory = basicInfo.categories?.[0] || businessData.category || businessData.businessCategory || 'N/A';
                }
                
                // Address information
                let businessAddress, businessCity, businessState, businessCountry, postalCode;
                
                if (businessData.source === 'users') {
                    // Data from users collection with businessProfile
                    businessAddress = businessData.businessAddress || 'N/A';
                    businessCity = businessData.city || 'N/A';
                    businessState = businessData.state || 'N/A';
                    businessCountry = businessData.country || 'Sri Lanka'; // Default for mobile app
                    postalCode = businessData.postalCode || 'N/A';
                } else {
                    // Data from businesses collection (legacy)
                    businessAddress = address.fullAddress || address.street || businessData.address || businessData.businessAddress || 'N/A';
                    businessCity = address.city || businessData.city || 'N/A';
                    businessState = address.state || businessData.state || businessData.province || 'N/A';
                    businessCountry = address.country || businessData.country || 'N/A';
                    postalCode = address.postalCode || businessData.postalCode || businessData.zipCode || 'N/A';
                }
                
                // Registration and document info
                let registrationNumber, taxId;
                
                if (businessData.source === 'users') {
                    // Data from users collection with businessProfile
                    registrationNumber = businessData.businessRegistrationNumber || 'N/A';
                    taxId = businessData.taxId || 'N/A';
                } else {
                    // Data from businesses collection (legacy)
                    registrationNumber = businessData.registrationNumber || businessData.businessRegistrationNumber || 'N/A';
                    taxId = businessData.taxId || businessData.vatNumber || businessData.taxNumber || 'N/A';
                }
                
                // Document status
                const documents = businessData.documents || {};
                
                const isVerifiedBusiness = isVerified;
                
                // Create a comprehensive modal for business information
                let modalContent = `
                    <div class="modal fade" id="businessDetailsModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-building me-2"></i>Business Details - ${businessName}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6><i class="fas fa-info-circle me-2"></i>Business Information</h6>
                                            <table class="table table-sm">
                                                <tr><td><strong>Business Name:</strong></td><td>${businessName}</td></tr>
                                                <tr><td><strong>Business ID:</strong></td><td><code>${businessId}</code></td></tr>
                                                <tr><td><strong>Owner/Contact:</strong></td><td>${ownerName}</td></tr>
                                                <tr><td><strong>Email:</strong></td><td>
                                                    ${businessEmail}
                                                    ${isEmailVerified ? 
                                                        '<span class="badge bg-success ms-2"><i class="fas fa-check-circle"></i> Verified</span>' : 
                                                        '<span class="badge bg-warning ms-2"><i class="fas fa-clock"></i> Unverified</span>'}
                                                </td></tr>
                                                <tr><td><strong>Phone:</strong></td><td>
                                                    ${businessPhone}
                                                    ${isPhoneVerified ? 
                                                        '<span class="badge bg-success ms-2"><i class="fas fa-check-circle"></i> Verified</span>' : 
                                                        '<span class="badge bg-warning ms-2"><i class="fas fa-clock"></i> Unverified</span>'}
                                                </td></tr>
                                                <tr><td><strong>Business Registration #:</strong></td><td>${registrationNumber}</td></tr>
                                                <tr><td><strong>Tax ID/VAT:</strong></td><td>${taxId}</td></tr>
                                                <tr><td><strong>Category:</strong></td><td><span class="badge bg-info">${businessCategory}</span></td></tr>
                                                <tr><td><strong>Business Type:</strong></td><td><span class="badge bg-secondary">${businessType}</span></td></tr>
                                                <tr><td><strong>Description:</strong></td><td>${businessDescription}</td></tr>
                                                <tr><td><strong>Website:</strong></td><td>
                                                    ${businessWebsite !== 'N/A' ? `<a href="${businessWebsite}" target="_blank" class="text-primary"><i class="fas fa-external-link-alt"></i> ${businessWebsite}</a>` : 'N/A'}
                                                </td></tr>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <h6><i class="fas fa-shield-check me-2"></i>Verification & Status</h6>
                                            <table class="table table-sm">
                                                <tr><td><strong>Verification Status:</strong></td><td><span class="badge bg-${isVerified ? 'success' : verificationStatus === 'pending' ? 'warning' : 'danger'}">${isVerified ? 'Verified' : verificationStatus}</span></td></tr>
                                                <tr><td><strong>Account Status:</strong></td><td><span class="badge bg-${businessData.isActive !== false ? 'success' : 'secondary'}">${businessData.isActive !== false ? 'Active' : 'Inactive'}</span></td></tr>
                                                <tr><td><strong>KYB Status:</strong></td><td><span class="badge bg-${businessData.kybStatus === 'completed' ? 'success' : businessData.kybStatus === 'pending' ? 'warning' : 'secondary'}">${businessData.kybStatus || 'Not Started'}</span></td></tr>
                                                <tr><td><strong>Registration Date:</strong></td><td>${businessData.createdAt ? new Date(businessData.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</td></tr>
                                                <tr><td><strong>Last Login:</strong></td><td>${businessData.lastLogin ? new Date(businessData.lastLogin.seconds * 1000).toLocaleDateString() : 'Never'}</td></tr>
                                                <tr><td><strong>Profile Completion:</strong></td><td>
                                                    ${(() => {
                                                        const fields = [
                                                            businessName !== 'N/A',
                                                            businessEmail !== 'N/A',
                                                            businessPhone !== 'N/A',
                                                            businessAddress !== 'N/A',
                                                            businessCategory !== 'N/A',
                                                            businessDescription !== 'N/A'
                                                        ];
                                                        const completedFields = fields.filter(field => field).length;
                                                        const percentage = Math.round((completedFields / fields.length) * 100);
                                                        return `<div class="progress" style="height: 20px;">
                                                            <div class="progress-bar bg-${percentage >= 80 ? 'success' : percentage >= 50 ? 'warning' : 'danger'}" 
                                                                 style="width: ${percentage}%">${percentage}%</div>
                                                        </div>`;
                                                    })()}
                                                </td></tr>
                                                <tr><td><strong>Risk Level:</strong></td><td><span class="badge bg-${businessData.riskLevel === 'low' ? 'success' : businessData.riskLevel === 'medium' ? 'warning' : 'danger'}">${businessData.riskLevel || 'Not Assessed'}</span></td></tr>
                                                <tr><td><strong>Compliance Score:</strong></td><td>⭐ ${(businessData.complianceScore || 0).toFixed(1)}/5.0</td></tr>
                                                <tr><td><strong>Document Status:</strong></td><td>
                                                    ${(() => {
                                                        if (!documents || Object.keys(documents).length === 0) return '<span class="badge bg-secondary">No Documents</span>';
                                                        const docs = Object.values(documents);
                                                        const approved = docs.filter(doc => doc?.status === 'approved').length;
                                                        const total = docs.length;
                                                        return `<span class="badge bg-${approved === total ? 'success' : approved > 0 ? 'warning' : 'danger'}">${approved}/${total} Approved</span>`;
                                                    })()}
                                                </td></tr>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-4">
                                        <div class="col-md-6">
                                            <h6><i class="fas fa-map-marker-alt me-2"></i>Location & Contact Details</h6>
                                            <table class="table table-sm">
                                                <tr><td><strong>Business Address:</strong></td><td>${businessAddress}</td></tr>
                                                <tr><td><strong>City:</strong></td><td>${businessCity}</td></tr>
                                                <tr><td><strong>State/Province:</strong></td><td>${businessState}</td></tr>
                                                <tr><td><strong>Postal/ZIP Code:</strong></td><td>${postalCode}</td></tr>
                                                <tr><td><strong>Country:</strong></td><td>${businessCountry}</td></tr>
                                                <tr><td><strong>Website:</strong></td><td>${businessWebsite !== 'N/A' ? `<a href="${businessWebsite}" target="_blank" class="text-primary"><i class="fas fa-external-link-alt"></i> ${businessWebsite}</a>` : 'N/A'}</td></tr>
                                                <tr><td><strong>Operating Hours:</strong></td><td>${businessData.operatingHours || businessData.workingHours || 'N/A'}</td></tr>
                                                <tr><td><strong>Time Zone:</strong></td><td>${businessData.timeZone || 'N/A'}</td></tr>
                                                <tr><td><strong>Languages:</strong></td><td>${businessData.languages ? (Array.isArray(businessData.languages) ? businessData.languages.join(', ') : businessData.languages) : 'N/A'}</td></tr>
                                                <tr><td><strong>Service Areas:</strong></td><td>${businessData.serviceAreas ? (Array.isArray(businessData.serviceAreas) ? businessData.serviceAreas.join(', ') : businessData.serviceAreas) : 'N/A'}</td></tr>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <h6><i class="fas fa-star me-2"></i>Business Reputation & Performance</h6>
                                            <table class="table table-sm">
                                                <tr><td><strong>Overall Rating:</strong></td><td>
                                                    <div class="d-flex align-items-center">
                                                        <span class="me-2">⭐ ${(businessData.rating || 0).toFixed(1)}/5.0</span>
                                                        <div class="progress flex-grow-1" style="height: 15px;">
                                                            <div class="progress-bar bg-warning" style="width: ${((businessData.rating || 0) / 5) * 100}%"></div>
                                                        </div>
                                                    </div>
                                                </td></tr>
                                                <tr><td><strong>Total Reviews:</strong></td><td><span class="badge bg-info">${businessData.totalReviews || 0} reviews</span></td></tr>
                                                <tr><td><strong>Response Rate:</strong></td><td>${businessData.responseRate || 'N/A'}${businessData.responseRate ? '%' : ''}</td></tr>
                                                <tr><td><strong>Response Time:</strong></td><td>${businessData.avgResponseTime || 'N/A'}</td></tr>
                                                <tr><td><strong>Completion Rate:</strong></td><td>${businessData.completionRate || 'N/A'}${businessData.completionRate ? '%' : ''}</td></tr>
                                                <tr><td><strong>Customer Satisfaction:</strong></td><td>${businessData.customerSatisfaction || 'N/A'}${businessData.customerSatisfaction ? '%' : ''}</td></tr>
                                                <tr><td><strong>Repeat Customers:</strong></td><td>${businessData.repeatCustomers || 'N/A'}${businessData.repeatCustomers ? '%' : ''}</td></tr>
                                                <tr><td><strong>Business Badges:</strong></td><td>
                                                    ${businessData.badges ? 
                                                        (Array.isArray(businessData.badges) ? 
                                                            businessData.badges.map(badge => `<span class="badge bg-success me-1">${badge}</span>`).join('') : 
                                                            `<span class="badge bg-success">${businessData.badges}</span>`
                                                        ) : 
                                                        '<span class="text-muted">No badges earned</span>'
                                                    }
                                                </td></tr>
                                                <tr><td><strong>Verified Since:</strong></td><td>${businessData.verifiedAt ? new Date(businessData.verifiedAt.seconds * 1000).toLocaleDateString() : 'Not verified'}</td></tr>
                                                <tr><td><strong>Last Activity:</strong></td><td>${businessData.lastActivity ? new Date(businessData.lastActivity.seconds * 1000).toLocaleDateString() : 'N/A'}</td></tr>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-4">
                                        <div class="col-md-6">
                                            <h6><i class="fas fa-file-alt me-2"></i>Business Documents</h6>
                                            <div class="row">
                                                ${(() => {
                                                    const docTypes = [
                                                        { key: 'businessLicense', name: 'Business License', icon: '📄' },
                                                        { key: 'taxCertificate', name: 'Tax Certificate', icon: '🧾' },
                                                        { key: 'tradeLicense', name: 'Trade License', icon: '📜' },
                                                        { key: 'ownershipProof', name: 'Ownership Proof', icon: '🏢' }
                                                    ];
                                                    
                                                    return docTypes.map(docType => {
                                                        const doc = documents[docType.key];
                                                        const hasDoc = doc && doc.url;
                                                        const status = doc?.status || 'not_submitted';
                                                        
                                                        return `
                                                        <div class="col-md-6 mb-3">
                                                            <div class="card">
                                                                <div class="card-header text-center">
                                                                    <small><strong>${docType.icon} ${docType.name}</strong></small>
                                                                </div>
                                                                <div class="card-body text-center p-2">
                                                                    ${hasDoc ? `
                                                                        <a href="${doc.url}" target="_blank" class="btn btn-outline-primary btn-sm mb-2">
                                                                            <i class="fas fa-external-link-alt"></i> View Document
                                                                        </a>
                                                                    ` : `
                                                                        <div class="alert alert-warning p-2 mb-2">
                                                                            <i class="fas fa-exclamation-triangle"></i><br>
                                                                            <small>Not Submitted</small>
                                                                        </div>
                                                                    `}
                                                                    <div class="verification-status mb-2">
                                                                        ${status === 'approved' ? '<span class="badge bg-success"><i class="fas fa-check"></i> Approved</span>' : 
                                                                          status === 'rejected' ? '<span class="badge bg-danger"><i class="fas fa-times"></i> Rejected</span>' : 
                                                                          status === 'pending' ? '<span class="badge bg-warning"><i class="fas fa-clock"></i> Pending</span>' :
                                                                          '<span class="badge bg-secondary">Not Submitted</span>'}
                                                                    </div>
                                                                    ${hasDoc && status === 'pending' ? `
                                                                        <div class="verification-actions mt-2">
                                                                            <button class="btn btn-sm btn-success me-1" onclick="approveBusinessDocument('${businessId}', '${docType.key}')">
                                                                                <i class="fas fa-check"></i> Approve
                                                                            </button>
                                                                            <button class="btn btn-sm btn-danger" onclick="rejectBusinessDocument('${businessId}', '${docType.key}')">
                                                                                <i class="fas fa-times"></i> Reject
                                                                            </button>
                                                                        </div>
                                                                    ` : ''}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        `;
                                                    }).join('');
                                                })()}
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6><i class="fas fa-chart-bar me-2"></i>Business Analytics</h6>
                                            <table class="table table-sm">
                                                <tr><td><strong>Total Products:</strong></td><td>${businessProducts.length}</td></tr>
                                                <tr><td><strong>Active Products:</strong></td><td>${businessProducts.filter(p => p.isActive).length}</td></tr>
                                                <tr><td><strong>Total Orders:</strong></td><td>${businessData.totalOrders || 0}</td></tr>
                                                <tr><td><strong>Monthly Revenue:</strong></td><td>$${businessData.monthlyRevenue || 0}</td></tr>
                                                <tr><td><strong>Total Revenue:</strong></td><td>$${businessData.totalRevenue || 0}</td></tr>
                                                <tr><td><strong>Subscription Plan:</strong></td><td><span class="badge bg-info">${businessData.subscriptionPlan || 'free'}</span></td></tr>
                                                <tr><td><strong>Last Activity:</strong></td><td>${businessData.lastActivity ? new Date(businessData.lastActivity.seconds * 1000).toLocaleDateString() : 'N/A'}</td></tr>
                                            </table>
                                            
                                            ${businessDescription !== 'N/A' ? `
                                            <div class="mt-3">
                                                <h6><i class="fas fa-align-left me-2"></i>Business Description</h6>
                                                <div class="card">
                                                    <div class="card-body">
                                                        <p class="card-text">${businessDescription}</p>
                                                    </div>
                                                </div>
                                            </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    
                                    ${businessProducts.length > 0 ? `
                                    <div class="row mt-4">
                                        <div class="col-12">
                                            <h6><i class="fas fa-boxes me-2"></i>Business Products (${businessProducts.length})</h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Product Name</th>
                                                            <th>Category</th>
                                                            <th>Price</th>
                                                            <th>Status</th>
                                                            <th>Created</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${businessProducts.slice(0, 5).map(product => `
                                                            <tr>
                                                                <td>${product.productName || 'N/A'}</td>
                                                                <td><span class="badge bg-secondary">${product.category || 'N/A'}</span></td>
                                                                <td>$${product.price || 0}</td>
                                                                <td><span class="badge bg-${product.isActive ? 'success' : 'secondary'}">${product.isActive ? 'Active' : 'Inactive'}</span></td>
                                                                <td>${product.createdAt ? new Date(product.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                                                                <td>
                                                                    <button class="btn btn-sm btn-outline-primary" onclick="viewBusinessProduct('${product.id}')">
                                                                        <i class="fas fa-eye"></i> View
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        `).join('')}
                                                        ${businessProducts.length > 5 ? `
                                                            <tr>
                                                                <td colspan="6" class="text-center text-muted">
                                                                    <em>... and ${businessProducts.length - 5} more products</em>
                                                                </td>
                                                            </tr>
                                                        ` : ''}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    ` : `
                                    <div class="row mt-4">
                                        <div class="col-12">
                                            <div class="alert alert-info">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>No products registered yet.</strong> This business hasn't added any products to their catalog.
                                            </div>
                                        </div>
                                    </div>
                                    `}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    ${!isVerified ? `
                                        <button type="button" class="btn btn-success" onclick="verifyBusinessFromModal('${businessId}'); bootstrap.Modal.getInstance(document.getElementById('businessDetailsModal')).hide();">
                                            <i class="fas fa-check"></i> Verify Business
                                        </button>
                                    ` : `
                                        <span class="badge bg-success me-2">
                                            <i class="fas fa-check-circle"></i> Business Already Verified
                                        </span>
                                    `}
                                    <button type="button" class="btn btn-info" onclick="window.open('/business-products.html?businessId=${businessId}', '_blank')">
                                        <i class="fas fa-external-link-alt"></i> View All Products
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="deleteBusiness('${businessId}', '${businessName}', '${businessData.source || 'businesses'}'); bootstrap.Modal.getInstance(document.getElementById('businessDetailsModal')).hide();">
                                        <i class="fas fa-trash"></i> Delete Business
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('businessDetailsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Insert the new modal into the container
                document.getElementById('driverModalContainer').innerHTML = modalContent;
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('businessDetailsModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error loading business details:', error);
                showError('Error loading business details: ' + error.message);
            }
        }
        function verifyBusiness(id) { console.log('Verify business:', id); }
        
        async function verifyBusinessFromModal(businessId) {
            try {
                console.log('🔧 Verifying business:', businessId);
                
                await updateDoc(doc(db, 'businesses', businessId), {
                    isVerified: true,
                    verifiedAt: Timestamp.now(),
                    status: 'verified',
                    updatedAt: Timestamp.now()
                });
                
                showSuccess('Business verified successfully!');
                loadBusinesses(); // Refresh the businesses table
                updateNotificationBadges(); // Update notification counts
            } catch (error) {
                console.error('Error verifying business:', error);
                showError('Error verifying business: ' + error.message);
            }
        }

        async function approveBusinessDocument(businessId, documentType) {
            try {
                console.log(`🔧 Approving ${documentType} for business ${businessId}`);
                
                const businessRef = doc(db, 'businesses', businessId);
                const updateData = {};
                updateData[`documents.${documentType}.status`] = 'approved';
                updateData[`documents.${documentType}.approvedAt`] = Timestamp.now();
                updateData[`documents.${documentType}.approvedBy`] = 'admin@system.local';
                updateData['updatedAt'] = Timestamp.now();
                
                await updateDoc(businessRef, updateData);
                
                showSuccess(`${documentType} document approved successfully!`);
                
                // Refresh the modal view
                setTimeout(() => {
                    viewBusiness(businessId);
                }, 1000);
                
            } catch (error) {
                console.error('Error approving business document:', error);
                showError('Error approving business document: ' + error.message);
            }
        }

        async function rejectBusinessDocument(businessId, documentType) {
            try {
                console.log(`🔧 Rejecting ${documentType} for business ${businessId}`);
                
                const reason = prompt(`Please provide a reason for rejecting the ${documentType}:`);
                if (!reason) {
                    showError('Rejection reason is required');
                    return;
                }
                
                const businessRef = doc(db, 'businesses', businessId);
                const updateData = {};
                updateData[`documents.${documentType}.status`] = 'rejected';
                updateData[`documents.${documentType}.rejectedAt`] = Timestamp.now();
                updateData[`documents.${documentType}.rejectedBy`] = 'admin@system.local';
                updateData[`documents.${documentType}.rejectionReason`] = reason;
                updateData['updatedAt'] = Timestamp.now();
                
                await updateDoc(businessRef, updateData);
                
                showSuccess(`${documentType} document rejected. Reason: "${reason}"`);
                
                // Refresh the modal view
                setTimeout(() => {
                    viewBusiness(businessId);
                }, 1000);
                
            } catch (error) {
                console.error('Error rejecting business document:', error);
                showError('Error rejecting business document: ' + error.message);
            }
        }

        // Delete Business Function
        async function deleteBusiness(businessId, businessName, source = 'businesses') {
            // Show confirmation dialog
            const isConfirmed = confirm(
                `⚠️ DELETE BUSINESS CONFIRMATION\n\n` +
                `Business: ${businessName}\n` +
                `ID: ${businessId}\n` +
                `Source: ${source}\n\n` +
                `This action will:\n` +
                `• Delete the business profile\n` +
                `• Remove all associated products\n` +
                `• Clear user business role (if from users collection)\n` +
                `• This CANNOT be undone!\n\n` +
                `Are you sure you want to proceed?`
            );

            if (!isConfirmed) {
                console.log('❌ Business deletion cancelled by user');
                return;
            }

            // Second confirmation for safety
            const finalConfirm = confirm(
                `🚨 FINAL CONFIRMATION\n\n` +
                `You are about to permanently delete "${businessName}".\n` +
                `This is your last chance to cancel.\n\n` +
                `Type "DELETE" and click OK to confirm, or Cancel to abort.`
            );

            if (!finalConfirm) {
                console.log('❌ Business deletion cancelled at final confirmation');
                return;
            }

            try {
                console.log(`🗑️ Starting business deletion process for: ${businessName} (ID: ${businessId})`);
                console.log(`📍 Source: ${source}`);

                // Show loading state
                const deleteButtons = document.querySelectorAll(`[onclick*="deleteBusiness('${businessId}'"]`);
                deleteButtons.forEach(btn => {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                    btn.disabled = true;
                });

                // Step 1: Delete associated business products
                console.log('🔄 Deleting associated business products...');
                const productsQuery = query(
                    collection(db, 'business_products'),
                    where('businessId', '==', businessId)
                );
                const productsSnapshot = await getDocs(productsQuery);
                
                const productDeletions = [];
                productsSnapshot.forEach(doc => {
                    console.log(`  - Deleting product: ${doc.id}`);
                    productDeletions.push(deleteDoc(doc.ref));
                });
                
                if (productDeletions.length > 0) {
                    await Promise.all(productDeletions);
                    console.log(`✅ Deleted ${productDeletions.length} associated products`);
                }

                // Step 2: Delete from appropriate collection
                if (source === 'users') {
                    // Delete businessProfile from users collection and update roles
                    console.log('🔄 Removing business profile from users collection...');
                    await updateDoc(doc(db, 'users', businessId), {
                        businessProfile: deleteField(),
                        roles: arrayRemove('business'),
                        updatedAt: serverTimestamp()
                    });
                    console.log('✅ Business profile removed from user document');
                } else {
                    // Delete from businesses collection
                    console.log('🔄 Deleting from businesses collection...');
                    await deleteDoc(doc(db, 'businesses', businessId));
                    console.log('✅ Business document deleted from businesses collection');
                }

                // Step 3: Clean up any verification data
                try {
                    console.log('🔄 Cleaning up verification data...');
                    const verificationQuery = query(
                        collection(db, 'business_verifications'),
                        where('businessId', '==', businessId)
                    );
                    const verificationSnapshot = await getDocs(verificationQuery);
                    
                    const verificationDeletions = [];
                    verificationSnapshot.forEach(doc => {
                        verificationDeletions.push(deleteDoc(doc.ref));
                    });
                    
                    if (verificationDeletions.length > 0) {
                        await Promise.all(verificationDeletions);
                        console.log(`✅ Cleaned up ${verificationDeletions.length} verification records`);
                    }
                } catch (verifyError) {
                    console.warn('⚠️ Could not clean up verification data:', verifyError);
                }

                // Success!
                console.log('🎉 Business deletion completed successfully!');
                showSuccess(`Business "${businessName}" has been permanently deleted!`);
                
                // Refresh the businesses table
                await loadBusinesses();

            } catch (error) {
                console.error('❌ Error deleting business:', error);
                showError(`Failed to delete business: ${error.message}`);
                
                // Restore button state on error
                const deleteButtons = document.querySelectorAll(`[onclick*="deleteBusiness('${businessId}'"]`);
                deleteButtons.forEach(btn => {
                    btn.innerHTML = '<i class="fas fa-trash"></i> Delete';
                    btn.disabled = false;
                });
            }
        }
        
        // Sample Data Creation Functions
        async function createSampleProducts() {
            try {
                console.log('🔄 Creating sample master products...');
                
                // Show loading indication
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';
                button.disabled = true;

                const sampleProducts = [
                    {
                        name: 'iPhone 15 Pro',
                        description: 'Latest Apple smartphone with advanced features',
                        categoryId: 'electronics',
                        subcategoryId: '',
                        brand: 'Apple',
                        specifications: {},
                        imageUrls: [],
                        keywords: ['smartphone', 'apple', 'iphone']
                    },
                    {
                        name: 'Samsung Galaxy S24',
                        description: 'Premium Android smartphone',
                        categoryId: 'electronics',
                        subcategoryId: '',
                        brand: 'Samsung',
                        specifications: {},
                        imageUrls: [],
                        keywords: ['smartphone', 'samsung', 'android']
                    },
                    {
                        name: 'Nike Air Max',
                        description: 'Comfortable running shoes',
                        categoryId: 'fashion',
                        subcategoryId: '',
                        brand: 'Nike',
                        specifications: {},
                        imageUrls: [],
                        keywords: ['shoes', 'nike', 'running']
                    },
                    {
                        name: 'Office Chair',
                        description: 'Ergonomic office chair for work',
                        categoryId: 'home-garden',
                        subcategoryId: '',
                        brand: 'Generic',
                        specifications: {},
                        imageUrls: [],
                        keywords: ['chair', 'office', 'furniture']
                    },
                    {
                        name: 'Soccer Ball',
                        description: 'Official size soccer ball',
                        categoryId: 'sports',
                        subcategoryId: '',
                        brand: 'Adidas',
                        specifications: {},
                        imageUrls: [],
                        keywords: ['soccer', 'ball', 'sports']
                    }
                ];

                const promises = sampleProducts.map(productData => {
                    const docRef = doc(collection(db, 'master_products'));
                    return setDoc(docRef, {
                        ...productData,
                        isActive: true,
                        createdAt: Timestamp.now(),
                        updatedAt: Timestamp.now()
                    });
                });

                await Promise.all(promises);

                // Restore button
                button.innerHTML = originalText;
                button.disabled = false;

                showSuccess(`✅ Created ${sampleProducts.length} sample master products!`);
                console.log(`✅ Created ${sampleProducts.length} master products`);
                
                // Reload master products to show new data
                await loadMasterProducts();

            } catch (error) {
                console.error('❌ Error creating sample master products:', error);
                showError('Error creating sample master products: ' + error.message);
                
                // Restore button on error
                const button = event.target;
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        async function viewRequest(id) {
            try {
                const requestDoc = await getDoc(doc(db, 'requests', id));
                if (!requestDoc.exists()) {
                    showError('Request not found');
                    return;
                }
                
                const requestData = requestDoc.data();
                const requestId = requestDoc.id;
                
                // Get user data
                let userData = {};
                if (requestData.userId) {
                    try {
                        const userDoc = await getDoc(doc(db, 'users', requestData.userId));
                        if (userDoc.exists()) {
                            userData = userDoc.data();
                        }
                    } catch (error) {
                        console.log('Could not load user data:', error);
                    }
                }
                
                // Get assigned driver data if applicable
                let driverData = {};
                if (requestData.assignedDriverId) {
                    try {
                        const driverDoc = await getDoc(doc(db, 'drivers', requestData.assignedDriverId));
                        if (driverDoc.exists()) {
                            driverData = driverDoc.data();
                        }
                    } catch (error) {
                        console.log('Could not load driver data:', error);
                    }
                }
                
                // Get responses/bids for this request
                const responsesSnapshot = await getDocs(
                    query(collection(db, 'responses'), where('requestId', '==', id))
                );
                
                const modalContent = `
                    <div class="modal fade" id="requestDetailsModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-clipboard-list me-2"></i>Request Details: ${requestData.title || 'Untitled Request'}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="card mb-3">
                                                <div class="card-header">
                                                    <h6><i class="fas fa-info-circle me-2"></i>Request Information</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <p><strong>Title:</strong> ${requestData.title || 'Not provided'}</p>
                                                            <p><strong>Type:</strong> 
                                                                <span class="badge bg-info">${requestData.type || 'general'}</span>
                                                            </p>
                                                            <p><strong>Category:</strong> ${requestData.category || 'Not specified'}</p>
                                                            <p><strong>Budget:</strong> LKR ${requestData.budget || 'Not specified'}</p>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <p><strong>Status:</strong> 
                                                                <span class="badge ${getStatusBadgeClass(requestData.status)}">${requestData.status || 'pending'}</span>
                                                            </p>
                                                            <p><strong>Priority:</strong> 
                                                                <span class="badge ${getPriorityBadgeClass(requestData.priority)}">${requestData.priority || 'normal'}</span>
                                                            </p>
                                                            <p><strong>Created:</strong> ${requestData.createdAt ? new Date(requestData.createdAt.toDate()).toLocaleDateString() : 'Unknown'}</p>
                                                            <p><strong>Updated:</strong> ${requestData.updatedAt ? new Date(requestData.updatedAt.toDate()).toLocaleDateString() : 'Never'}</p>
                                                        </div>
                                                    </div>
                                                    <div class="mt-3">
                                                        <strong>Description:</strong>
                                                        <p class="border rounded p-2 bg-light">${requestData.description || 'No description provided'}</p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="card mb-3">
                                                <div class="card-header">
                                                    <h6><i class="fas fa-map-marker-alt me-2"></i>Location & Delivery</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <p><strong>Pickup Location:</strong> ${requestData.pickupLocation?.address || 'Not specified'}</p>
                                                            <p><strong>Delivery Location:</strong> ${requestData.deliveryLocation?.address || 'Not specified'}</p>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <p><strong>Preferred Time:</strong> ${requestData.preferredTime || 'Flexible'}</p>
                                                            <p><strong>Urgency:</strong> ${requestData.urgency || 'Normal'}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="card mb-3">
                                                <div class="card-header">
                                                    <h6><i class="fas fa-user me-2"></i>Requester</h6>
                                                </div>
                                                <div class="card-body text-center">
                                                    <img src="${userData.photoURL || '/api/placeholder/80/80'}" 
                                                         alt="User" class="rounded-circle mb-2" style="width: 80px; height: 80px; object-fit: cover;">
                                                    <h6>${userData.displayName || 'Unknown User'}</h6>
                                                    <p class="small text-muted">${userData.email || 'No email'}</p>
                                                    <p class="small text-muted">${userData.phoneNumber || 'No phone'}</p>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="viewUser('${requestData.userId}')">
                                                        View Profile
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            ${requestData.assignedDriverId ? `
                                                <div class="card mb-3">
                                                    <div class="card-header">
                                                        <h6><i class="fas fa-car me-2"></i>Assigned Driver</h6>
                                                    </div>
                                                    <div class="card-body text-center">
                                                        <img src="${driverData.photoUrl || '/api/placeholder/80/80'}" 
                                                             alt="Driver" class="rounded-circle mb-2" style="width: 80px; height: 80px; object-fit: cover;">
                                                        <h6>${driverData.name || 'Unknown Driver'}</h6>
                                                        <p class="small text-muted">${driverData.email || 'No email'}</p>
                                                        <p class="small text-muted">${driverData.phoneNumber || 'No phone'}</p>
                                                        <button class="btn btn-sm btn-outline-success" onclick="viewDriver('${requestData.assignedDriverId}')">
                                                            View Driver
                                                        </button>
                                                    </div>
                                                </div>
                                            ` : `
                                                <div class="card mb-3">
                                                    <div class="card-header">
                                                        <h6><i class="fas fa-search me-2"></i>Driver Assignment</h6>
                                                    </div>
                                                    <div class="card-body text-center">
                                                        <i class="fas fa-user-slash fa-2x text-muted mb-2"></i>
                                                        <p class="text-muted">No driver assigned</p>
                                                        <button class="btn btn-sm btn-primary" onclick="assignDriverToRequest('${requestId}')">
                                                            Assign Driver
                                                        </button>
                                                    </div>
                                                </div>
                                            `}
                                            
                                            <div class="card">
                                                <div class="card-header">
                                                    <h6><i class="fas fa-chart-line me-2"></i>Request Stats</h6>
                                                </div>
                                                <div class="card-body">
                                                    <p><strong>Request ID:</strong> <small><code>${requestId}</code></small></p>
                                                    <p><strong>Responses:</strong> ${responsesSnapshot.size}</p>
                                                    <p><strong>Views:</strong> ${requestData.viewCount || 0}</p>
                                                    <p><strong>Favorites:</strong> ${requestData.favoriteCount || 0}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    ${responsesSnapshot.size > 0 ? `
                                        <hr>
                                        <h6><i class="fas fa-comments me-2"></i>Responses & Bids (${responsesSnapshot.size})</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Provider</th>
                                                        <th>Bid Amount</th>
                                                        <th>Message</th>
                                                        <th>Date</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${responsesSnapshot.docs.map(resp => {
                                                        const respData = resp.data();
                                                        return `
                                                            <tr>
                                                                <td>${respData.providerName || 'Unknown'}</td>
                                                                <td>LKR ${respData.bidAmount || 'N/A'}</td>
                                                                <td class="text-truncate" style="max-width: 200px;">${respData.message || 'No message'}</td>
                                                                <td>${respData.createdAt ? new Date(respData.createdAt.toDate()).toLocaleDateString() : 'Unknown'}</td>
                                                                <td><span class="badge bg-info">${respData.status || 'pending'}</span></td>
                                                            </tr>
                                                        `;
                                                    }).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    ` : ''}
                                    
                                    ${requestData.images && requestData.images.length > 0 ? `
                                        <hr>
                                        <h6><i class="fas fa-images me-2"></i>Request Images</h6>
                                        <div class="row">
                                            ${requestData.images.map(img => `
                                                <div class="col-md-3 mb-2">
                                                    <img src="${img}" alt="Request Image" class="img-fluid rounded" style="max-height: 150px; object-fit: cover;">
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="modal-footer">
                                    <div class="d-flex justify-content-between align-items-center w-100">
                                        <div class="d-flex gap-2">
                                            <div class="dropdown">
                                                <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown">
                                                    <i class="fas fa-exchange-alt me-1"></i>Quick Status
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" onclick="updateRequestStatus('${requestId}', 'pending')">
                                                        <i class="fas fa-clock text-warning me-2"></i>Pending
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="updateRequestStatus('${requestId}', 'confirmed')">
                                                        <i class="fas fa-check text-success me-2"></i>Confirmed
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="updateRequestStatus('${requestId}', 'in_progress')">
                                                        <i class="fas fa-spinner text-info me-2"></i>In Progress
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="updateRequestStatus('${requestId}', 'completed')">
                                                        <i class="fas fa-check-circle text-success me-2"></i>Completed
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="updateRequestStatus('${requestId}', 'cancelled')">
                                                        <i class="fas fa-times-circle text-danger me-2"></i>Cancelled
                                                    </a></li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            <button type="button" class="btn btn-warning" onclick="editRequest('${requestId}')">
                                                <i class="fas fa-edit me-2"></i>Edit
                                            </button>
                                            ${!requestData.assignedDriverId ? `
                                                <button type="button" class="btn btn-primary" onclick="assignDriverToRequest('${requestId}')">
                                                    <i class="fas fa-user-plus me-2"></i>Assign Driver
                                                </button>
                                            ` : `
                                                <button type="button" class="btn btn-info" onclick="viewAssignedDriver('${requestData.assignedDriverId}')">
                                                    <i class="fas fa-user me-2"></i>View Driver
                                                </button>
                                            `}
                                            <button type="button" class="btn btn-danger" onclick="deleteRequest('${requestId}')">
                                                <i class="fas fa-trash me-2"></i>Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if present
                const existingModal = document.getElementById('requestDetailsModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Insert new modal
                document.getElementById('requestModalContainer').innerHTML = modalContent;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('requestDetailsModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error viewing request:', error);
                showError('Error loading request details: ' + error.message);
            }
        }
        
        // Helper functions for request modal
        function getStatusBadgeClass(status) {
            switch(status) {
                case 'completed': return 'bg-success';
                case 'active': return 'bg-primary';
                case 'cancelled': return 'bg-danger';
                case 'pending': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }
        
        function getPriorityBadgeClass(priority) {
            switch(priority) {
                case 'high': return 'bg-danger';
                case 'medium': return 'bg-warning';
                case 'low': return 'bg-success';
                default: return 'bg-secondary';
            }
        }
        
        // Additional action functions for request modal
        async function assignDriverToRequest(requestId) {
            try {
                // Load available drivers
                const driversSnapshot = await getDocs(
                    query(collection(db, 'drivers'), where('isActive', '==', true), where('status', '==', 'approved'))
                );
                
                const drivers = driversSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                if (drivers.length === 0) {
                    showToast('No active and approved drivers available for assignment', 'error');
                    return;
                }
                
                const modalContent = `
                    <div class="modal fade" id="assignDriverModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-user-plus me-2"></i>Assign Driver to Request
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Select a driver to assign to this request. Only active and approved drivers are shown.
                                    </div>
                                    
                                    <div class="row">
                                        ${drivers.map(driver => `
                                            <div class="col-md-6 mb-3">
                                                <div class="card driver-card" style="cursor: pointer;" onclick="selectDriverForAssignment('${driver.id}')">
                                                    <div class="card-body">
                                                        <div class="row align-items-center">
                                                            <div class="col-auto">
                                                                <img src="${driver.photoUrl || '/api/placeholder/60/60'}" 
                                                                     alt="Driver" class="rounded-circle" 
                                                                     style="width: 60px; height: 60px; object-fit: cover;">
                                                            </div>
                                                            <div class="col">
                                                                <h6 class="mb-1">${driver.name || 'Unknown Driver'}</h6>
                                                                <p class="small text-muted mb-1">${driver.email || 'No email'}</p>
                                                                <p class="small text-muted mb-1">${driver.phoneNumber || 'No phone'}</p>
                                                                <div class="d-flex align-items-center">
                                                                    <span class="badge bg-success me-2">Active</span>
                                                                    <span class="text-warning">
                                                                        ${'★'.repeat(Math.round(driver.rating || 0))}
                                                                        ${'☆'.repeat(5 - Math.round(driver.rating || 0))}
                                                                    </span>
                                                                    <small class="text-muted ms-1">(${driver.totalRides || 0} rides)</small>
                                                                </div>
                                                                <div class="mt-2">
                                                                    <small class="text-muted">
                                                                        <i class="fas fa-car me-1"></i>
                                                                        ${driver.vehicleInfo?.make || 'Unknown'} ${driver.vehicleInfo?.model || ''}
                                                                        ${driver.vehicleInfo?.year || ''}
                                                                    </small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    
                                    <input type="hidden" id="selectedDriverId" value="">
                                    <div id="selectedDriverInfo" style="display: none;" class="alert alert-success mt-3">
                                        <h6><i class="fas fa-check-circle me-2"></i>Selected Driver:</h6>
                                        <div id="selectedDriverDetails"></div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" id="confirmAssignBtn" disabled onclick="confirmDriverAssignment('${requestId}')">
                                        <i class="fas fa-check me-2"></i>Assign Driver
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if present
                const existingModal = document.getElementById('assignDriverModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Insert new modal
                document.body.insertAdjacentHTML('beforeend', modalContent);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('assignDriverModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error loading drivers for assignment:', error);
                showToast('Error loading drivers: ' + error.message, 'error');
            }
        }
        
        function selectDriverForAssignment(driverId) {
            // Remove previous selections
            document.querySelectorAll('.driver-card').forEach(card => {
                card.classList.remove('border-primary');
                card.style.borderWidth = '1px';
            });
            
            // Highlight selected card
            event.currentTarget.classList.add('border-primary');
            event.currentTarget.style.borderWidth = '2px';
            
            // Store selected driver ID
            document.getElementById('selectedDriverId').value = driverId;
            
            // Show selected driver info
            const selectedInfo = document.getElementById('selectedDriverInfo');
            selectedInfo.style.display = 'block';
            
            // Enable assign button
            document.getElementById('confirmAssignBtn').disabled = false;
            
            // Get driver data from the card for display
            const card = event.currentTarget;
            const driverName = card.querySelector('h6').textContent;
            const driverEmail = card.querySelector('.text-muted').textContent;
            
            document.getElementById('selectedDriverDetails').innerHTML = `
                <strong>${driverName}</strong><br>
                <small>${driverEmail}</small>
            `;
        }
        
        async function confirmDriverAssignment(requestId) {
            const selectedDriverId = document.getElementById('selectedDriverId').value;
            
            if (!selectedDriverId) {
                showToast('Please select a driver', 'error');
                return;
            }
            
            try {
                // Update request with assigned driver
                await updateDoc(doc(db, 'requests', requestId), {
                    assignedDriverId: selectedDriverId,
                    status: 'assigned',
                    assignedAt: new Date(),
                    assignedBy: 'admin'
                });
                
                // Create notification for driver
                await addDoc(collection(db, 'notifications'), {
                    userId: selectedDriverId,
                    type: 'request_assigned',
                    title: 'New Request Assigned',
                    message: 'You have been assigned a new request',
                    requestId: requestId,
                    createdAt: new Date(),
                    read: false
                });
                
                showToast('Driver assigned successfully!', 'success');
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('assignDriverModal')).hide();
                
                // Refresh the request details modal if open
                const requestModal = document.getElementById('requestDetailsModal');
                if (requestModal) {
                    bootstrap.Modal.getInstance(requestModal).hide();
                    // Reopen with updated data
                    setTimeout(() => viewRequest(requestId), 500);
                }
                
                // Refresh requests table
                loadRequests();
                
            } catch (error) {
                console.error('Error assigning driver:', error);
                showToast('Error assigning driver: ' + error.message, 'error');
            }
        }
        
        function editRequest(requestId) {
            // Implementation for request editing
            console.log('Edit request:', requestId);
            showSuccess('Request editing feature will be implemented');
        }
        
        function deleteRequest(requestId) {
            if (confirm('Are you sure you want to delete this request? This action cannot be undone.')) {
                // Implementation for request deletion
                console.log('Delete request:', requestId);
                showSuccess('Request deletion feature will be implemented');
            }
        }
        
        // Quick status update function
        async function updateRequestStatus(requestId, newStatus) {
            try {
                await updateDoc(doc(db, 'requests', requestId), {
                    status: newStatus,
                    statusUpdatedAt: new Date(),
                    statusUpdatedBy: 'admin'
                });
                
                showToast(`Request status updated to ${newStatus.replace('_', ' ')}`, 'success');
                
                // Refresh the request details modal if open
                const requestModal = document.getElementById('requestDetailsModal');
                if (requestModal) {
                    bootstrap.Modal.getInstance(requestModal).hide();
                    // Reopen with updated data
                    setTimeout(() => viewRequest(requestId), 500);
                }
                
                // Refresh requests table
                loadRequests();
                
            } catch (error) {
                console.error('Error updating request status:', error);
                showToast('Error updating status: ' + error.message, 'error');
            }
        }
        
        // View assigned driver function
        async function viewAssignedDriver(driverId) {
            try {
                const driverDoc = await getDoc(doc(db, 'drivers', driverId));
                if (driverDoc.exists()) {
                    const driverData = driverDoc.data();
                    
                    const modalContent = `
                        <div class="modal fade" id="assignedDriverModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">
                                            <i class="fas fa-user me-2"></i>Assigned Driver Details
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-md-4 text-center">
                                                <img src="${driverData.photoUrl || '/api/placeholder/150/150'}" 
                                                     alt="Driver Photo" class="rounded-circle mb-3" 
                                                     style="width: 150px; height: 150px; object-fit: cover;">
                                                <h5>${driverData.name || 'Unknown Driver'}</h5>
                                                <div class="text-warning mb-2">
                                                    ${'★'.repeat(Math.round(driverData.rating || 0))}
                                                    ${'☆'.repeat(5 - Math.round(driverData.rating || 0))}
                                                    <small class="text-muted">(${driverData.totalRides || 0} rides)</small>
                                                </div>
                                                <span class="badge bg-success">Active Driver</span>
                                            </div>
                                            <div class="col-md-8">
                                                <h6><i class="fas fa-info-circle me-2"></i>Contact Information</h6>
                                                <p><strong>Email:</strong> ${driverData.email || 'Not provided'}</p>
                                                <p><strong>Phone:</strong> ${driverData.phoneNumber || 'Not provided'}</p>
                                                
                                                <h6 class="mt-4"><i class="fas fa-car me-2"></i>Vehicle Information</h6>
                                                <p><strong>Make & Model:</strong> ${driverData.vehicleInfo?.make || 'Unknown'} ${driverData.vehicleInfo?.model || ''}</p>
                                                <p><strong>Year:</strong> ${driverData.vehicleInfo?.year || 'Not specified'}</p>
                                                <p><strong>License Plate:</strong> ${driverData.vehicleInfo?.licensePlate || 'Not provided'}</p>
                                                <p><strong>Color:</strong> ${driverData.vehicleInfo?.color || 'Not specified'}</p>
                                                
                                                <h6 class="mt-4"><i class="fas fa-chart-line me-2"></i>Driver Statistics</h6>
                                                <div class="row">
                                                    <div class="col-sm-6">
                                                        <p><strong>Total Rides:</strong> ${driverData.totalRides || 0}</p>
                                                        <p><strong>Completed Rides:</strong> ${driverData.completedRides || 0}</p>
                                                    </div>
                                                    <div class="col-sm-6">
                                                        <p><strong>Rating:</strong> ${(driverData.rating || 0).toFixed(1)}/5.0</p>
                                                        <p><strong>Earnings:</strong> LKR ${driverData.totalEarnings || 0}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <button type="button" class="btn btn-primary" onclick="contactDriver('${driverId}')">
                                            <i class="fas fa-phone me-2"></i>Contact Driver
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Remove existing modal if present
                    const existingModal = document.getElementById('assignedDriverModal');
                    if (existingModal) {
                        existingModal.remove();
                    }
                    
                    // Insert new modal
                    document.body.insertAdjacentHTML('beforeend', modalContent);
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('assignedDriverModal'));
                    modal.show();
                    
                } else {
                    showToast('Driver not found', 'error');
                }
            } catch (error) {
                console.error('Error loading driver details:', error);
                showToast('Error loading driver details: ' + error.message, 'error');
            }
        }
        
        // Contact driver function
        function contactDriver(driverId) {
            showToast('Contact feature will be implemented', 'info');
            // Implementation for contacting driver (SMS, email, push notification)
        }
        
        // Additional action functions for user modal
        function toggleUserStatus(userId, disable) {
            if (confirm(`Are you sure you want to ${disable ? 'disable' : 'enable'} this user?`)) {
                // Implementation for user status toggle
                console.log('Toggle user status:', userId, disable);
                showSuccess(`User ${disable ? 'disabled' : 'enabled'} successfully`);
            }
        }
        function assignDriver(id) { console.log('Assign driver to request:', id); }
        function viewMasterProduct(id) { console.log('View master product:', id); }
        
        function editMasterProduct(id) { 
            showMasterProductModal(id, true);
        }
        
        async function deleteMasterProduct(id) {
            // First check if product has business listings
            try {
                const businessProductsQuery = query(
                    collection(db, 'business_products'), 
                    where('masterProductId', '==', id)
                );
                const businessProductsSnapshot = await getDocs(businessProductsQuery);
                
                if (!businessProductsSnapshot.empty) {
                    showToast('Cannot delete product: It has business listings assigned to it', 'error');
                    return;
                }
                
                if (confirm('Are you sure you want to delete this master product? This action cannot be undone.')) {
                    await deleteDoc(doc(db, 'master_products', id));
                    showToast('Master product deleted successfully!', 'success');
                    loadMasterProducts(); // Refresh the products list
                }
            } catch (error) {
                console.error('Error deleting master product:', error);
                showToast('Error deleting master product: ' + error.message, 'error');
            }
        }
        
        function showAddMasterProductModal() {
            showMasterProductModal();
        }
        
        function showMasterProductModal(productId = null, isEdit = false) {
            const modalTitle = isEdit ? 'Edit Master Product' : 'Add New Master Product';
            const submitButtonText = isEdit ? 'Update Product' : 'Create Product';
            
            const modalContent = `
                <div class="modal fade" id="masterProductModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-box me-2"></i>${modalTitle}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="masterProductForm">
                                    <!-- Basic Information -->
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="productName" class="form-label">Product Name *</label>
                                                        <input type="text" class="form-control" id="productName" required>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="productBrand" class="form-label">Brand *</label>
                                                        <select class="form-control" id="productBrand" required>
                                                            <option value="">Select Brand</option>
                                                        </select>
                                                        <div class="mt-2">
                                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addNewBrand()">
                                                                <i class="fas fa-plus"></i> Add New Brand
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="productDescription" class="form-label">Description *</label>
                                                <textarea class="form-control" id="productDescription" rows="3" required></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Category & Classification -->
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-tags me-2"></i>Category & Classification</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="productCategory" class="form-label">Category *</label>
                                                        <select class="form-control" id="productCategory" required onchange="loadSubcategoriesForProduct()">
                                                            <option value="">Select Category</option>
                                                        </select>
                                                        <div class="mt-2">
                                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addNewCategory()">
                                                                <i class="fas fa-plus"></i> Add New Category
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="productSubcategory" class="form-label">Subcategory</label>
                                                        <select class="form-control" id="productSubcategory">
                                                            <option value="">Select Subcategory</option>
                                                        </select>
                                                        <div class="mt-2">
                                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addNewSubcategory()">
                                                                <i class="fas fa-plus"></i> Add New Subcategory
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="productKeywords" class="form-label">Keywords (comma-separated)</label>
                                                <input type="text" class="form-control" id="productKeywords" placeholder="smartphone, apple, iphone">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Additional Details -->
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="fas fa-list me-2"></i>Additional Details</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="productSpecifications" class="form-label">Specifications (JSON format)</label>
                                                <textarea class="form-control" id="productSpecifications" rows="4" placeholder='{"color": "Black", "storage": "128GB", "ram": "8GB"}'></textarea>
                                                <small class="form-text text-muted">Enter specifications in JSON format</small>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="productActive" checked>
                                                <label class="form-check-label" for="productActive">
                                                    Active
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="submitMasterProduct('${productId || ''}')">
                                    <i class="fas fa-save me-2"></i>${submitButtonText}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if present
            const existingModal = document.getElementById('masterProductModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Insert new modal
            document.body.insertAdjacentHTML('beforeend', modalContent);
            
            // Load all necessary data for the form
            setTimeout(async () => {
                await loadCategoriesForDropdown();
                await loadBrandsForDropdown();
                
                // If editing, load product data after categories are loaded
                if (isEdit && productId) {
                    setTimeout(() => {
                        loadMasterProductForEdit(productId);
                    }, 100);
                }
            }, 200);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('masterProductModal'));
            modal.show();
        }
        
        async function submitMasterProduct(productId = '') {
            const form = document.getElementById('masterProductForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const productData = {
                name: document.getElementById('productName').value.trim(),
                description: document.getElementById('productDescription').value.trim(),
                categoryId: document.getElementById('productCategory').value,
                subcategoryId: document.getElementById('productSubcategory').value,
                brand: document.getElementById('productBrand').value,
                isActive: true, // Default to active
                updatedAt: new Date()
            };

            try {
                if (productId) {
                    // Update existing product
                    await updateDoc(doc(db, 'master_products', productId), productData);
                    showToast('Master product updated successfully!', 'success');
                } else {
                    // Create new product
                    productData.createdAt = new Date();
                    await addDoc(collection(db, 'master_products'), productData);
                    showToast('Master product created successfully!', 'success');
                }

                // Close modal and refresh list
                bootstrap.Modal.getInstance(document.getElementById('masterProductModal')).hide();
                loadMasterProducts();
            } catch (error) {
                console.error('Error saving master product:', error);
                showToast('Error saving master product: ' + error.message, 'error');
            }
        }

        async function loadCategoriesForDropdown() {
            try {
                console.log('Loading categories for dropdown...');
                const categorySelect = document.getElementById('productCategory');
                if (!categorySelect) {
                    console.error('Category select element not found');
                    return;
                }

                let categoriesSnapshot = await getDocs(collection(db, 'categories'));
                console.log('Categories loaded:', categoriesSnapshot.size);
                
                // If no categories exist, create initial ones
                if (categoriesSnapshot.empty) {
                    console.log('No categories found, creating initial categories...');
                    await createInitialCategories();
                    // Reload categories after creation
                    categoriesSnapshot = await getDocs(collection(db, 'categories'));
                }
                
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                
                if (categoriesSnapshot.empty) {
                    console.log('Still no categories found after creation attempt');
                    categorySelect.innerHTML += '<option value="" disabled>No categories available</option>';
                    return;
                }
                
                categoriesSnapshot.forEach(doc => {
                    const category = doc.data();
                    console.log('Adding category:', category.category);
                    const option = document.createElement('option');
                    option.value = category.category;
                    option.textContent = category.category;
                    categorySelect.appendChild(option);
                });
                
                console.log('Categories dropdown populated successfully');
            } catch (error) {
                console.error('Error loading categories for dropdown:', error);
                showToast('Error loading categories: ' + error.message, 'error');
            }
        }

        async function loadMasterProductForEdit(productId) {
            try {
                console.log('Loading master product for edit:', productId);
                const productDoc = await getDoc(doc(db, 'master_products', productId));
                
                if (!productDoc.exists()) {
                    console.log('Master product not found:', productId);
                    showToast('Master product not found', 'error');
                    return;
                }

                const productData = productDoc.data();
                console.log('Master product data loaded:', productData);

                // Populate form fields (except category first)
                document.getElementById('productName').value = productData.name || '';
                document.getElementById('productBrand').value = productData.brand || '';
                document.getElementById('productDescription').value = productData.description || '';
                document.getElementById('productSubcategory').value = productData.subcategory || '';
                document.getElementById('productKeywords').value = productData.keywords ? productData.keywords.join(', ') : '';
                document.getElementById('productActive').checked = productData.active !== false;
                
                // Handle specifications
                if (productData.specifications) {
                    document.getElementById('productSpecifications').value = JSON.stringify(productData.specifications, null, 2);
                }
                
                // Set category value with a small delay to ensure dropdown is populated
                if (productData.category) {
                    setTimeout(() => {
                        const categorySelect = document.getElementById('productCategory');
                        if (categorySelect) {
                            console.log('Available options:', Array.from(categorySelect.options).map(opt => opt.value));
                            console.log('Trying to set category to:', productData.category);
                            categorySelect.value = productData.category;
                            console.log('Category set to:', categorySelect.value);
                            
                            // If category wasn't set, try to find it by name
                            if (!categorySelect.value && productData.category) {
                                const options = Array.from(categorySelect.options);
                                const matchingOption = options.find(opt => opt.value === productData.category);
                                if (matchingOption) {
                                    categorySelect.value = matchingOption.value;
                                    console.log('Category found and set:', matchingOption.value);
                                } else {
                                    console.log('Category not found in dropdown options');
                                }
                            }
                        }
                    }, 100);
                }

            } catch (error) {
                console.error('Error loading master product data:', error);
                showToast('Error loading master product data: ' + error.message, 'error');
            }
        }

        // Load brands for dropdown in product form
        async function loadBrandsForDropdown() {
            try {
                const brandSelect = document.getElementById('productBrand');
                if (!brandSelect) return;

                const brandsSnapshot = await getDocs(collection(db, 'brands'));
                brandSelect.innerHTML = '<option value="">Select Brand</option>';
                
                brandsSnapshot.forEach(doc => {
                    const brand = doc.data();
                    const option = document.createElement('option');
                    option.value = brand.name;
                    option.textContent = brand.name;
                    brandSelect.appendChild(option);
                });
                
                // Add option to enter custom brand
                brandSelect.innerHTML += '<option value="__custom__">+ Enter Custom Brand</option>';
                
                // Handle custom brand selection
                brandSelect.addEventListener('change', function() {
                    if (this.value === '__custom__') {
                        const customBrand = prompt('Enter brand name:');
                        if (customBrand) {
                            // Add custom option temporarily
                            const newOption = document.createElement('option');
                            newOption.value = customBrand;
                            newOption.textContent = customBrand;
                            this.insertBefore(newOption, this.lastElementChild);
                            this.value = customBrand;
                        } else {
                            this.value = '';
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error loading brands:', error);
            }
        }

        // Load subcategories based on selected category
        async function loadSubcategoriesForProduct() {
            try {
                const categorySelect = document.getElementById('productCategory');
                const subcategorySelect = document.getElementById('productSubcategory');
                
                if (!categorySelect || !subcategorySelect) return;
                
                const selectedCategory = categorySelect.value;
                subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
                
                if (!selectedCategory) return;
                
                // Find category ID
                const categoriesSnapshot = await getDocs(collection(db, 'categories'));
                let categoryId = null;
                
                categoriesSnapshot.forEach(doc => {
                    if (doc.data().category === selectedCategory) {
                        categoryId = doc.id;
                    }
                });
                
                if (!categoryId) return;
                
                // Load subcategories for this category
                const subcategoriesQuery = query(
                    collection(db, 'subcategories'),
                    where('category_id', '==', categoryId)
                );
                const subcategoriesSnapshot = await getDocs(subcategoriesQuery);
                
                subcategoriesSnapshot.forEach(doc => {
                    const subcategory = doc.data();
                    const option = document.createElement('option');
                    option.value = subcategory.subcategory;
                    option.textContent = subcategory.subcategory;
                    subcategorySelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading subcategories:', error);
            }
        }

        // Load custom variables for product form
        async function loadCustomVariablesForProduct() {
            try {
                const container = document.getElementById('productVariablesContainer');
                if (!container) return;
                
                const snapshot = await getDocs(collection(db, 'custom_product_variables'));
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-muted">No custom variables available. <a href="#" onclick="showSection(\'product-variables\')">Create some variables</a> first.</p>';
                    return;
                }
                
                let variablesHTML = '<div class="row">';
                
                snapshot.forEach(doc => {
                    const variable = doc.data();
                    const variableId = doc.id;
                    
                    let inputHTML = '';
                    
                    switch (variable.type) {
                        case 'dropdown':
                            inputHTML = `
                                <select class="form-control" id="var_${variableId}" name="variable_${variableId}">
                                    <option value="">Select ${variable.name}</option>
                                    ${variable.possibleValues ? variable.possibleValues.map(value => 
                                        `<option value="${value}">${value}</option>`
                                    ).join('') : ''}
                                </select>
                            `;
                            break;
                        
                        case 'checkbox':
                            inputHTML = `<div class="form-check-group">`;
                            if (variable.possibleValues) {
                                variable.possibleValues.forEach(value => {
                                    inputHTML += `
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                id="var_${variableId}_${value}" name="variable_${variableId}" value="${value}">
                                            <label class="form-check-label" for="var_${variableId}_${value}">
                                                ${value}
                                            </label>
                                        </div>
                                    `;
                                });
                            }
                            inputHTML += `</div>`;
                            break;
                        
                        case 'text':
                            inputHTML = `
                                <input type="text" class="form-control" id="var_${variableId}" 
                                    name="variable_${variableId}" placeholder="Enter ${variable.name}">
                            `;
                            break;
                        
                        case 'number':
                            inputHTML = `
                                <input type="number" class="form-control" id="var_${variableId}" 
                                    name="variable_${variableId}" placeholder="Enter ${variable.name}">
                            `;
                            break;
                        
                        default:
                            inputHTML = `
                                <input type="text" class="form-control" id="var_${variableId}" 
                                    name="variable_${variableId}" placeholder="Enter ${variable.name}">
                            `;
                    }
                    
                    variablesHTML += `
                        <div class="col-md-6 mb-3">
                            <label for="var_${variableId}" class="form-label">
                                ${variable.name}
                                ${variable.isRequired ? ' *' : ''}
                                ${variable.description ? `<small class="text-muted"> - ${variable.description}</small>` : ''}
                            </label>
                            ${inputHTML}
                        </div>
                    `;
                });
                
                variablesHTML += '</div>';
                container.innerHTML = variablesHTML;
                
            } catch (error) {
                console.error('Error loading custom variables:', error);
                const container = document.getElementById('productVariablesContainer');
                if (container) {
                    container.innerHTML = '<p class="text-danger">Error loading variables. Please try again.</p>';
                }
            }
        }

        // Quick add functions for modal
        window.addNewBrand = function() {
            const brandName = prompt('Enter new brand name:');
            if (brandName) {
                // Add to database
                addDoc(collection(db, 'brands'), {
                    name: brandName,
                    isActive: true,
                    createdAt: new Date().toISOString()
                }).then(() => {
                    showToast('Brand added successfully!', 'success');
                    loadBrandsForDropdown();
                }).catch(error => {
                    console.error('Error adding brand:', error);
                    showToast('Error adding brand: ' + error.message, 'error');
                });
            }
        };

        window.addNewCategory = function() {
            const categoryName = prompt('Enter new category name:');
            if (categoryName) {
                const categoryType = prompt('Enter category type (item or service):', 'item');
                if (categoryType && (categoryType === 'item' || categoryType === 'service')) {
                    // Add to database
                    addDoc(collection(db, 'categories'), {
                        category: categoryName,
                        type: categoryType
                    }).then(() => {
                        showToast('Category added successfully!', 'success');
                        loadCategoriesForDropdown();
                    }).catch(error => {
                        console.error('Error adding category:', error);
                        showToast('Error adding category: ' + error.message, 'error');
                    });
                } else {
                    alert('Category type must be either "item" or "service"');
                }
            }
        };

        window.addNewSubcategory = function() {
            const categorySelect = document.getElementById('productCategory');
            if (!categorySelect.value) {
                alert('Please select a category first.');
                return;
            }
            
            const subcategoryName = prompt('Enter new subcategory name:');
            if (subcategoryName) {
                // Find category ID first
                getDocs(collection(db, 'categories')).then(snapshot => {
                    let categoryId = null;
                    snapshot.forEach(doc => {
                        if (doc.data().category === categorySelect.value) {
                            categoryId = doc.id;
                        }
                    });
                    
                    if (categoryId) {
                        addDoc(collection(db, 'subcategories'), {
                            subcategory: subcategoryName,
                            category_id: categoryId
                        }).then(() => {
                            showToast('Subcategory added successfully!', 'success');
                            loadSubcategoriesForProduct();
                        }).catch(error => {
                            console.error('Error adding subcategory:', error);
                            showToast('Error adding subcategory: ' + error.message, 'error');
                        });
                    }
                });
            }
        };
        
        // Brand Management Modal Functions
        function showAddBrandModal() {
            showBrandModal();
        }
        
        function showBrandModal(brandId = null, isEdit = false) {
            const modalTitle = isEdit ? 'Edit Brand' : 'Add New Brand';
            const submitButtonText = isEdit ? 'Update Brand' : 'Create Brand';
            
            const modalContent = `
                <div class="modal fade" id="brandModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-award me-2"></i>${modalTitle}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="brandForm">
                                    <div class="mb-3">
                                        <label for="brandName" class="form-label">Brand Name *</label>
                                        <input type="text" class="form-control" id="brandName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="brandDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="brandDescription" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="brandWebsite" class="form-label">Website URL</label>
                                        <input type="url" class="form-control" id="brandWebsite" placeholder="https://example.com">
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="brandActive" checked>
                                        <label class="form-check-label" for="brandActive">
                                            Active
                                        </label>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="submitBrand('${brandId || ''}')">
                                    <i class="fas fa-save me-2"></i>${submitButtonText}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if present
            const existingModal = document.getElementById('brandModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Insert new modal
            document.body.insertAdjacentHTML('beforeend', modalContent);
            
            // If editing, load brand data
            if (isEdit && brandId) {
                setTimeout(() => {
                    loadBrandForEdit(brandId);
                }, 100);
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('brandModal'));
            modal.show();
        }
        
        async function submitBrand(brandId = '') {
            const form = document.getElementById('brandForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const brandData = {
                name: document.getElementById('brandName').value.trim(),
                description: document.getElementById('brandDescription').value.trim(),
                website: document.getElementById('brandWebsite').value.trim(),
                isActive: document.getElementById('brandActive').checked,
                updatedAt: new Date().toISOString()
            };

            try {
                if (brandId) {
                    // Update existing brand
                    await updateDoc(doc(db, 'brands', brandId), brandData);
                    showToast('Brand updated successfully!', 'success');
                } else {
                    // Create new brand
                    brandData.createdAt = new Date().toISOString();
                    await addDoc(collection(db, 'brands'), brandData);
                    showToast('Brand created successfully!', 'success');
                }

                // Close modal and refresh list
                bootstrap.Modal.getInstance(document.getElementById('brandModal')).hide();
                loadBrands();
            } catch (error) {
                console.error('Error saving brand:', error);
                showToast('Error saving brand: ' + error.message, 'error');
            }
        }
        
        // Subcategory Management Modal Functions
        function showAddSubcategoryModal() {
            showSubcategoryModal();
        }
        
        function showSubcategoryModal(subcategoryId = null, isEdit = false) {
            const modalTitle = isEdit ? 'Edit Subcategory' : 'Add New Subcategory';
            const submitButtonText = isEdit ? 'Update Subcategory' : 'Create Subcategory';
            
            const modalContent = `
                <div class="modal fade" id="subcategoryModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-sitemap me-2"></i>${modalTitle}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="subcategoryForm">
                                    <div class="mb-3">
                                        <label for="subcategoryName" class="form-label">Subcategory Name *</label>
                                        <input type="text" class="form-control" id="subcategoryName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="parentCategory" class="form-label">Parent Category *</label>
                                        <select class="form-control" id="parentCategory" required>
                                            <option value="">Select Parent Category</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="subcategoryDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="subcategoryDescription" rows="3"></textarea>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="subcategoryActive" checked>
                                        <label class="form-check-label" for="subcategoryActive">
                                            Active
                                        </label>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="submitSubcategory('${subcategoryId || ''}')">
                                    <i class="fas fa-save me-2"></i>${submitButtonText}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if present
            const existingModal = document.getElementById('subcategoryModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Insert new modal
            document.body.insertAdjacentHTML('beforeend', modalContent);
            
            // Load categories for dropdown
            setTimeout(() => {
                loadCategoriesForSubcategoryDropdown();
            }, 100);
            
            // If editing, load subcategory data
            if (isEdit && subcategoryId) {
                setTimeout(() => {
                    loadSubcategoryForEdit(subcategoryId);
                }, 200);
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('subcategoryModal'));
            modal.show();
        }
        
        // Product Variable Modal Functions
        function showAddVariableModal() {
            showVariableModal();
        }
        
        function showVariableModal(type = 'color') {
            const modalContent = `
                <div class="modal fade" id="variableModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-palette me-2"></i>Add Product Variable
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="variableType" class="form-label">Variable Type *</label>
                                    <select class="form-control" id="variableType" onchange="updateVariableForm()">
                                        <option value="color">Color</option>
                                        <option value="size">Size</option>
                                        <option value="material">Material</option>
                                        <option value="custom">Custom Variable</option>
                                    </select>
                                </div>
                                <div id="variableFormContent">
                                    <!-- Dynamic form content will be inserted here -->
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="submitVariable()">
                                    <i class="fas fa-save me-2"></i>Create Variable
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if present
            const existingModal = document.getElementById('variableModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Insert new modal
            document.body.insertAdjacentHTML('beforeend', modalContent);
            
            // Initialize form content
            setTimeout(() => {
                updateVariableForm();
            }, 100);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('variableModal'));
            modal.show();
        }
        
        function updateVariableForm() {
            const type = document.getElementById('variableType').value;
            const formContent = document.getElementById('variableFormContent');
            
            switch(type) {
                case 'color':
                    formContent.innerHTML = `
                        <form id="variableForm">
                            <div class="mb-3">
                                <label for="colorName" class="form-label">Color Name *</label>
                                <input type="text" class="form-control" id="colorName" required>
                            </div>
                            <div class="mb-3">
                                <label for="colorHex" class="form-label">Hex Code *</label>
                                <input type="color" class="form-control form-control-color" id="colorHex" required>
                            </div>
                        </form>
                    `;
                    break;
                case 'size':
                    formContent.innerHTML = `
                        <form id="variableForm">
                            <div class="mb-3">
                                <label for="sizeName" class="form-label">Size Name *</label>
                                <input type="text" class="form-control" id="sizeName" required>
                            </div>
                            <div class="mb-3">
                                <label for="sizeCategory" class="form-label">Size Category</label>
                                <select class="form-control" id="sizeCategory">
                                    <option value="">Select Category</option>
                                    <option value="Clothing">Clothing</option>
                                    <option value="Shoes">Shoes</option>
                                    <option value="Electronics">Electronics</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="sizeDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="sizeDescription" rows="2"></textarea>
                            </div>
                        </form>
                    `;
                    break;
                case 'material':
                    formContent.innerHTML = `
                        <form id="variableForm">
                            <div class="mb-3">
                                <label for="materialName" class="form-label">Material Name *</label>
                                <input type="text" class="form-control" id="materialName" required>
                            </div>
                            <div class="mb-3">
                                <label for="materialDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="materialDescription" rows="2"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="materialProperties" class="form-label">Properties (comma-separated)</label>
                                <input type="text" class="form-control" id="materialProperties" placeholder="durable, waterproof, lightweight">
                            </div>
                        </form>
                    `;
                    break;
                case 'custom':
                    formContent.innerHTML = `
                        <form id="variableForm">
                            <div class="mb-3">
                                <label for="customName" class="form-label">Variable Name *</label>
                                <input type="text" class="form-control" id="customName" required>
                            </div>
                            <div class="mb-3">
                                <label for="customType" class="form-label">Variable Type *</label>
                                <select class="form-control" id="customType" required>
                                    <option value="">Select Type</option>
                                    <option value="text">Text</option>
                                    <option value="number">Number</option>
                                    <option value="boolean">Yes/No</option>
                                    <option value="select">Multiple Choice</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="customValues" class="form-label">Possible Values (comma-separated)</label>
                                <input type="text" class="form-control" id="customValues" placeholder="value1, value2, value3">
                                <small class="form-text text-muted">For multiple choice type, enter possible values</small>
                            </div>
                        </form>
                    `;
                    break;
            }
        }
        
        async function submitVariable() {
            const form = document.getElementById('variableForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const type = document.getElementById('variableType').value;
            let collectionName, variableData;

            try {
                switch(type) {
                    case 'color':
                        collectionName = 'product_colors';
                        variableData = {
                            name: document.getElementById('colorName').value.trim(),
                            hexCode: document.getElementById('colorHex').value,
                            createdAt: new Date().toISOString()
                        };
                        break;
                    case 'size':
                        collectionName = 'product_sizes';
                        variableData = {
                            name: document.getElementById('sizeName').value.trim(),
                            category: document.getElementById('sizeCategory').value,
                            description: document.getElementById('sizeDescription').value.trim(),
                            createdAt: new Date().toISOString()
                        };
                        break;
                    case 'material':
                        collectionName = 'product_materials';
                        variableData = {
                            name: document.getElementById('materialName').value.trim(),
                            description: document.getElementById('materialDescription').value.trim(),
                            properties: document.getElementById('materialProperties').value.split(',').map(p => p.trim()).filter(p => p),
                            createdAt: new Date().toISOString()
                        };
                        break;
                    case 'custom':
                        collectionName = 'custom_product_variables';
                        const customName = document.getElementById('customName').value.trim();
                        const customType = document.getElementById('customType').value;
                        const customValues = document.getElementById('customValues').value;
                        
                        if (!customName || !customType) {
                            showToast('Please fill in all required fields for custom variable', 'error');
                            return;
                        }
                        
                        // Check for duplicate custom variable names
                        const existingSnapshot = await getDocs(query(
                            collection(db, 'custom_product_variables'),
                            where('name', '==', customName)
                        ));
                        
                        if (!existingSnapshot.empty) {
                            showToast(`A custom variable named "${customName}" already exists. Please choose a different name.`, 'error');
                            return;
                        }
                        
                        variableData = {
                            name: customName,
                            type: customType,
                            possibleValues: customValues ? customValues.split(',').map(v => v.trim()).filter(v => v) : [],
                            createdAt: new Date().toISOString()
                        };
                        console.log('Creating custom variable with data:', variableData);
                        break;
                    default:
                        showToast('Please select a valid variable type', 'error');
                        return;
                }

                console.log('Creating variable:', { type, collectionName, variableData });
                await addDoc(collection(db, collectionName), variableData);
                showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} variable created successfully!`, 'success');
                
                // Close modal and refresh appropriate list
                bootstrap.Modal.getInstance(document.getElementById('variableModal')).hide();
                
                // Wait a moment before refreshing to ensure modal is closed
                setTimeout(() => {
                    switch(type) {
                        case 'color': loadColors(); break;
                        case 'size': loadSizes(); break;
                        case 'material': loadMaterials(); break;
                        case 'custom': 
                            console.log('💡 Custom variable saved - available in product creation modal');
                            break;
                    }
                }, 500);
                
            } catch (error) {
                console.error('Error saving variable:', error);
                showToast('Error saving variable: ' + error.message, 'error');
            }
        }
        
        async function submitSubcategory(subcategoryId = '') {
            const form = document.getElementById('subcategoryForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const subcategoryData = {
                subcategory: document.getElementById('subcategoryName').value.trim(),
                category_id: document.getElementById('parentCategory').value,
                description: document.getElementById('subcategoryDescription').value.trim(),
                isActive: document.getElementById('subcategoryActive').checked,
                updatedAt: new Date().toISOString()
            };

            try {
                if (subcategoryId) {
                    // Update existing subcategory
                    await updateDoc(doc(db, 'subcategories', subcategoryId), subcategoryData);
                    showToast('Subcategory updated successfully!', 'success');
                } else {
                    // Create new subcategory
                    subcategoryData.createdAt = new Date().toISOString();
                    await addDoc(collection(db, 'subcategories'), subcategoryData);
                    showToast('Subcategory created successfully!', 'success');
                }

                // Close modal and refresh list
                bootstrap.Modal.getInstance(document.getElementById('subcategoryModal')).hide();
                loadSubcategories();
            } catch (error) {
                console.error('Error saving subcategory:', error);
                showToast('Error saving subcategory: ' + error.message, 'error');
            }
        }
        
        async function loadCategoriesForSubcategoryDropdown() {
            try {
                const querySnapshot = await getDocs(collection(db, 'categories'));
                const select = document.getElementById('parentCategory');
                select.innerHTML = '<option value="">Select Parent Category</option>';
                
                querySnapshot.forEach((doc) => {
                    const category = doc.data();
                    select.innerHTML += `<option value="${doc.id}">${category.category}</option>`;
                });
            } catch (error) {
                console.error('Error loading categories for dropdown:', error);
            }
        }
        
        async function loadBrandForEdit(brandId) {
            try {
                const docSnap = await getDoc(doc(db, 'brands', brandId));
                if (docSnap.exists()) {
                    const brand = docSnap.data();
                    document.getElementById('brandName').value = brand.name || '';
                    document.getElementById('brandDescription').value = brand.description || '';
                    document.getElementById('brandWebsite').value = brand.website || '';
                    document.getElementById('brandActive').checked = brand.isActive !== false;
                }
            } catch (error) {
                console.error('Error loading brand for edit:', error);
            }
        }
        
        async function loadSubcategoryForEdit(subcategoryId) {
            try {
                const docSnap = await getDoc(doc(db, 'subcategories', subcategoryId));
                if (docSnap.exists()) {
                    const subcategory = docSnap.data();
                    document.getElementById('subcategoryName').value = subcategory.subcategory || '';
                    document.getElementById('parentCategory').value = subcategory.category_id || '';
                    document.getElementById('subcategoryDescription').value = subcategory.description || '';
                    document.getElementById('subcategoryActive').checked = subcategory.isActive !== false;
                }
            } catch (error) {
                console.error('Error loading subcategory for edit:', error);
            }
        }
        
        function editBrand(id) {
            showBrandModal(id, true);
        }
        
        function editSubcategory(id) {
            showSubcategoryModal(id, true);
        }
        
        function viewBrand(id) {
            // Simple view function - could be expanded to show detailed view
            editBrand(id);
        }
        
        function viewSubcategory(id) {
            // Simple view function - could be expanded to show detailed view
            editSubcategory(id);
        }
        
        async function deleteBrand(id) {
            if (confirm('Are you sure you want to delete this brand? This action cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, 'brands', id));
                    showToast('Brand deleted successfully!', 'success');
                    loadBrands();
                } catch (error) {
                    console.error('Error deleting brand:', error);
                    showToast('Error deleting brand: ' + error.message, 'error');
                }
            }
        }
        
        async function deleteSubcategory(id) {
            if (confirm('Are you sure you want to delete this subcategory? This action cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, 'subcategories', id));
                    showToast('Subcategory deleted successfully!', 'success');
                    loadSubcategories();
                } catch (error) {
                    console.error('Error deleting subcategory:', error);
                    showToast('Error deleting subcategory: ' + error.message, 'error');
                }
            }
        }
        
        async function deleteVariable(type, id) {
            if (confirm(`Are you sure you want to delete this ${type}? This action cannot be undone.`)) {
                try {
                    let collectionName;
                    switch(type) {
                        case 'color': collectionName = 'product_colors'; break;
                        case 'size': collectionName = 'product_sizes'; break;
                        case 'material': collectionName = 'product_materials'; break;
                        case 'custom': collectionName = 'custom_product_variables'; break;
                    }
                    
                    await deleteDoc(doc(db, collectionName, id));
                    showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully!`, 'success');
                    
                    // Refresh appropriate list
                    switch(type) {
                        case 'color': loadColors(); break;
                        case 'size': loadSizes(); break;
                        case 'material': loadMaterials(); break;
                        case 'custom': console.log('💡 Custom variable deleted - updated list available in product creation modal'); break;
                    }
                } catch (error) {
                    console.error(`Error deleting ${type}:`, error);
                    showToast(`Error deleting ${type}: ` + error.message, 'error');
                }
            }
        }
        
        // Variable-specific edit/delete functions
        function editColor(id) {
            // For now, we'll show a simple alert. This could be expanded to show an edit modal
            alert('Edit color functionality coming soon. ID: ' + id);
        }
        
        function deleteColor(id) {
            deleteVariable('color', id);
        }
        
        function editSize(id) {
            alert('Edit size functionality coming soon. ID: ' + id);
        }
        
        function deleteSize(id) {
            deleteVariable('size', id);
        }
        
        function editMaterial(id) {
            alert('Edit material functionality coming soon. ID: ' + id);
        }
        
        function deleteMaterial(id) {
            deleteVariable('material', id);
        }
        
        function editCustomVariable(id) {
            alert('Edit custom variable functionality coming soon. ID: ' + id);
        }
        
        function deleteCustomVariable(id) {
            deleteVariable('custom', id);
        }
        
        function viewBusinessProduct(id) { console.log('View business product:', id); }
        function viewCategory(id) { console.log('View category:', id); }
        function editCategory(id) { 
            showCategoryModal(id, true);
        }
        
        async function deleteCategory(id) {
            // First check if category has products
            try {
                const productsQuery = query(
                    collection(db, 'products'), 
                    where('categoryId', '==', id)
                );
                const productsSnapshot = await getDocs(productsQuery);
                
                if (!productsSnapshot.empty) {
                    showToast('Cannot delete category: It has products assigned to it', 'error');
                    return;
                }
                
                if (confirm('Are you sure you want to delete this category? This action cannot be undone.')) {
                    await deleteDoc(doc(db, 'categories', id));
                    showToast('Category deleted successfully!', 'success');
                    loadCategories(); // Refresh the categories list
                }
            } catch (error) {
                console.error('Error deleting category:', error);
                showToast('Error deleting category: ' + error.message, 'error');
            }
        }

        // Filter functions
        function filterRequests(status) { console.log('Filter requests:', status); }
        // Business products are now displayed in a grouped view without approval system

        // Setup tab listeners for product variables
        function setupProductVariablesTabListeners() {
            // Listen for tab shows
            const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
            tabButtons.forEach(button => {
                button.addEventListener('shown.bs.tab', function(event) {
                    const targetId = event.target.getAttribute('data-bs-target');
                    console.log('Tab shown:', targetId);
                    
                    // Set current section for auto-refresh
                    if (targetId && targetId.includes('product-variables')) {
                        currentSection = 'product-variables';
                    }
                    
                    // Load appropriate data based on the tab
                    switch(targetId) {
                        case '#colors':
                            loadColors();
                            break;
                        case '#sizes':
                            loadSizes();
                            break;
                        case '#materials':
                            loadMaterials();
                            break;
                        case '#custom':
                            console.log('Loading custom variables tab...');
                            loadCustomVariables();
                            break;
                    }
                });
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadCategories().then(() => {
                loadMasterProducts().then(() => {
                    loadBusinesses().then(() => {
                        loadDashboard().then(() => {
                            // Load product variables
                            loadColors();
                            loadSizes();
                            loadMaterials();
                            console.log('💡 Custom variables now managed in product creation modal');
                            
                            // Custom variables no longer need separate testing - integrated into product creation
                            console.log('✅ Variable management system ready for product creation workflow');
                            
                            // Start auto-refresh after initial load
                            startAutoRefresh();
                            showToast('Admin panel loaded successfully', 'success');
                        });
                    });
                });
            });
            
            // Add tab event listeners for product variables
            setupProductVariablesTabListeners();
        });
    </script>
</body>
</html>
