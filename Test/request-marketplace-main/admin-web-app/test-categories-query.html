<!DOCTYPE html>
<html>
<head>
    <title>Test Categories Query</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .section { background: #f9f9f9; border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .error { background: #ffebee; border-color: #f44336; }
        .warning { background: #fff3e0; border-color: #ff9800; }
        .button { padding: 10px 20px; margin: 5px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .button:hover { background: #1976D2; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ Test Flutter Categories Query</h1>
    
    <div class="section">
        <h2>Test the exact query your Flutter app uses:</h2>
        <button class="button" onclick="testFlutterQuery()">
            üß™ Test Flutter Categories Query
        </button>
        <button class="button" onclick="testSimpleQuery()">
            üîç Test Simple Categories Query
        </button>
        <button class="button" onclick="createMissingIndex()">
            üîß Create Missing Index
        </button>
    </div>

    <div id="output" class="section">
        Click "Test Flutter Categories Query" to see if the index issue is resolved...
    </div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyC5hb6Ydkp__EZgX-kRjJgtOKZKg8TNkJg",
            authDomain: "request-marketplace-45a59.firebaseapp.com",
            projectId: "request-marketplace-45a59",
            storageBucket: "request-marketplace-45a59.firebasestorage.app",
            messagingSenderId: "635550436472",
            appId: "1:635550436472:web:72ee20ad95cdcf65c1c86a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        async function testFlutterQuery() {
            document.getElementById('output').innerHTML = 'üß™ Testing Flutter app query...';
            
            try {
                // This is the exact query your Flutter app uses
                const snapshot = await db.collection('product_categories')
                    .where('isActive', '==', true)
                    .get();
                
                let output = '<h2>üß™ Flutter Query Test Results:</h2>';
                
                if (snapshot.empty) {
                    output += `
                        <div class="warning">
                            <h3>‚ö†Ô∏è No Categories Found</h3>
                            <p>The query executed successfully but returned no active categories.</p>
                            <p>This means the index is working, but categories might not be active.</p>
                        </div>
                    `;
                } else {
                    output += `
                        <div class="success">
                            <h3>‚úÖ Query Successful!</h3>
                            <p>Found ${snapshot.size} active categories. Your Flutter app should work now!</p>
                        </div>
                    `;
                    
                    output += '<h3>üìã Categories Found:</h3><ul>';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        output += `
                            <li>
                                <strong>${data.name}</strong> (ID: ${doc.id})
                                <br>Description: ${data.description}
                                <br>Active: ${data.isActive}
                                <br>Created: ${data.createdAt ? data.createdAt.toDate().toLocaleString() : 'Unknown'}
                            </li>
                        `;
                    });
                    output += '</ul>';
                }
                
                document.getElementById('output').innerHTML = output;

            } catch (error) {
                document.getElementById('output').innerHTML = `
                    <div class="error">
                        <h3>‚ùå Query Failed - Index Still Missing</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        
                        <h3>üîß Solution:</h3>
                        <p>The specific index for this query is still being created or missing.</p>
                        <p><strong>Option 1:</strong> Wait 5-10 minutes for Firebase to build the index</p>
                        <p><strong>Option 2:</strong> Click the link below to create the index manually:</p>
                        <a href="https://console.firebase.google.com/v1/r/project/request-marketplace-45a59/firestore/indexes?create_composite=Cl5wcm9kdWN0X2NhdGVnb3JpZXMaDAoIaXNBY3RpdmUQARoOCgpjcmVhdGVkQXQQAhqFAShjb3VudCBvZiBwcm9kdWN0X2NhdGVnb3JpZXMgaW5kZXhlcyBmaWx0ZXJlZCBieSBpc0FjdGl2ZSBhbmQgc29ydGVkIGJ5IGNyZWF0ZWRBdCBkZXNjZW5kaW5n" 
                           target="_blank" style="color: blue; text-decoration: underline;">
                            üîó Create Index in Firebase Console
                        </a>
                        
                        <h3>üîß Alternative:</h3>
                        <p>Click "Create Missing Index" button below to create a minimal index.</p>
                    </div>
                `;
                console.error('Query error:', error);
            }
        }

        async function testSimpleQuery() {
            document.getElementById('output').innerHTML = 'üîç Testing simple query...';
            
            try {
                // Simple query without complex filtering
                const snapshot = await db.collection('product_categories').get();
                
                let output = '<h2>üîç Simple Query Results:</h2>';
                output += `<p>Total categories in collection: ${snapshot.size}</p>`;
                
                if (snapshot.empty) {
                    output += `
                        <div class="error">
                            <h3>‚ùå No Categories Found</h3>
                            <p>The product_categories collection is empty!</p>
                        </div>
                    `;
                } else {
                    output += '<h3>üìã All Categories (Active & Inactive):</h3><ul>';
                    
                    let activeCount = 0;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.isActive) activeCount++;
                        
                        output += `
                            <li>
                                <strong>${data.name}</strong> (ID: ${doc.id})
                                <br>Active: <span style="color: ${data.isActive ? 'green' : 'red'};">${data.isActive}</span>
                                <br>Description: ${data.description}
                            </li>
                        `;
                    });
                    output += '</ul>';
                    
                    output += `<p><strong>Active categories:</strong> ${activeCount} of ${snapshot.size}</p>`;
                    
                    if (activeCount === 0) {
                        output += `
                            <div class="warning">
                                <h3>‚ö†Ô∏è No Active Categories</h3>
                                <p>Categories exist but none are active. Activate them first!</p>
                            </div>
                        `;
                    }
                }
                
                document.getElementById('output').innerHTML = output;

            } catch (error) {
                document.getElementById('output').innerHTML = `
                    <div class="error">
                        <h3>‚ùå Simple Query Failed:</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function createMissingIndex() {
            document.getElementById('output').innerHTML = 'üîß Creating minimal index...';
            
            // We can't actually create indexes programmatically, but we can guide the user
            let output = `
                <h2>üîß Index Creation Guide:</h2>
                
                <div class="section">
                    <h3>üìã Required Index for Flutter App:</h3>
                    <p><strong>Collection:</strong> product_categories</p>
                    <p><strong>Fields:</strong></p>
                    <ul>
                        <li>isActive (Ascending)</li>
                        <li>__name__ (Ascending) - Optional</li>
                    </ul>
                </div>
                
                <div class="section">
                    <h3>üöÄ Quick Solutions:</h3>
                    
                    <h4>Option 1: Use Firebase Console Link</h4>
                    <p>The error message in your Flutter app contains a direct link to create the index.</p>
                    <p>Copy and paste this URL in a new tab:</p>
                    <code style="background: #f0f0f0; padding: 5px; border-radius: 3px; display: block; margin: 10px 0; word-break: break-all;">
                        https://console.firebase.google.com/v1/r/project/request-marketplace-45a59/firestore/indexes?create_composite=Cl5wcm9kdWN0X2NhdGVnb3JpZXMaDAoIaXNBY3RpdmUQARoOCgpjcmVhdGVkQXQQAhqFAShjb3VudCBvZiBwcm9kdWN0X2NhdGVnb3JpZXMgaW5kZXhlcyBmaWx0ZXJlZCBieSBpc0FjdGl2ZSBhbmQgc29ydGVkIGJ5IGNyZWF0ZWRBdCBkZXNjZW5kaW5n
                    </code>
                    
                    <h4>Option 2: Manual Creation</h4>
                    <ol>
                        <li>Go to <a href="https://console.firebase.google.com/project/request-marketplace-45a59/firestore/indexes" target="_blank">Firebase Console > Firestore > Indexes</a></li>
                        <li>Click "Create Index"</li>
                        <li>Collection ID: <code>product_categories</code></li>
                        <li>Add field: <code>isActive</code> (Ascending)</li>
                        <li>Click "Create"</li>
                    </ol>
                    
                    <h4>Option 3: Wait</h4>
                    <p>Firebase might still be building the index from our recent deployment. Wait 5-10 minutes and try again.</p>
                </div>
                
                <div class="section">
                    <h3>üß™ Test After Index Creation:</h3>
                    <p>After creating the index, click "Test Flutter Categories Query" again to verify it works.</p>
                </div>
            `;
            
            document.getElementById('output').innerHTML = output;
        }

        // Auto-test on page load
        window.addEventListener('load', () => {
            setTimeout(testSimpleQuery, 1000);
        });
    </script>
</body>
</html>
