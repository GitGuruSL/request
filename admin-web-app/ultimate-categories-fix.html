<!DOCTYPE html>
<html>
<head>
    <title>Ultimate Categories Fix</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
        .section { background: #f9f9f9; border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .error { background: #ffebee; border-color: #f44336; }
        .warning { background: #fff3e0; border-color: #ff9800; }
        .info { background: #e3f2fd; border-color: #2196f3; }
        .button { padding: 12px 24px; margin: 5px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .button:hover { background: #1976D2; }
        .create-btn { background: #4CAF50; }
        .create-btn:hover { background: #45a049; }
        .fix-btn { background: #FF5722; }
        .fix-btn:hover { background: #E64A19; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .step { background: #fff; border-left: 4px solid #2196F3; padding: 15px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üéØ Ultimate "Add Product" Categories Fix</h1>
    
    <div class="section info">
        <h2>üö® Final Solution for Add Product Issue</h2>
        <p>Since we can't find existing categories, we'll create fresh ones in the correct location.</p>
        <p><strong>This will create the exact categories your Flutter app needs!</strong></p>
    </div>

    <div class="section">
        <h2>üöÄ Quick Actions:</h2>
        <button class="button create-btn" onclick="createCategoriesForFlutter()">
            ‚úÖ CREATE CATEGORIES FOR FLUTTER APP
        </button>
        <button class="button" onclick="deepScanFirestore()">
            üîç Deep Scan All Collections
        </button>
        <button class="button" onclick="testFlutterAppRequirements()">
            üì± Test Flutter App Requirements
        </button>
    </div>

    <div id="output" class="section">
        Ready to fix your "Add Product" issue! Click the green button above.
    </div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyC5hb6Ydkp__EZgX-kRjJgtOKZKg8TNkJg",
            authDomain: "request-marketplace-45a59.firebaseapp.com",
            projectId: "request-marketplace-45a59",
            storageBucket: "request-marketplace-45a59.firebasestorage.app",
            messagingSenderId: "635550436472",
            appId: "1:635550436472:web:72ee20ad95cdcf65c1c86a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        async function createCategoriesForFlutter() {
            document.getElementById('output').innerHTML = 'üöÄ Creating categories for Flutter app...';
            
            // Categories with proper structure for Flutter app
            const categories = [
                { 
                    id: 'electronics', 
                    name: 'Electronics', 
                    description: 'Electronic devices, smartphones, computers, and accessories' 
                },
                { 
                    id: 'fashion', 
                    name: 'Fashion', 
                    description: 'Clothing, shoes, accessories, and fashion items' 
                },
                { 
                    id: 'home-garden', 
                    name: 'Home & Garden', 
                    description: 'Home improvement and gardening supplies' 
                },
                { 
                    id: 'automotive', 
                    name: 'Automotive', 
                    description: 'Car parts, accessories, and automotive supplies' 
                },
                { 
                    id: 'sports', 
                    name: 'Sports', 
                    description: 'Sports equipment and recreational items' 
                },
                { 
                    id: 'books', 
                    name: 'Books', 
                    description: 'Books, educational materials, and literature' 
                },
                { 
                    id: 'health', 
                    name: 'Health & Beauty', 
                    description: 'Health, beauty, and personal care products' 
                },
                { 
                    id: 'food', 
                    name: 'Food & Beverages', 
                    description: 'Food items, beverages, and grocery products' 
                }
            ];

            try {
                let output = '<h2>üöÄ Creating Categories for Flutter App:</h2>';
                
                // Create in batches for reliability
                const batch = db.batch();
                
                output += '<div class="step"><h3>Step 1: Preparing Categories</h3><ul>';
                
                categories.forEach(category => {
                    const categoryData = {
                        name: category.name,
                        description: category.description,
                        isActive: true,
                        createdAt: firebase.firestore.Timestamp.now(),
                        updatedAt: firebase.firestore.Timestamp.now(),
                        // Additional fields for Flutter app compatibility
                        productCount: 0,
                        imageUrl: null
                    };
                    
                    const docRef = db.collection('product_categories').doc(category.id);
                    batch.set(docRef, categoryData);
                    
                    output += `<li>‚úÖ Prepared: <strong>${category.name}</strong> (ID: ${category.id})</li>`;
                });
                
                output += '</ul></div>';
                
                output += '<div class="step"><h3>Step 2: Saving to Firestore</h3><p>Writing to product_categories collection...</p></div>';
                
                // Commit the batch
                await batch.commit();
                
                output += '<div class="step"><h3>Step 3: Verification</h3>';
                
                // Verify the creation
                const verifySnapshot = await db.collection('product_categories').get();
                const activeCategories = verifySnapshot.docs.filter(doc => doc.data().isActive === true);
                
                output += `<p>‚úÖ Total categories created: <strong>${verifySnapshot.size}</strong></p>`;
                output += `<p>‚úÖ Active categories: <strong>${activeCategories.length}</strong></p>`;
                
                output += '<h4>Created Categories:</h4><ul>';
                verifySnapshot.forEach(doc => {
                    const data = doc.data();
                    output += `<li><strong>${data.name}</strong> - Active: ${data.isActive} - ID: ${doc.id}</li>`;
                });
                output += '</ul></div>';
                
                output += `
                    <div class="success">
                        <h2>üéâ SUCCESS! Categories Created Successfully!</h2>
                        <p><strong>‚úÖ Created ${categories.length} categories in 'product_categories' collection</strong></p>
                        <p><strong>‚úÖ All categories are set to isActive: true</strong></p>
                        <p><strong>‚úÖ Flutter app can now load categories</strong></p>
                        <p><strong>‚úÖ "Add Product" feature should now work!</strong></p>
                        
                        <h3>üöÄ Next Steps:</h3>
                        <ol>
                            <li>Open your Flutter app</li>
                            <li>Navigate to "Add Product" section</li>
                            <li>Categories should now appear in the dropdown</li>
                            <li>You can now add products successfully!</li>
                        </ol>
                    </div>
                `;

                document.getElementById('output').innerHTML = output;

            } catch (error) {
                document.getElementById('output').innerHTML = `
                    <div class="error">
                        <h3>‚ùå Error creating categories:</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <pre>${error.stack}</pre>
                        
                        <h3>üîß Troubleshooting:</h3>
                        <p>1. Check your internet connection</p>
                        <p>2. Verify Firebase project settings</p>
                        <p>3. Check Firestore security rules</p>
                    </div>
                `;
                console.error('Error creating categories:', error);
            }
        }

        async function deepScanFirestore() {
            document.getElementById('output').innerHTML = 'üîç Deep scanning Firestore...';
            
            try {
                let output = '<h2>üîç Deep Firestore Scan Results:</h2>';
                
                // List all possible collection names
                const collectionsToScan = [
                    'product_categories', 'categories', 'productCategories',
                    'master_products', 'masterProducts', 'products',
                    'business_products', 'businessProducts',
                    'businesses', 'users', 'drivers', 'requests'
                ];
                
                let foundData = false;
                
                for (const collectionName of collectionsToScan) {
                    try {
                        const snapshot = await db.collection(collectionName).limit(5).get();
                        
                        if (!snapshot.empty) {
                            foundData = true;
                            output += `
                                <div class="section">
                                    <h3>üìÇ ${collectionName} (${snapshot.size}+ documents)</h3>
                                    <details>
                                        <summary>Sample documents</summary>
                                        <pre>${JSON.stringify(snapshot.docs.map(doc => ({id: doc.id, data: doc.data()})), null, 2)}</pre>
                                    </details>
                                </div>
                            `;
                        }
                    } catch (error) {
                        // Collection doesn't exist, skip
                    }
                }
                
                if (!foundData) {
                    output += `
                        <div class="warning">
                            <h3>‚ö†Ô∏è No collections found!</h3>
                            <p>Your Firestore database appears to be completely empty.</p>
                            <p>This explains why the Flutter app can't find categories.</p>
                        </div>
                    `;
                }
                
                document.getElementById('output').innerHTML = output;
                
            } catch (error) {
                document.getElementById('output').innerHTML = `
                    <div class="error">
                        <h3>‚ùå Scan Error:</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testFlutterAppRequirements() {
            document.getElementById('output').innerHTML = 'üì± Testing Flutter app requirements...';
            
            try {
                let output = '<h2>üì± Flutter App Requirements Test:</h2>';
                
                // Test 1: Check product_categories collection
                output += '<div class="step"><h3>Test 1: product_categories Collection</h3>';
                
                const categoriesSnapshot = await db.collection('product_categories')
                    .where('isActive', '==', true)
                    .get();
                
                if (categoriesSnapshot.empty) {
                    output += '<p>‚ùå <strong>FAIL:</strong> No active categories found</p>';
                    output += '<p>Flutter app query: <code>collection("product_categories").where("isActive", "==", true)</code></p>';
                } else {
                    output += `<p>‚úÖ <strong>PASS:</strong> Found ${categoriesSnapshot.size} active categories</p>`;
                    categoriesSnapshot.forEach(doc => {
                        const data = doc.data();
                        output += `<p>  ‚Ä¢ ${data.name} (${doc.id})</p>`;
                    });
                }
                output += '</div>';
                
                // Test 2: Check master_products collection
                output += '<div class="step"><h3>Test 2: master_products Collection</h3>';
                
                const productsSnapshot = await db.collection('master_products')
                    .where('isActive', '==', true)
                    .get();
                
                if (productsSnapshot.empty) {
                    output += '<p>‚ö†Ô∏è <strong>WARNING:</strong> No master products found</p>';
                    output += '<p>You may want to create some master products for businesses to add pricing to.</p>';
                } else {
                    output += `<p>‚úÖ <strong>INFO:</strong> Found ${productsSnapshot.size} master products</p>`;
                }
                output += '</div>';
                
                // Summary
                if (categoriesSnapshot.size > 0) {
                    output += `
                        <div class="success">
                            <h3>‚úÖ Flutter App Requirements: SATISFIED</h3>
                            <p>Your Flutter app should be able to load categories and work properly!</p>
                        </div>
                    `;
                } else {
                    output += `
                        <div class="error">
                            <h3>‚ùå Flutter App Requirements: NOT MET</h3>
                            <p>Click "CREATE CATEGORIES FOR FLUTTER APP" to fix this.</p>
                        </div>
                    `;
                }
                
                document.getElementById('output').innerHTML = output;
                
            } catch (error) {
                document.getElementById('output').innerHTML = `
                    <div class="error">
                        <h3>‚ùå Test Error:</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
