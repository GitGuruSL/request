<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleanup Duplicate Variables</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            deleteDoc, 
            doc,
            addDoc,
            query,
            where,
            orderBy
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBhz3Bh9BM87p5xJBhvCdOTITVTfBE-44k",
            authDomain: "request-marketplace-89dd4.firebaseapp.com",
            projectId: "request-marketplace-89dd4",
            storageBucket: "request-marketplace-89dd4.firebasestorage.app",
            messagingSenderId: "704374194045",
            appId: "1:704374194045:web:fd48b83d17df80cea44bb4",
            measurementId: "G-58JQ3SN8GB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.collection = collection;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.addDoc = addDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;

        // Make functions available globally
        window.cleanupDuplicateVariables = cleanupDuplicateVariables;
        window.showVariables = showVariables;

        async function showVariables() {
            try {
                console.log('=== Current Custom Variables ===');
                const snapshot = await getDocs(collection(db, 'custom_product_variables'));
                
                const variables = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    variables.push({
                        id: doc.id,
                        name: data.name,
                        type: data.type,
                        possibleValues: data.possibleValues,
                        createdAt: data.createdAt
                    });
                    console.log(`ID: ${doc.id}, Name: ${data.name}, Type: ${data.type}, Values: ${JSON.stringify(data.possibleValues)}, Created: ${data.createdAt}`);
                });
                
                console.log(`Total variables: ${variables.length}`);
                
                // Show duplicates
                const nameCounts = {};
                variables.forEach(v => {
                    nameCounts[v.name] = (nameCounts[v.name] || 0) + 1;
                });
                
                console.log('\n=== Duplicate Analysis ===');
                Object.entries(nameCounts).forEach(([name, count]) => {
                    if (count > 1) {
                        console.log(`âš ï¸  "${name}" appears ${count} times`);
                    }
                });
                
                return variables;
            } catch (error) {
                console.error('Error showing variables:', error);
            }
        }

        async function cleanupDuplicateVariables() {
            try {
                console.log('ðŸ”„ Starting cleanup of duplicate custom variables...');
                
                // Get all custom variables
                const snapshot = await getDocs(collection(db, 'custom_product_variables'));
                const variables = [];
                
                snapshot.forEach(doc => {
                    variables.push({
                        id: doc.id,
                        data: doc.data()
                    });
                });
                
                console.log(`Found ${variables.length} custom variables`);
                
                // Group by name to find duplicates
                const grouped = {};
                variables.forEach(variable => {
                    const name = variable.data.name;
                    if (!grouped[name]) {
                        grouped[name] = [];
                    }
                    grouped[name].push(variable);
                });
                
                let deletedCount = 0;
                
                // For each group, keep the first one and delete the rest
                for (const [name, group] of Object.entries(grouped)) {
                    if (group.length > 1) {
                        console.log(`\nðŸ” Found ${group.length} duplicates for "${name}"`);
                        
                        // Sort by creation date, keep the oldest
                        group.sort((a, b) => {
                            const dateA = new Date(a.data.createdAt || 0);
                            const dateB = new Date(b.data.createdAt || 0);
                            return dateA - dateB;
                        });
                        
                        console.log(`âœ… Keeping: ${group[0].id} (created: ${group[0].data.createdAt})`);
                        
                        // Delete duplicates (all except the first one)
                        for (let i = 1; i < group.length; i++) {
                            const duplicate = group[i];
                            console.log(`ðŸ—‘ï¸  Deleting: ${duplicate.id} (created: ${duplicate.data.createdAt})`);
                            await deleteDoc(doc(db, 'custom_product_variables', duplicate.id));
                            deletedCount++;
                        }
                    }
                }
                
                console.log(`\nâœ… Cleanup complete! Deleted ${deletedCount} duplicate variables.`);
                
                // Show updated list
                await showVariables();
                
            } catch (error) {
                console.error('âŒ Error cleaning up duplicates:', error);
            }
        }

        // Auto-run on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ðŸ”§ Custom Variables Cleanup Tool');
            console.log('ðŸ“‹ Use showVariables() to see all variables');
            console.log('ðŸ§¹ Use cleanupDuplicateVariables() to remove duplicates');
            
            await showVariables();
        });
    </script>
</head>
<body>
    <div style="padding: 20px; font-family: Arial, sans-serif;">
        <h1>Custom Variables Cleanup Tool</h1>
        <p>Open the browser console to see the analysis and run cleanup commands.</p>
        
        <div style="margin: 20px 0;">
            <button onclick="showVariables()" style="padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px;">
                Show All Variables
            </button>
            <button onclick="cleanupDuplicateVariables()" style="padding: 10px 20px; margin: 5px; background: #dc3545; color: white; border: none; border-radius: 5px;">
                Cleanup Duplicates
            </button>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
            <h3>Instructions:</h3>
            <ol>
                <li>Open the browser console (F12 â†’ Console tab)</li>
                <li>Click "Show All Variables" or run <code>showVariables()</code> to see current state</li>
                <li>Click "Cleanup Duplicates" or run <code>cleanupDuplicateVariables()</code> to remove duplicates</li>
                <li>The tool will keep the oldest version of each duplicate variable</li>
            </ol>
        </div>
    </div>
</body>
</html>
