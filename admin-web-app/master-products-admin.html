<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Products Management - Request Marketplace</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            height: 100vh;
            background: linear-gradient(145deg, #667eea 0%, #764ba2 100%);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }
        .main-content {
            margin-left: 250px;
            background-color: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .nav-link {
            color: white !important;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 2px 10px;
            transition: all 0.3s ease;
        }
        .nav-link:hover, .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: white !important;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-active { background-color: #d4edda; color: #155724; }
        .status-inactive { background-color: #f8d7da; color: #721c24; }
        .btn-action {
            padding: 5px 10px;
            margin: 2px;
            border-radius: 5px;
        }
        .product-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
        }
        .variables-display {
            max-width: 200px;
            word-break: break-word;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Sidebar -->
    <div class="sidebar text-white" style="width: 250px;">
        <div class="p-3">
            <h4><i class="fas fa-store me-2"></i>Product Admin</h4>
        </div>
        <nav class="nav flex-column mt-3">
            <a class="nav-link active" href="#" onclick="showSection('products')">
                <i class="fas fa-box me-2"></i>Master Products
            </a>
            <a class="nav-link" href="#" onclick="showSection('business-listings')">
                <i class="fas fa-store me-2"></i>Business Listings
            </a>
            <a class="nav-link" href="#" onclick="showSection('categories')">
                <i class="fas fa-tags me-2"></i>Categories
            </a>
            <a class="nav-link" href="#" onclick="showSection('brands')">
                <i class="fas fa-trademark me-2"></i>Brands
            </a>
            <a class="nav-link" href="#" onclick="showSection('variables')">
                <i class="fas fa-sliders-h me-2"></i>Product Variables
            </a>
            <hr class="border-light">
            <a class="nav-link" href="complete-admin.html">
                <i class="fas fa-arrow-left me-2"></i>Back to Main Admin
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Master Products Section -->
        <div id="products-section" class="section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-box me-2"></i>Master Products Management</h2>
                <div>
                    <button class="btn btn-success" onclick="exportProducts()">
                        <i class="fas fa-download me-2"></i>Export CSV
                    </button>
                    <button class="btn btn-primary" onclick="showAddProductModal()">
                        <i class="fas fa-plus me-2"></i>Add Product
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Search</label>
                            <input type="text" id="searchFilter" class="form-control" placeholder="Search products..." onkeyup="filterProducts()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Category</label>
                            <select id="categoryFilter" class="form-select" onchange="filterProducts()">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Brand</label>
                            <select id="brandFilter" class="form-select" onchange="filterProducts()">
                                <option value="">All Brands</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Status</label>
                            <select id="statusFilter" class="form-select" onchange="filterProducts()">
                                <option value="">All Status</option>
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                                <i class="fas fa-times me-1"></i>Clear Filters
                            </button>
                            <span class="ms-3 text-muted" id="productCount">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Image</th>
                                    <th>Product Name</th>
                                    <th>Brand</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Business Listings</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTable">
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <div class="mt-2">Loading products...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Business Listings Section -->
        <div id="business-listings-section" class="section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-store me-2"></i>Business Product Listings</h2>
                <div>
                    <button class="btn btn-outline-secondary" onclick="loadBusinessListings()">
                        <i class="fas fa-sync me-2"></i>Refresh
                    </button>
                    <button class="btn btn-success" onclick="exportBusinessListings()">
                        <i class="fas fa-download me-2"></i>Export CSV
                    </button>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Search Business/Product</label>
                            <input type="text" id="businessSearchFilter" class="form-control" placeholder="Search..." onkeyup="filterBusinessListings()">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Category</label>
                            <select id="businessCategoryFilter" class="form-select" onchange="filterBusinessListings()">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Status</label>
                            <select id="businessStatusFilter" class="form-select" onchange="filterBusinessListings()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Price Range</label>
                            <select id="priceRangeFilter" class="form-select" onchange="filterBusinessListings()">
                                <option value="">All Ranges</option>
                                <option value="0-100">$0 - $100</option>
                                <option value="100-500">$100 - $500</option>
                                <option value="500-1000">$500 - $1000</option>
                                <option value="1000+">$1000+</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearBusinessFilters()">
                                    <i class="fas fa-times me-1"></i>Clear Filters
                                </button>
                                <span class="align-self-center text-muted" id="businessListingsCount">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Business Listings Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Business</th>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Variables</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="businessListingsTable">
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <div class="mt-2">Loading business listings...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories Section -->
        <div id="categories-section" class="section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-tags me-2"></i>Categories Management</h2>
                <button class="btn btn-primary" onclick="showAddCategoryModal()">
                    <i class="fas fa-plus me-2"></i>Add Category
                </button>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Category Name</th>
                                    <th>Description</th>
                                    <th>Products Count</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="categoriesTable">
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <div class="mt-2">Loading categories...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
                                <tr>
                                    <th>Category Name</th>
                                    <th>Description</th>
                                    <th>Products Count</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="categoriesTable">
                                <tr>
                                    <td colspan="4" class="text-center py-4">Loading categories...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Brands Section -->
        <div id="brands-section" class="section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-trademark me-2"></i>Brands Management</h2>
                <button class="btn btn-primary" onclick="showAddBrandModal()">
                    <i class="fas fa-plus me-2"></i>Add Brand
                </button>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Brand Name</th>
                                    <th>Description</th>
                                    <th>Products Count</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="brandsTable">
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <div class="mt-2">Loading brands...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Variables Section -->
        <div id="variables-section" class="section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-sliders-h me-2"></i>Product Variables Management</h2>
                <button class="btn btn-primary" onclick="showAddVariableModal()">
                    <i class="fas fa-plus me-2"></i>Add Variable
                </button>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Variable Name</th>
                                    <th>Category</th>
                                    <th>Values</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="variablesTable">
                                <tr>
                                    <td colspan="4" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <div class="mt-2">Loading variables...</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Add Master Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="productForm">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Product Name *</label>
                                <input type="text" id="productName" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Brand *</label>
                                <input type="text" id="productBrand" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Category *</label>
                                <select id="productCategory" class="form-select" required onchange="loadSubcategories(this.value)">
                                    <option value="">Select Category</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Subcategory</label>
                                <select id="productSubcategory" class="form-select">
                                    <option value="">Select Subcategory (Optional)</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea id="productDescription" class="form-control" rows="3"></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Keywords (comma-separated)</label>
                                <input type="text" id="productKeywords" class="form-control" placeholder="smartphone, apple, iphone">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Product Images</label>
                                <div class="mb-2">
                                    <input type="file" id="productImageFiles" class="form-control" accept="image/*" multiple>
                                    <small class="form-text text-muted">Upload product images (PNG, JPG, GIF)</small>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Or provide Image URLs (one per line)</label>
                                    <textarea id="productImages" class="form-control" rows="3" placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.jpg"></textarea>
                                </div>
                                <div id="uploadProgress" class="progress mb-2" style="display: none;">
                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <div id="uploadedImages" class="d-flex flex-wrap gap-2"></div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Available Variables</label>
                                <div class="card">
                                    <div class="card-header py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">Define product variations like color, size, memory, etc.</small>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addVariableField()">
                                                <i class="fas fa-plus me-1"></i>Add Variable
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body" id="variablesContainer">
                                        <!-- Dynamic variable fields will be added here -->
                                    </div>
                                </div>
                                <textarea id="productVariables" class="form-control d-none" rows="4" placeholder='{"color": ["Red", "Blue", "Green"], "size": ["Small", "Medium", "Large"]}'></textarea>
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input type="checkbox" id="productActive" class="form-check-input" checked>
                                    <label class="form-check-label" for="productActive">
                                        Active (visible to businesses for price listings)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Save Product
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            doc, 
            getDoc,
            query,
            where,
            orderBy,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL,
            uploadBytesResumable
        } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBtVBUgOhjGb_7DaCZCeUVCHpSsKoOAKOo",
            authDomain: "request-marketplace.firebaseapp.com",
            projectId: "request-marketplace",
            storageBucket: "request-marketplace.firebasestorage.app",
            messagingSenderId: "1058542395901",
            appId: "1:1058542395901:web:8c7faca6d3b0b14a7bb32e"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Global variables
        window.db = db;
        window.collection = collection;
        window.getDocs = getDocs;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.getDoc = getDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.serverTimestamp = serverTimestamp;

        // Data storage
        let masterProducts = [];
        let categories = [];
        let brands = [];
        let productVariables = [];
        let currentEditingProduct = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
        });

        // Load all data
        async function loadAllData() {
            try {
                await Promise.all([
                    loadMasterProducts(),
                    loadCategories(),
                    loadBrands(),
                    loadProductVariables()
                ]);
                populateFilters();
                
                // Create sample products if none exist
                if (masterProducts.length === 0) {
                    showCreateSampleProductsPrompt();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error loading data: ' + error.message, 'error');
            }
        }

        // Load master products
        async function loadMasterProducts() {
            try {
                const snapshot = await getDocs(collection(db, 'master_products'));
                masterProducts = [];
                
                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    const product = {
                        id: doc.id,
                        ...data
                    };
                    
                    // Count business listings
                    const listingsQuery = query(
                        collection(db, 'price_listings'),
                        where('masterProductId', '==', doc.id)
                    );
                    const listingsSnapshot = await getDocs(listingsQuery);
                    product.businessListingsCount = listingsSnapshot.size;
                    
                    masterProducts.push(product);
                }
                
                displayProducts();
                updateProductCount();
            } catch (error) {
                console.error('Error loading master products:', error);
                showToast('Error loading products: ' + error.message, 'error');
            }
        }

        // Display products in table
        function displayProducts() {
            const tbody = document.getElementById('productsTable');
            tbody.innerHTML = '';

            if (masterProducts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-box fa-3x mb-3"></i>
                                <div class="mb-3">No products found</div>
                                <button class="btn btn-primary btn-sm me-2" onclick="showAddProductModal()">
                                    <i class="fas fa-plus me-1"></i>Add First Product
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="createSampleProducts()">
                                    <i class="fas fa-magic me-1"></i>Create Sample Products
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            for (const product of masterProducts) {
                const imageUrl = product.images && product.images.length > 0 
                    ? product.images[0] 
                    : 'https://via.placeholder.com/50?text=No+Image';
                
                const variablesDisplay = product.availableVariables 
                    ? Object.keys(product.availableVariables).join(', ')
                    : 'None';

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>
                        <img src="${imageUrl}" alt="${product.name}" class="product-image" onerror="this.src='https://via.placeholder.com/50?text=Error'">
                    </td>
                    <td>
                        <div class="fw-bold">${product.name}</div>
                        <small class="text-muted">${product.description || 'No description'}</small>
                    </td>
                    <td>${product.brand}</td>
                    <td>${product.category}</td>
                    <td>
                        <div class="variables-display">${variablesDisplay}</div>
                    </td>
                    <td>
                        <span class="status-badge ${product.isActive ? 'status-active' : 'status-inactive'}">
                            ${product.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-primary">${product.businessListingsCount || 0}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary btn-action" onclick="viewProduct('${product.id}')" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning btn-action" onclick="editProduct('${product.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteProduct('${product.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info btn-action" onclick="toggleProductStatus('${product.id}')" title="${product.isActive ? 'Deactivate' : 'Activate'}">
                            <i class="fas fa-power-off"></i>
                        </button>
                    </td>
                `;
            }
        }

        // Load categories
        async function loadCategories() {
            try {
                const snapshot = await getDocs(collection(db, 'categories'));
                categories = [];
                snapshot.forEach(doc => {
                    categories.push({ id: doc.id, ...doc.data() });
                });
                populateCategoryDropdowns();
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Load brands  
        async function loadBrands() {
            try {
                const snapshot = await getDocs(collection(db, 'brands'));
                brands = [];
                snapshot.forEach(doc => {
                    brands.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Error loading brands:', error);
            }
        }

        // Load product variables
        async function loadProductVariables() {
            try {
                const snapshot = await getDocs(collection(db, 'custom_product_variables'));
                productVariables = [];
                snapshot.forEach(doc => {
                    productVariables.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Error loading product variables:', error);
            }
        }

        // Populate filter dropdowns
        function populateFilters() {
            // Category filter
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            const uniqueCategories = [...new Set(masterProducts.map(p => p.category))].sort();
            uniqueCategories.forEach(category => {
                if (category) {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                }
            });

            // Brand filter
            const brandFilter = document.getElementById('brandFilter');
            brandFilter.innerHTML = '<option value="">All Brands</option>';
            const uniqueBrands = [...new Set(masterProducts.map(p => p.brand))].sort();
            uniqueBrands.forEach(brand => {
                if (brand) {
                    const option = document.createElement('option');
                    option.value = brand;
                    option.textContent = brand;
                    brandFilter.appendChild(option);
                }
            });
        }

        // Populate category dropdowns in modals
        function populateCategoryDropdowns() {
            const productCategory = document.getElementById('productCategory');
            if (productCategory) {
                productCategory.innerHTML = '<option value="">Select Category</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.category;
                    option.textContent = category.category;
                    productCategory.appendChild(option);
                });
            }
        }

        // Load subcategories for selected category
        window.loadSubcategories = async function(categoryName) {
            const subcategorySelect = document.getElementById('productSubcategory');
            subcategorySelect.innerHTML = '<option value="">Loading subcategories...</option>';
            
            if (!categoryName) {
                subcategorySelect.innerHTML = '<option value="">Select Subcategory (Optional)</option>';
                return;
            }

            try {
                // Get unique subcategories from existing products in this category
                const subcategories = [...new Set(
                    masterProducts
                        .filter(p => p.category === categoryName && p.subcategory)
                        .map(p => p.subcategory)
                        .filter(s => s && s.trim())
                )].sort();

                subcategorySelect.innerHTML = '<option value="">Select Subcategory (Optional)</option>';
                
                subcategories.forEach(subcategory => {
                    const option = document.createElement('option');
                    option.value = subcategory;
                    option.textContent = subcategory;
                    subcategorySelect.appendChild(option);
                });

                // Add option to create new subcategory
                if (subcategories.length > 0) {
                    const separator = document.createElement('option');
                    separator.disabled = true;
                    separator.textContent = '──────────────';
                    subcategorySelect.appendChild(separator);
                }

                const newOption = document.createElement('option');
                newOption.value = 'NEW_SUBCATEGORY';
                newOption.textContent = '+ Create New Subcategory';
                subcategorySelect.appendChild(newOption);

                // Handle new subcategory creation
                subcategorySelect.addEventListener('change', function(e) {
                    if (e.target.value === 'NEW_SUBCATEGORY') {
                        const newSubcategory = prompt('Enter new subcategory name:');
                        if (newSubcategory && newSubcategory.trim()) {
                            const newOption = document.createElement('option');
                            newOption.value = newSubcategory.trim();
                            newOption.textContent = newSubcategory.trim();
                            newOption.selected = true;
                            subcategorySelect.insertBefore(newOption, subcategorySelect.children[subcategorySelect.children.length - 2]);
                        } else {
                            subcategorySelect.value = '';
                        }
                    }
                }, { once: true });

            } catch (error) {
                console.error('Error loading subcategories:', error);
                subcategorySelect.innerHTML = '<option value="">Select Subcategory (Optional)</option>';
            }
        }

        // Upload images to Firebase Storage
        window.uploadProductImages = async function(files) {
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = progressDiv.querySelector('.progress-bar');
            const uploadedImagesDiv = document.getElementById('uploadedImages');
            
            progressDiv.style.display = 'block';
            
            const uploadedUrls = [];
            const totalFiles = files.length;
            
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileName = `products/${Date.now()}_${i}_${file.name}`;
                    const storageRef = ref(storage, fileName);
                    
                    // Upload with progress
                    const uploadTask = uploadBytesResumable(storageRef, file);
                    
                    await new Promise((resolve, reject) => {
                        uploadTask.on('state_changed',
                            (snapshot) => {
                                const progress = ((i / totalFiles) + (snapshot.bytesTransferred / snapshot.totalBytes) / totalFiles) * 100;
                                progressBar.style.width = progress + '%';
                            },
                            (error) => reject(error),
                            () => {
                                getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                                    uploadedUrls.push(downloadURL);
                                    
                                    // Show preview
                                    const img = document.createElement('img');
                                    img.src = downloadURL;
                                    img.style.width = '80px';
                                    img.style.height = '80px';
                                    img.style.objectFit = 'cover';
                                    img.className = 'border rounded';
                                    uploadedImagesDiv.appendChild(img);
                                    
                                    resolve();
                                });
                            }
                        );
                    });
                }
                
                // Update textarea with uploaded URLs
                const currentUrls = document.getElementById('productImages').value
                    .split('\n')
                    .map(url => url.trim())
                    .filter(url => url);
                
                const allUrls = [...currentUrls, ...uploadedUrls];
                document.getElementById('productImages').value = allUrls.join('\n');
                
                progressDiv.style.display = 'none';
                showAlert('Images uploaded successfully!', 'success');
                
            } catch (error) {
                console.error('Error uploading images:', error);
                showAlert('Error uploading images: ' + error.message, 'danger');
                progressDiv.style.display = 'none';
            }
        }

        // Variable management functions
        window.addVariableField = function() {
            const container = document.getElementById('variablesContainer');
            const variableId = 'variable_' + Date.now();
            
            const variableDiv = document.createElement('div');
            variableDiv.className = 'border rounded p-3 mb-3';
            variableDiv.id = variableId;
            variableDiv.innerHTML = `
                <div class="row g-2">
                    <div class="col-md-3">
                        <label class="form-label">Variable Name</label>
                        <input type="text" class="form-control" placeholder="e.g., Color, Size" onchange="updateVariablesJSON()">
                    </div>
                    <div class="col-md-7">
                        <label class="form-label">Values (comma-separated)</label>
                        <input type="text" class="form-control" placeholder="e.g., Red, Blue, Green" onchange="updateVariablesJSON()">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeVariableField('${variableId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(variableDiv);
        }

        window.removeVariableField = function(variableId) {
            const element = document.getElementById(variableId);
            if (element) {
                element.remove();
                updateVariablesJSON();
            }
        }

        window.updateVariablesJSON = function() {
            const container = document.getElementById('variablesContainer');
            const variableFields = container.querySelectorAll('.border.rounded');
            const variables = {};
            
            variableFields.forEach(field => {
                const nameInput = field.querySelector('input[placeholder*="Color, Size"]');
                const valuesInput = field.querySelector('input[placeholder*="Red, Blue"]');
                
                if (nameInput && valuesInput && nameInput.value.trim() && valuesInput.value.trim()) {
                    const name = nameInput.value.trim().toLowerCase();
                    const values = valuesInput.value.split(',').map(v => v.trim()).filter(v => v);
                    if (values.length > 0) {
                        variables[name] = values;
                    }
                }
            });
            
            document.getElementById('productVariables').value = JSON.stringify(variables);
        }

        window.loadVariablesFromJSON = function(variablesData) {
            const container = document.getElementById('variablesContainer');
            container.innerHTML = '';
            
            if (variablesData && typeof variablesData === 'object') {
                Object.entries(variablesData).forEach(([name, values]) => {
                    addVariableField();
                    const lastField = container.lastElementChild;
                    if (lastField) {
                        const nameInput = lastField.querySelector('input[placeholder*="Color, Size"]');
                        const valuesInput = lastField.querySelector('input[placeholder*="Red, Blue"]');
                        
                        if (nameInput) nameInput.value = name;
                        if (valuesInput && Array.isArray(values)) {
                            valuesInput.value = values.join(', ');
                        }
                    }
                });
            }
            
            // Add empty field if no variables exist
            if (container.children.length === 0) {
                addVariableField();
            }
        }

        // Show add product modal
        window.showAddProductModal = function() {
            currentEditingProduct = null;
            document.getElementById('productModalTitle').textContent = 'Add Master Product';
            document.getElementById('productForm').reset();
            document.getElementById('productActive').checked = true;
            
            // Clear and initialize variables section
            loadVariablesFromJSON({});
            
            // Clear uploaded images preview
            document.getElementById('uploadedImages').innerHTML = '';
            
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }

        // Edit product
        window.editProduct = async function(productId) {
            try {
                const product = masterProducts.find(p => p.id === productId);
                if (!product) return;

                currentEditingProduct = productId;
                document.getElementById('productModalTitle').textContent = 'Edit Master Product';
                
                document.getElementById('productName').value = product.name || '';
                document.getElementById('productBrand').value = product.brand || '';
                document.getElementById('productCategory').value = product.category || '';
                
                // Load subcategories for the selected category
                if (product.category) {
                    await loadSubcategories(product.category);
                    document.getElementById('productSubcategory').value = product.subcategory || '';
                }
                
                document.getElementById('productDescription').value = product.description || '';
                document.getElementById('productKeywords').value = product.keywords ? product.keywords.join(', ') : '';
                document.getElementById('productImages').value = product.images ? product.images.join('\n') : '';
                
                // Load variables into the new interface
                loadVariablesFromJSON(product.availableVariables || {});
                
                document.getElementById('productActive').checked = product.isActive !== false;
                
                // Clear uploaded images preview and show existing images
                const uploadedImagesDiv = document.getElementById('uploadedImages');
                uploadedImagesDiv.innerHTML = '';
                
                if (product.images && Array.isArray(product.images)) {
                    product.images.forEach(imageUrl => {
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.style.width = '80px';
                        img.style.height = '80px';
                        img.style.objectFit = 'cover';
                        img.className = 'border rounded me-2 mb-2';
                        uploadedImagesDiv.appendChild(img);
                    });
                }

                const modal = new bootstrap.Modal(document.getElementById('productModal'));
                modal.show();
            } catch (error) {
                console.error('Error loading product for edit:', error);
                showToast('Error loading product: ' + error.message, 'error');
            }
        }

        // Delete product
        window.deleteProduct = async function(productId) {
            if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'master_products', productId));
                showToast('Product deleted successfully!', 'success');
                await loadMasterProducts();
            } catch (error) {
                console.error('Error deleting product:', error);
                showToast('Error deleting product: ' + error.message, 'error');
            }
        }

        // Toggle product status
        window.toggleProductStatus = async function(productId) {
            try {
                const product = masterProducts.find(p => p.id === productId);
                if (!product) return;

                await updateDoc(doc(db, 'master_products', productId), {
                    isActive: !product.isActive,
                    updatedAt: serverTimestamp()
                });

                showToast(`Product ${product.isActive ? 'deactivated' : 'activated'} successfully!`, 'success');
                await loadMasterProducts();
            } catch (error) {
                console.error('Error updating product status:', error);
                showToast('Error updating product status: ' + error.message, 'error');
            }
        }

        // Handle product form submission
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const productData = {
                name: document.getElementById('productName').value.trim(),
                brand: document.getElementById('productBrand').value.trim(),
                category: document.getElementById('productCategory').value,
                subcategory: document.getElementById('productSubcategory').value.trim(),
                description: document.getElementById('productDescription').value.trim(),
                keywords: document.getElementById('productKeywords').value.split(',').map(k => k.trim()).filter(k => k),
                images: document.getElementById('productImages').value.split('\n').map(i => i.trim()).filter(i => i),
                isActive: document.getElementById('productActive').checked,
                updatedAt: serverTimestamp()
            };

            // Parse variables JSON
            const variablesText = document.getElementById('productVariables').value.trim();
            if (variablesText) {
                try {
                    productData.availableVariables = JSON.parse(variablesText);
                } catch (error) {
                    showToast('Invalid JSON format in variables field', 'error');
                    return;
                }
            } else {
                productData.availableVariables = {};
            }

            try {
                if (currentEditingProduct) {
                    await updateDoc(doc(db, 'master_products', currentEditingProduct), productData);
                    showToast('Product updated successfully!', 'success');
                } else {
                    productData.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'master_products'), productData);
                    showToast('Product created successfully!', 'success');
                }

                bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                await loadMasterProducts();
                populateFilters();
            } catch (error) {
                console.error('Error saving product:', error);
                showToast('Error saving product: ' + error.message, 'error');
            }
        });

        // Handle file upload when files are selected
        document.getElementById('productImageFiles').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                await uploadProductImages(files);
                e.target.value = ''; // Clear file input
            }
        });

        // Filter products
        window.filterProducts = function() {
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const brandFilter = document.getElementById('brandFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            const filteredProducts = masterProducts.filter(product => {
                const matchesSearch = !searchTerm || 
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.brand.toLowerCase().includes(searchTerm) ||
                    (product.description && product.description.toLowerCase().includes(searchTerm));
                
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                const matchesBrand = !brandFilter || product.brand === brandFilter;
                const matchesStatus = !statusFilter || product.isActive.toString() === statusFilter;

                return matchesSearch && matchesCategory && matchesBrand && matchesStatus;
            });

            // Temporarily replace masterProducts for display
            const originalProducts = masterProducts;
            masterProducts = filteredProducts;
            displayProducts();
            updateProductCount();
            masterProducts = originalProducts;
        }

        // Clear filters
        window.clearFilters = function() {
            document.getElementById('searchFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('brandFilter').value = '';
            document.getElementById('statusFilter').value = '';
            displayProducts();
            updateProductCount();
        }

        // Update product count
        function updateProductCount() {
            const count = document.querySelectorAll('#productsTable tr').length;
            document.getElementById('productCount').textContent = `Showing ${count} products`;
        }

        // Show section
        window.showSection = function(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(sectionName + '-section').style.display = 'block';
            
            // Update nav active state
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Load data for the specific section
            switch(sectionName) {
                case 'business-listings':
                    loadBusinessListings();
                    break;
                case 'categories':
                    loadCategoriesData();
                    break;
                case 'brands':
                    loadBrandsData();
                    break;
                case 'variables':
                    loadVariablesData();
                    break;
            }
        }

        // View product (placeholder)
        window.viewProduct = function(productId) {
            const product = masterProducts.find(p => p.id === productId);
            if (product) {
                alert(`Product Details:\n\nName: ${product.name}\nBrand: ${product.brand}\nCategory: ${product.category}\nStatus: ${product.isActive ? 'Active' : 'Inactive'}\nBusiness Listings: ${product.businessListingsCount || 0}`);
            }
        }

        // Export products (placeholder)
        window.exportProducts = function() {
            showToast('Export functionality coming soon!', 'info');
        }

        // Placeholder functions for other sections
        window.showAddCategoryModal = function() {
            showToast('Category management coming soon!', 'info');
        }

        window.showAddBrandModal = function() {
            showToast('Brand management coming soon!', 'info');
        }

        window.showAddVariableModal = function() {
            showToast('Variable management coming soon!', 'info');
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: type === 'error' ? 5000 : 3000
            });
            
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }

        // Make showToast available globally
        window.showToast = showToast;

        // Add showAlert function for compatibility
        window.showAlert = function(message, type) {
            showToast(message, type === 'danger' ? 'error' : type);
        }

        // Load categories data
        async function loadCategoriesData() {
            try {
                // Get unique categories from existing master products
                const uniqueCategories = [...new Set(masterProducts.map(p => p.category).filter(c => c))];
                
                const categoriesData = uniqueCategories.map(categoryName => ({
                    id: categoryName.toLowerCase().replace(/\s+/g, '_'),
                    name: categoryName,
                    description: `Category for ${categoryName} products`,
                    isActive: true
                }));

                displayCategories(categoriesData);
            } catch (error) {
                console.error('Error loading categories:', error);
                document.getElementById('categoriesTable').innerHTML = 
                    '<tr><td colspan="5" class="text-center py-4 text-danger">Error loading categories</td></tr>';
            }
        }

        // Display categories
        function displayCategories(categoriesData) {
            const tbody = document.getElementById('categoriesTable');
            
            if (categoriesData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-tags fa-3x mb-3"></i>
                                <div class="mb-3">No categories found</div>
                                <button class="btn btn-primary btn-sm" onclick="showAddCategoryModal()">
                                    <i class="fas fa-plus me-1"></i>Add First Category
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = categoriesData.map(category => {
                const productsInCategory = masterProducts.filter(p => p.category === category.name).length;
                return `
                    <tr>
                        <td><strong>${category.name || 'Unnamed'}</strong></td>
                        <td>${category.description || '-'}</td>
                        <td><span class="badge bg-info">${productsInCategory}</span></td>
                        <td>
                            <span class="badge ${(category.isActive !== false) ? 'bg-success' : 'bg-secondary'}">
                                ${(category.isActive !== false) ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editCategory('${category.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory('${category.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load brands data
        async function loadBrandsData() {
            try {
                // Get unique brands from existing master products
                const uniqueBrands = [...new Set(masterProducts.map(p => p.brand).filter(b => b))];
                
                const brandsData = uniqueBrands.map(brandName => ({
                    id: brandName.toLowerCase().replace(/\s+/g, '_'),
                    name: brandName,
                    description: `Brand for ${brandName} products`,
                    isActive: true
                }));

                displayBrands(brandsData);
            } catch (error) {
                console.error('Error loading brands:', error);
                document.getElementById('brandsTable').innerHTML = 
                    '<tr><td colspan="5" class="text-center py-4 text-danger">Error loading brands</td></tr>';
            }
        }

        // Display brands
        function displayBrands(brandsData) {
            const tbody = document.getElementById('brandsTable');
            
            if (brandsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-award fa-3x mb-3"></i>
                                <div class="mb-3">No brands found</div>
                                <button class="btn btn-primary btn-sm" onclick="showAddBrandModal()">
                                    <i class="fas fa-plus me-1"></i>Add First Brand
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = brandsData.map(brand => {
                const productsInBrand = masterProducts.filter(p => p.brand === brand.name).length;
                return `
                    <tr>
                        <td><strong>${brand.name || 'Unnamed'}</strong></td>
                        <td>${brand.description || '-'}</td>
                        <td><span class="badge bg-info">${productsInBrand}</span></td>
                        <td>
                            <span class="badge ${(brand.isActive !== false) ? 'bg-success' : 'bg-secondary'}">
                                ${(brand.isActive !== false) ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editBrand('${brand.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteBrand('${brand.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load variables data
        async function loadVariablesData() {
            try {
                // Get variables from existing products
                const variablesData = new Map();
                
                masterProducts.forEach(product => {
                    if (product.availableVariables) {
                        Object.keys(product.availableVariables).forEach(variableName => {
                            const key = `${product.category}_${variableName}`;
                            if (!variablesData.has(key)) {
                                variablesData.set(key, {
                                    name: variableName,
                                    category: product.category,
                                    values: new Set()
                                });
                            }
                            
                            if (Array.isArray(product.availableVariables[variableName])) {
                                product.availableVariables[variableName].forEach(value => {
                                    variablesData.get(key).values.add(value);
                                });
                            }
                        });
                    }
                });

                const variablesArray = Array.from(variablesData.values()).map(variable => ({
                    ...variable,
                    values: Array.from(variable.values)
                }));

                displayVariables(variablesArray);
            } catch (error) {
                console.error('Error loading variables:', error);
                document.getElementById('variablesTable').innerHTML = 
                    '<tr><td colspan="4" class="text-center py-4 text-danger">Error loading variables</td></tr>';
            }
        }

        // Display variables
        function displayVariables(variablesData) {
            const tbody = document.getElementById('variablesTable');
            
            if (variablesData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-sliders-h fa-3x mb-3"></i>
                                <div class="mb-3">No variables found</div>
                                <p class="small">Variables are automatically extracted from product specifications</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = variablesData.map(variable => `
                <tr>
                    <td><strong>${variable.name}</strong></td>
                    <td><span class="badge bg-secondary">${variable.category}</span></td>
                    <td>
                        <div class="d-flex flex-wrap gap-1">
                            ${variable.values.slice(0, 5).map(value => 
                                `<span class="badge bg-light text-dark">${value}</span>`
                            ).join('')}
                            ${variable.values.length > 5 ? `<span class="badge bg-info">+${variable.values.length - 5} more</span>` : ''}
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="viewVariableDetails('${variable.name}', '${variable.category}')">
                            <i class="fas fa-eye"></i> View Details
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Load business listings
        async function loadBusinessListings() {
            try {
                const listingsSnapshot = await getDocs(collection(db, 'price_listings'));
                const businessListingsData = [];
                
                listingsSnapshot.forEach((doc) => {
                    businessListingsData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                displayBusinessListings(businessListingsData);
                populateBusinessFilters(businessListingsData);
            } catch (error) {
                console.error('Error loading business listings:', error);
                document.getElementById('businessListingsTable').innerHTML = 
                    '<tr><td colspan="8" class="text-center py-4 text-danger">Error loading business listings</td></tr>';
            }
        }

        // Display business listings
        function displayBusinessListings(listingsData) {
            const tbody = document.getElementById('businessListingsTable');
            
            if (listingsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-store fa-3x mb-3"></i>
                                <div class="mb-3">No business listings found</div>
                                <p class="small">Business listings will appear here when businesses add products</p>
                            </div>
                        </td>
                    </tr>
                `;
                updateBusinessListingsCount(0);
                return;
            }

            tbody.innerHTML = listingsData.map(listing => {
                const createdDate = listing.created_at ? new Date(listing.created_at.seconds * 1000).toLocaleDateString() : 'N/A';
                const price = listing.price ? `$${parseFloat(listing.price).toFixed(2)}` : 'N/A';
                
                // Get variables display
                let variablesDisplay = 'N/A';
                if (listing.selected_variables && Object.keys(listing.selected_variables).length > 0) {
                    const variables = Object.entries(listing.selected_variables)
                        .map(([key, value]) => `${key}: ${value}`)
                        .slice(0, 2)
                        .join(', ');
                    variablesDisplay = variables + (Object.keys(listing.selected_variables).length > 2 ? '...' : '');
                }

                return `
                    <tr>
                        <td>
                            <div>
                                <strong>${listing.business_name || 'Unknown Business'}</strong>
                                <br><small class="text-muted">${listing.business_id || 'No ID'}</small>
                            </div>
                        </td>
                        <td>
                            <div>
                                <strong>${listing.product_name || 'Unknown Product'}</strong>
                                <br><small class="text-muted">${listing.master_product_id || 'No ID'}</small>
                            </div>
                        </td>
                        <td><span class="badge bg-secondary">${listing.category || 'N/A'}</span></td>
                        <td><strong>${price}</strong></td>
                        <td>
                            <small class="text-muted">${variablesDisplay}</small>
                        </td>
                        <td>
                            <span class="badge ${(listing.is_active !== false) ? 'bg-success' : 'bg-secondary'}">
                                ${(listing.is_active !== false) ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td><small>${createdDate}</small></td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-info" onclick="viewBusinessListing('${listing.id}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="toggleBusinessListingStatus('${listing.id}')" title="Toggle Status">
                                    <i class="fas fa-toggle-${(listing.is_active !== false) ? 'on' : 'off'}"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteBusinessListing('${listing.id}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateBusinessListingsCount(listingsData.length);
        }

        // Populate business filters
        function populateBusinessFilters(listingsData) {
            // Category filter
            const categoryFilter = document.getElementById('businessCategoryFilter');
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            const uniqueCategories = [...new Set(listingsData.map(l => l.category).filter(c => c))].sort();
            uniqueCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
        }

        // Filter business listings
        window.filterBusinessListings = function() {
            // This would implement filtering logic - placeholder for now
            console.log('Filtering business listings...');
        }

        // Clear business filters
        window.clearBusinessFilters = function() {
            document.getElementById('businessSearchFilter').value = '';
            document.getElementById('businessCategoryFilter').value = '';
            document.getElementById('businessStatusFilter').value = '';
            document.getElementById('priceRangeFilter').value = '';
            filterBusinessListings();
        }

        // Update business listings count
        function updateBusinessListingsCount(count) {
            document.getElementById('businessListingsCount').textContent = `Showing ${count} listings`;
        }

        // Business listing actions (placeholders)
        window.viewBusinessListing = function(listingId) {
            alert('View business listing: ' + listingId + '\n\nDetailed view modal - Coming soon!');
        }

        window.toggleBusinessListingStatus = function(listingId) {
            if (confirm('Toggle the status of this business listing?')) {
                // Implementation would go here
                alert('Status toggled for listing: ' + listingId);
            }
        }

        window.deleteBusinessListing = function(listingId) {
            if (confirm('Are you sure you want to delete this business listing? This action cannot be undone.')) {
                // Implementation would go here
                alert('Delete listing: ' + listingId);
            }
        }

        window.exportBusinessListings = function() {
            alert('Export business listings to CSV - Coming soon!');
        }

        // Placeholder functions for modal actions
        window.showAddCategoryModal = function() {
            alert('Category management modal - Coming soon!');
        }

        window.showAddBrandModal = function() {
            alert('Brand management modal - Coming soon!');
        }

        window.showAddVariableModal = function() {
            alert('Variable management modal - Coming soon!');
        }

        window.editCategory = function(id) {
            alert('Edit category: ' + id);
        }

        window.deleteCategory = function(id) {
            alert('Delete category: ' + id);
        }

        window.editBrand = function(id) {
            alert('Edit brand: ' + id);
        }

        window.deleteBrand = function(id) {
            alert('Delete brand: ' + id);
        }

        window.viewVariableDetails = function(name, category) {
            const variable = masterProducts
                .filter(p => p.category === category && p.availableVariables && p.availableVariables[name])
                .map(p => p.availableVariables[name])
                .flat();
            
            const uniqueValues = [...new Set(variable)].sort();
            alert(`Variable: ${name}\nCategory: ${category}\nValues: ${uniqueValues.join(', ')}`);
        }

        // Show prompt to create sample products
        function showCreateSampleProductsPrompt() {
            if (confirm('No master products found. Would you like to create some sample products to get started?')) {
                createSampleProducts();
            }
        }

        // Create sample products
        async function createSampleProducts() {
            const sampleProducts = [
                {
                    name: "iPhone 15 Pro",
                    brand: "Apple",
                    category: "Electronics",
                    subcategory: "Smartphones",
                    description: "Latest Apple smartphone with advanced features",
                    keywords: ["smartphone", "apple", "iphone", "mobile"],
                    images: ["https://via.placeholder.com/300x300?text=iPhone+15+Pro"],
                    availableVariables: {
                        "color": ["Natural Titanium", "Blue Titanium", "White Titanium", "Black Titanium"],
                        "storage": ["128GB", "256GB", "512GB", "1TB"]
                    },
                    isActive: true,
                    createdAt: serverTimestamp()
                },
                {
                    name: "MacBook Air M3",
                    brand: "Apple",
                    category: "Electronics",
                    subcategory: "Laptops",
                    description: "Powerful and lightweight laptop with M3 chip",
                    keywords: ["laptop", "apple", "macbook", "computer"],
                    images: ["https://via.placeholder.com/300x300?text=MacBook+Air+M3"],
                    availableVariables: {
                        "color": ["Midnight", "Silver", "Space Gray", "Starlight"],
                        "memory": ["8GB", "16GB", "24GB"],
                        "storage": ["256GB", "512GB", "1TB", "2TB"]
                    },
                    isActive: true,
                    createdAt: serverTimestamp()
                },
                {
                    name: "Nike Air Jordan 1",
                    brand: "Nike",
                    category: "Fashion",
                    subcategory: "Shoes",
                    description: "Iconic basketball shoes with classic design",
                    keywords: ["shoes", "nike", "jordan", "sneakers", "basketball"],
                    images: ["https://via.placeholder.com/300x300?text=Air+Jordan+1"],
                    availableVariables: {
                        "color": ["Red", "Black", "White", "Blue"],
                        "size": ["7", "7.5", "8", "8.5", "9", "9.5", "10", "10.5", "11", "11.5", "12"]
                    },
                    isActive: true,
                    createdAt: serverTimestamp()
                },
                {
                    name: "Samsung Galaxy S24 Ultra",
                    brand: "Samsung",
                    category: "Electronics",
                    subcategory: "Smartphones",
                    description: "Premium Android smartphone with S Pen",
                    keywords: ["smartphone", "samsung", "galaxy", "android", "s-pen"],
                    images: ["https://via.placeholder.com/300x300?text=Galaxy+S24+Ultra"],
                    availableVariables: {
                        "color": ["Titanium Black", "Titanium Gray", "Titanium Violet", "Titanium Yellow"],
                        "storage": ["256GB", "512GB", "1TB"]
                    },
                    isActive: true,
                    createdAt: serverTimestamp()
                },
                {
                    name: "Sony WH-1000XM5",
                    brand: "Sony",
                    category: "Electronics",
                    subcategory: "Audio",
                    description: "Premium noise-canceling wireless headphones",
                    keywords: ["headphones", "sony", "wireless", "noise-canceling", "audio"],
                    images: ["https://via.placeholder.com/300x300?text=Sony+WH-1000XM5"],
                    availableVariables: {
                        "color": ["Black", "Silver"]
                    },
                    isActive: true,
                    createdAt: serverTimestamp()
                }
            ];

            try {
                showToast('Creating sample products...', 'info');
                
                for (const product of sampleProducts) {
                    await addDoc(collection(db, 'master_products'), product);
                }
                
                showToast(`Created ${sampleProducts.length} sample products successfully!`, 'success');
                await loadAllData();
            } catch (error) {
                console.error('Error creating sample products:', error);
                showToast('Error creating sample products: ' + error.message, 'error');
            }
        }

        // Make sample products function available globally
        window.createSampleProducts = createSampleProducts;
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
