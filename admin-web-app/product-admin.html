<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .product-image { max-width: 80px; max-height: 80px; object-fit: cover; }
        .status-active { color: #28a745; }
        .status-inactive { color: #dc3545; }
        .category-badge { font-size: 0.8em; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 bg-dark text-white p-3">
                <h5>ðŸ“¦ Product Admin</h5>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="#categories" onclick="showSection('categories')">
                            <i class="fas fa-tags"></i> Categories
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="#products" onclick="showSection('products')">
                            <i class="fas fa-box"></i> Master Products
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="#business-products" onclick="showSection('business-products')">
                            <i class="fas fa-store"></i> Business Products
                        </a>
                    </li>
                </ul>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-10 p-4">
                <!-- Categories Section -->
                <div id="categories" class="section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-tags"></i> Product Categories</h2>
                        <button class="btn btn-primary" onclick="showAddCategoryModal()">
                            <i class="fas fa-plus"></i> Add Category
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Parent</th>
                                            <th>Products</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="categoriesTable">
                                        <!-- Categories will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Master Products Section -->
                <div id="products" class="section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-box"></i> Master Products</h2>
                        <button class="btn btn-primary" onclick="showAddProductModal()">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                    </div>
                    
                    <!-- Search and Filter -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="productSearch" placeholder="Search products...">
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="categoryFilter">
                                        <option value="">All Categories</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-outline-primary" onclick="searchProducts()">
                                        <i class="fas fa-search"></i> Search
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Image</th>
                                            <th>Name</th>
                                            <th>Category</th>
                                            <th>Brand</th>
                                            <th>Business Listings</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productsTable">
                                        <!-- Products will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Business Products Section -->
                <div id="business-products" class="section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-store"></i> Business Product Listings</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Business</th>
                                            <th>Price</th>
                                            <th>Stock</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="businessProductsTable">
                                        <!-- Business products will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <div class="mb-3">
                            <label class="form-label">Category Name *</label>
                            <input type="text" class="form-control" id="categoryName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Parent Category</label>
                            <select class="form-select" id="parentCategory">
                                <option value="">None (Root Category)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="categoryDescription"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addCategory()">Add Category</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Master Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Product Name *</label>
                                    <input type="text" class="form-control" id="productName" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Brand *</label>
                                    <input type="text" class="form-control" id="productBrand" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Category *</label>
                                    <select class="form-select" id="productCategory" required>
                                        <option value="">Select Category</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Model/SKU</label>
                                    <input type="text" class="form-control" id="productModel">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Image URL</label>
                                    <input type="url" class="form-control" id="productImage">
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="productActive" checked>
                                        <label class="form-check-label" for="productActive">Active</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Specifications (JSON format)</label>
                            <textarea class="form-control" id="productSpecs" rows="4" placeholder='{"color": "Black", "storage": "128GB", "ram": "6GB"}'></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addProduct()">Add Product</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase and JavaScript -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD5KgP8OOkR5Hh1QZgOpfHRHGOKWJtJhow",
            authDomain: "request-marketplace.firebaseapp.com",
            projectId: "request-marketplace",
            storageBucket: "request-marketplace.appspot.com",
            messagingSenderId: "103076450650",
            appId: "1:103076450650:web:0c24087f2ac5de9b0fe5b1"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Navigation
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            // Show selected section
            document.getElementById(sectionId).style.display = 'block';
            
            // Load section data
            if (sectionId === 'categories') {
                loadCategories();
            } else if (sectionId === 'products') {
                loadProducts();
            } else if (sectionId === 'business-products') {
                loadBusinessProducts();
            }
        }

        // Category Management
        async function loadCategories() {
            try {
                const snapshot = await db.collection('product_categories')
                    .orderBy('name')
                    .get();
                
                const tableBody = document.getElementById('categoriesTable');
                tableBody.innerHTML = '';
                
                for (const doc of snapshot.docs) {
                    const category = doc.data();
                    const productCount = await getProductCountForCategory(doc.id);
                    
                    const row = `
                        <tr>
                            <td>${category.name}</td>
                            <td>${category.parentCategoryId ? await getCategoryName(category.parentCategoryId) : 'Root'}</td>
                            <td>${productCount}</td>
                            <td>
                                <span class="badge ${category.isActive ? 'bg-success' : 'bg-secondary'}">
                                    ${category.isActive ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="editCategory('${doc.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory('${doc.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                }
            } catch (error) {
                console.error('Error loading categories:', error);
                alert('Error loading categories: ' + error.message);
            }
        }

        async function getProductCountForCategory(categoryId) {
            try {
                const snapshot = await db.collection('master_products')
                    .where('categoryId', '==', categoryId)
                    .get();
                return snapshot.size;
            } catch (error) {
                return 0;
            }
        }

        async function getCategoryName(categoryId) {
            try {
                const doc = await db.collection('product_categories').doc(categoryId).get();
                return doc.exists ? doc.data().name : 'Unknown';
            } catch (error) {
                return 'Unknown';
            }
        }

        function showAddCategoryModal() {
            loadParentCategories();
            const modal = new bootstrap.Modal(document.getElementById('addCategoryModal'));
            modal.show();
        }

        async function loadParentCategories() {
            try {
                const snapshot = await db.collection('product_categories')
                    .where('isActive', '==', true)
                    .orderBy('name')
                    .get();
                
                const select = document.getElementById('parentCategory');
                select.innerHTML = '<option value="">None (Root Category)</option>';
                
                snapshot.docs.forEach(doc => {
                    const category = doc.data();
                    select.innerHTML += `<option value="${doc.id}">${category.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading parent categories:', error);
            }
        }

        async function addCategory() {
            try {
                const name = document.getElementById('categoryName').value;
                const parentId = document.getElementById('parentCategory').value;
                const description = document.getElementById('categoryDescription').value;
                
                if (!name) {
                    alert('Category name is required');
                    return;
                }
                
                await db.collection('product_categories').add({
                    name: name,
                    parentCategoryId: parentId || null,
                    description: description,
                    isActive: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();
                document.getElementById('categoryForm').reset();
                loadCategories();
                alert('Category added successfully!');
            } catch (error) {
                console.error('Error adding category:', error);
                alert('Error adding category: ' + error.message);
            }
        }

        // Product Management
        async function loadProducts() {
            try {
                const snapshot = await db.collection('master_products')
                    .orderBy('name')
                    .get();
                
                const tableBody = document.getElementById('productsTable');
                tableBody.innerHTML = '';
                
                for (const doc of snapshot.docs) {
                    const product = doc.data();
                    const categoryName = await getCategoryName(product.categoryId);
                    const businessCount = await getBusinessProductCount(doc.id);
                    
                    const row = `
                        <tr>
                            <td>
                                ${product.imageUrl ? 
                                    `<img src="${product.imageUrl}" class="product-image rounded" alt="${product.name}">` : 
                                    '<i class="fas fa-image text-muted"></i>'
                                }
                            </td>
                            <td>${product.name}</td>
                            <td><span class="badge bg-secondary category-badge">${categoryName}</span></td>
                            <td>${product.brand || 'N/A'}</td>
                            <td>${businessCount}</td>
                            <td>
                                <span class="badge ${product.isActive ? 'bg-success' : 'bg-secondary'}">
                                    ${product.isActive ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="editProduct('${doc.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${doc.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                }
            } catch (error) {
                console.error('Error loading products:', error);
                alert('Error loading products: ' + error.message);
            }
        }

        async function getBusinessProductCount(masterProductId) {
            try {
                const snapshot = await db.collection('business_products')
                    .where('masterProductId', '==', masterProductId)
                    .get();
                return snapshot.size;
            } catch (error) {
                return 0;
            }
        }

        function showAddProductModal() {
            loadProductCategories();
            const modal = new bootstrap.Modal(document.getElementById('addProductModal'));
            modal.show();
        }

        async function loadProductCategories() {
            try {
                const snapshot = await db.collection('product_categories')
                    .where('isActive', '==', true)
                    .orderBy('name')
                    .get();
                
                const select = document.getElementById('productCategory');
                select.innerHTML = '<option value="">Select Category</option>';
                
                snapshot.docs.forEach(doc => {
                    const category = doc.data();
                    select.innerHTML += `<option value="${doc.id}">${category.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        async function addProduct() {
            try {
                const name = document.getElementById('productName').value;
                const brand = document.getElementById('productBrand').value;
                const categoryId = document.getElementById('productCategory').value;
                const model = document.getElementById('productModel').value;
                const imageUrl = document.getElementById('productImage').value;
                const description = document.getElementById('productDescription').value;
                const specsText = document.getElementById('productSpecs').value;
                const isActive = document.getElementById('productActive').checked;
                
                if (!name || !brand || !categoryId) {
                    alert('Name, brand, and category are required');
                    return;
                }
                
                let specifications = {};
                if (specsText) {
                    try {
                        specifications = JSON.parse(specsText);
                    } catch (e) {
                        alert('Invalid JSON format for specifications');
                        return;
                    }
                }
                
                await db.collection('master_products').add({
                    name: name,
                    brand: brand,
                    categoryId: categoryId,
                    model: model,
                    imageUrl: imageUrl,
                    description: description,
                    specifications: specifications,
                    isActive: isActive,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
                document.getElementById('productForm').reset();
                loadProducts();
                alert('Product added successfully!');
            } catch (error) {
                console.error('Error adding product:', error);
                alert('Error adding product: ' + error.message);
            }
        }

        // Business Products Management
        async function loadBusinessProducts() {
            try {
                const snapshot = await db.collection('business_products')
                    .orderBy('updatedAt', 'desc')
                    .limit(50)
                    .get();
                
                const tableBody = document.getElementById('businessProductsTable');
                tableBody.innerHTML = '';
                
                for (const doc of snapshot.docs) {
                    const businessProduct = doc.data();
                    const masterProductName = await getMasterProductName(businessProduct.masterProductId);
                    const businessName = await getBusinessName(businessProduct.businessId);
                    
                    const row = `
                        <tr>
                            <td>${masterProductName}</td>
                            <td>${businessName}</td>
                            <td>Rs. ${businessProduct.price?.toLocaleString() || 'N/A'}</td>
                            <td>
                                <span class="badge ${businessProduct.isInStock ? 'bg-success' : 'bg-warning'}">
                                    ${businessProduct.isInStock ? 'In Stock' : 'Out of Stock'}
                                </span>
                            </td>
                            <td>
                                <span class="badge ${businessProduct.isActive ? 'bg-success' : 'bg-secondary'}">
                                    ${businessProduct.isActive ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeBusinessProduct('${doc.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                }
            } catch (error) {
                console.error('Error loading business products:', error);
                alert('Error loading business products: ' + error.message);
            }
        }

        async function getMasterProductName(masterProductId) {
            try {
                const doc = await db.collection('master_products').doc(masterProductId).get();
                return doc.exists ? doc.data().name : 'Unknown Product';
            } catch (error) {
                return 'Unknown Product';
            }
        }

        async function getBusinessName(businessId) {
            try {
                const doc = await db.collection('businesses').doc(businessId).get();
                return doc.exists ? doc.data().basicInfo?.businessName || 'Unknown Business' : 'Unknown Business';
            } catch (error) {
                return 'Unknown Business';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            showSection('categories');
        });
    </script>
</body>
</html>
