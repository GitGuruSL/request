<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Login - Request Marketplace</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #7c3aed;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', system-ui, sans-serif;
        }
        
        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            padding: 40px;
            min-width: 400px;
            text-align: center;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 2rem;
        }
        
        .google-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            width: 100%;
            transition: all 0.3s;
        }
        
        .google-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .status-alert {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo">
            <i class="fas fa-cogs"></i>
        </div>
        
        <h2 class="mb-3">Admin Login</h2>
        <p class="text-muted mb-4">Sign in to access the Request Marketplace admin panel</p>
        
        <button id="googleSignInBtn" class="google-btn" onclick="signInWithGoogle()">
            <i class="fab fa-google me-2"></i>
            Sign in with Google
        </button>
        
        <div class="mt-3">
            <button id="debugSignInBtn" class="btn btn-outline-secondary btn-sm" onclick="debugSignIn()" style="display: none;">
                <i class="fas fa-bug me-1"></i>
                Debug Access (Dev Only)
            </button>
        </div>
        
        <div id="statusAlert" class="status-alert d-none"></div>
        
        <div class="mt-4">
            <small class="text-muted">
                <i class="fas fa-shield-alt me-1"></i>
                Secure authentication via Firebase
            </small>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCtuD42SzwxKmSY5p-x5olFex2U_S9YrMk",
            authDomain: "request-marketplace.firebaseapp.com",
            projectId: "request-marketplace",
            storageBucket: "request-marketplace.appspot.com", // FIXED BUCKET URL
            messagingSenderId: "355474518888",
            appId: "1:355474518888:web:7b3a7f6f7d7a8b0d8e8f9f"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        console.log('üî• Admin Login initialized');

        // Authorized admin emails
        const authorizedEmails = [
            'cyber.sec.expert@outlook.com',
            'rimas@alphabet.lk',
            'rimas@me.com',
            'rimaz.m.flyii@gmail.com'
        ];

        function showStatus(message, type = 'info') {
            const alertElement = document.getElementById('statusAlert');
            alertElement.className = `status-alert alert alert-${type}`;
            alertElement.innerHTML = message;
            alertElement.classList.remove('d-none');
        }

        function hideStatus() {
            document.getElementById('statusAlert').classList.add('d-none');
        }

        function setLoading(loading) {
            const container = document.querySelector('.login-container');
            const btn = document.getElementById('googleSignInBtn');
            
            if (loading) {
                container.classList.add('loading');
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Signing in...';
            } else {
                container.classList.remove('loading');
                btn.innerHTML = '<i class="fab fa-google me-2"></i>Sign in with Google';
            }
        }

        // Google Sign-In function (now uses redirect to avoid popup blockers)
        window.signInWithGoogle = async () => {
            setLoading(true);
            hideStatus();
            console.log('üîë Starting Google sign-in (redirect)...');
            provider.setCustomParameters({ prompt: 'select_account' });
            provider.addScope('email');
            provider.addScope('profile');
            await signInWithRedirect(auth, provider);
        };

        // Handle redirect result on page load
        getRedirectResult(auth)
            .then((result) => {
                if (result && result.user) {
                    const user = result.user;
                    console.log('üë§ User signed in (redirect):', user.email);
                    if (!authorizedEmails.includes(user.email)) {
                        auth.signOut();
                        showStatus(`‚ùå Access denied. Email ${user.email} is not authorized for admin access.`, 'danger');
                        return;
                    }
                    showStatus(`‚úÖ Welcome ${user.displayName}! Redirecting to admin panel...`, 'success');
                    setTimeout(() => {
                        window.location.href = 'simple-admin.html';
                    }, 1500);
                }
            })
            .catch((error) => {
                console.error('‚ùå Sign-in error (redirect):', error);
                setLoading(false);
                if (error.code === 'auth/network-request-failed') {
                    showStatus('‚ùå Network error. Please check your connection and try again.', 'danger');
                } else if (error.code === 'auth/unauthorized-domain') {
                    showStatus('‚ùå This domain is not authorized for Google Sign-In.', 'danger');
                } else {
                    showStatus(`‚ùå Sign-in failed: ${error.message}`, 'danger');
                }
                setTimeout(() => {
                    showStatus('üí° <strong>Troubleshooting:</strong><br>1. Clear browser cache<br>2. Try incognito mode<br>3. Check if Google is accessible', 'info');
                }, 3000);
            });

        // Debug sign-in for development (bypasses Google auth)
        window.debugSignIn = () => {
            showStatus('üîß Debug access enabled. Redirecting to admin panel...', 'info');
            setTimeout(() => {
                window.location.href = 'simple-admin.html?debug=true';
            }, 1000);
        };

        // Check if user is already signed in
        onAuthStateChanged(auth, (user) => {
            if (user && authorizedEmails.includes(user.email)) {
                console.log('‚úÖ User already signed in:', user.email);
                showStatus(`‚úÖ Already signed in as ${user.displayName}. Redirecting...`, 'success');
                setTimeout(() => {
                    window.location.href = 'simple-admin.html';
                }, 1000);
            }
        });

        // Handle page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ Login page loaded');
            
            // Show debug button if in development (localhost)
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                document.getElementById('debugSignInBtn').style.display = 'block';
                console.log('üîß Debug mode available on localhost');
            }
            
            // Show initial status
            showStatus('üîê Ready to sign in. Click the button above to authenticate.', 'info');
            
            // Hide status after 3 seconds
            setTimeout(hideStatus, 3000);
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
