<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Product Admin - Request Marketplace</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #7c3aed;
        }
        
        .sidebar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            z-index: 1000;
        }
        
        .content {
            margin-left: 250px;
            padding: 20px;
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s;
            margin: 2px 0;
            border-radius: 8px;
        }
        
        .nav-link:hover, .nav-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: none;
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar text-white p-3">
        <div class="text-center mb-4">
            <h4><i class="fas fa-cog me-2"></i>Product Admin</h4>
            <small class="text-white-50">Centralized Product Management</small>
        </div>
        
        <nav class="nav flex-column px-3">
            <a class="nav-link active" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
            </a>
            <a class="nav-link" onclick="showSection('categories')">
                <i class="fas fa-tags me-2"></i>Categories
            </a>
            <a class="nav-link" onclick="showSection('master-products')">
                <i class="fas fa-cube me-2"></i>Master Products
            </a>
            <a class="nav-link" onclick="showSection('business-products')">
                <i class="fas fa-store me-2"></i>Business Products
            </a>
            <a class="nav-link" onclick="showSection('analytics')">
                <i class="fas fa-chart-line me-2"></i>Analytics
            </a>
        </nav>
        
        <div class="p-3 mt-auto">
            <small class="text-white-50">Centralized Product Database</small>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content">
        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-chart-line me-2"></i>Product Dashboard</h2>
                <button class="btn btn-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            
            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-tags fa-2x text-primary mb-2"></i>
                            <h3 id="totalCategories">0</h3>
                            <p class="card-text">Categories</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-cube fa-2x text-success mb-2"></i>
                            <h3 id="totalMasterProducts">0</h3>
                            <p class="card-text">Master Products</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-store fa-2x text-warning mb-2"></i>
                            <h3 id="totalBusinessProducts">0</h3>
                            <p class="card-text">Business Listings</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-clock fa-2x text-danger mb-2"></i>
                            <h3 id="pendingApprovals">0</h3>
                            <p class="card-text">Pending Approvals</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clock me-2"></i>Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div id="recentActivity">
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories Section -->
        <div id="categories" class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-tags me-2"></i>Product Categories</h2>
                <button class="btn btn-success" onclick="showAddCategoryModal()">
                    <i class="fas fa-plus"></i> Add Category
                </button>
            </div>
            <div id="categoriesContent">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Loading categories...
                </div>
            </div>
        </div>

        <!-- Master Products Section -->
        <div id="master-products" class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-cube me-2"></i>Master Products</h2>
                <button class="btn btn-success" onclick="showAddMasterProductModal()">
                    <i class="fas fa-plus"></i> Add Master Product
                </button>
            </div>
            <div id="masterProductsContent">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Loading master products...
                </div>
            </div>
        </div>

        <!-- Business Products Section -->
        <div id="business-products" class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-store me-2"></i>Business Product Listings</h2>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary" onclick="filterBusinessProducts('all')">All</button>
                    <button class="btn btn-outline-warning" onclick="filterBusinessProducts('pending')">Pending</button>
                    <button class="btn btn-outline-success" onclick="filterBusinessProducts('approved')">Approved</button>
                    <button class="btn btn-outline-danger" onclick="filterBusinessProducts('rejected')">Rejected</button>
                </div>
            </div>
            <div id="businessProductsContent">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Loading business products...
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analytics" class="content-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-chart-line me-2"></i>Product Analytics</h2>
                <button class="btn btn-primary" onclick="loadAnalytics()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div id="analyticsContent">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Analytics will be implemented here...
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, addDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCtuD42SzwxKmSY5p-x5olFex2U_S9YrMk",
            authDomain: "request-marketplace.firebaseapp.com",
            projectId: "request-marketplace",
            storageBucket: "request-marketplace.appspot.com",
            messagingSenderId: "355474518888",
            appId: "1:355474518888:web:7b3a7f6f7d7a8b0d8e8f9f"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        console.log('ðŸ”¥ Enhanced Product Admin initialized!');

        // Show notification function
        window.showNotification = (message, type = 'info') => {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show notification`;
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        };

        // Show section function
        window.showSection = (sectionName) => {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show target section
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Add active class to corresponding nav link
            const navLink = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
            if (navLink) {
                navLink.classList.add('active');
            }
            
            // Load section data
            switch(sectionName) {
                case 'dashboard':
                    refreshDashboard();
                    break;
                case 'categories':
                    loadCategoriesData();
                    break;
                case 'master-products':
                    loadMasterProductsData();
                    break;
                case 'business-products':
                    loadBusinessProductsData();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
            }
        };

        // Dashboard functions
        window.refreshDashboard = async () => {
            try {
                const [categoriesSnapshot, masterProductsSnapshot, businessProductsSnapshot] = await Promise.all([
                    getDocs(collection(db, 'product_categories')),
                    getDocs(collection(db, 'master_products')),
                    getDocs(collection(db, 'business_products'))
                ]);

                document.getElementById('totalCategories').textContent = categoriesSnapshot.size;
                document.getElementById('totalMasterProducts').textContent = masterProductsSnapshot.size;
                document.getElementById('totalBusinessProducts').textContent = businessProductsSnapshot.size;
                
                // Count pending approvals
                let pendingCount = 0;
                businessProductsSnapshot.forEach(doc => {
                    const product = doc.data();
                    if ((product.status || 'pending') === 'pending') {
                        pendingCount++;
                    }
                });
                document.getElementById('pendingApprovals').textContent = pendingCount;

                // Update recent activity
                document.getElementById('recentActivity').innerHTML = `
                    <div class="list-group list-group-flush">
                        <div class="list-group-item">
                            <i class="fas fa-tags text-primary me-2"></i>
                            ${categoriesSnapshot.size} product categories organized
                        </div>
                        <div class="list-group-item">
                            <i class="fas fa-cube text-success me-2"></i>
                            ${masterProductsSnapshot.size} master products in catalog
                        </div>
                        <div class="list-group-item">
                            <i class="fas fa-store text-warning me-2"></i>
                            ${businessProductsSnapshot.size} business product listings
                        </div>
                        <div class="list-group-item">
                            <i class="fas fa-clock text-danger me-2"></i>
                            ${pendingCount} listings awaiting approval
                        </div>
                    </div>
                `;
                
                showNotification('âœ… Dashboard updated successfully!', 'success');
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showNotification('Error loading dashboard: ' + error.message, 'error');
            }
        };

        // Load Categories Data
        window.loadCategoriesData = async () => {
            try {
                console.log('ðŸ“‚ Loading categories...');
                const categoriesSnapshot = await getDocs(collection(db, 'product_categories'));
                
                let categoriesHtml = '';
                
                if (categoriesSnapshot.size > 0) {
                    categoriesHtml += '<div class="row">';
                    categoriesSnapshot.forEach((doc) => {
                        const category = doc.data();
                        const categoryId = doc.id;
                        
                        categoriesHtml += `
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="card-title">${category.name || 'Unnamed Category'}</h6>
                                                <p class="card-text text-muted small">${category.description || 'No description'}</p>
                                                ${category.subcategories ? `<small class="text-info">${category.subcategories.length} subcategories</small>` : ''}
                                            </div>
                                            <div class="btn-group-vertical btn-group-sm">
                                                <button class="btn btn-outline-primary btn-sm" onclick="editCategory('${categoryId}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" onclick="deleteCategory('${categoryId}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        ${category.subcategories ? `
                                            <div class="mt-2">
                                                <small class="text-muted">Subcategories:</small><br>
                                                ${category.subcategories.map(sub => `<span class="badge bg-light text-dark me-1">${sub}</span>`).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    categoriesHtml += '</div>';
                } else {
                    categoriesHtml = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No categories found. Create your first category to organize products.
                        </div>
                    `;
                }
                
                document.getElementById('categoriesContent').innerHTML = categoriesHtml;
                
            } catch (error) {
                console.error('Error loading categories:', error);
                document.getElementById('categoriesContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading categories: ${error.message}
                    </div>
                `;
            }
        };

        // Load Master Products Data
        window.loadMasterProductsData = async () => {
            try {
                console.log('ðŸŽ¯ Loading master products...');
                const masterProductsSnapshot = await getDocs(collection(db, 'master_products'));
                
                let masterProductsHtml = '';
                
                if (masterProductsSnapshot.size > 0) {
                    masterProductsHtml += '<div class="row">';
                    masterProductsSnapshot.forEach((doc) => {
                        const product = doc.data();
                        const productId = doc.id;
                        
                        masterProductsHtml += `
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="card-title">${product.name || 'Unnamed Product'}</h6>
                                                <p class="card-text text-muted small">${product.description || 'No description'}</p>
                                                <div class="d-flex gap-2 flex-wrap">
                                                    ${product.category ? `<span class="badge bg-primary">${product.category}</span>` : ''}
                                                    ${product.subcategory ? `<span class="badge bg-secondary">${product.subcategory}</span>` : ''}
                                                    ${product.brand ? `<span class="badge bg-info">${product.brand}</span>` : ''}
                                                </div>
                                                ${product.specifications ? `
                                                    <small class="text-muted d-block mt-1">
                                                        Specs: ${Object.keys(product.specifications).length} attributes
                                                    </small>
                                                ` : ''}
                                            </div>
                                            <div class="btn-group-vertical btn-group-sm">
                                                <button class="btn btn-outline-info btn-sm" onclick="viewMasterProduct('${productId}')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-primary btn-sm" onclick="editMasterProduct('${productId}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" onclick="deleteMasterProduct('${productId}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    masterProductsHtml += '</div>';
                } else {
                    masterProductsHtml = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No master products found. Create master products for businesses to add pricing to.
                        </div>
                    `;
                }
                
                document.getElementById('masterProductsContent').innerHTML = masterProductsHtml;
                
            } catch (error) {
                console.error('Error loading master products:', error);
                document.getElementById('masterProductsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading master products: ${error.message}
                    </div>
                `;
            }
        };

        // Load Business Products Data with proper approval status handling
        window.loadBusinessProductsData = async (statusFilter = 'all') => {
            try {
                console.log('ðŸª Loading business products...');
                const businessProductsSnapshot = await getDocs(collection(db, 'business_products'));
                
                let businessProductsHtml = '';
                
                if (businessProductsSnapshot.size > 0) {
                    const products = [];
                    businessProductsSnapshot.forEach((doc) => {
                        const product = doc.data();
                        const productId = doc.id;
                        products.push({ id: productId, ...product });
                    });
                    
                    // Filter by status
                    const filteredProducts = statusFilter === 'all' ? products : 
                        products.filter(p => (p.status || 'pending') === statusFilter);
                    
                    if (filteredProducts.length > 0) {
                        businessProductsHtml += '<div class="row">';
                        filteredProducts.forEach((product) => {
                            const status = product.status || 'pending';
                            const statusBadge = {
                                'pending': 'bg-warning text-dark',
                                'approved': 'bg-success',
                                'rejected': 'bg-danger'
                            }[status] || 'bg-secondary';
                            
                            businessProductsHtml += `
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <h6 class="card-title mb-0">${product.productName || product.name || 'Unnamed Product'}</h6>
                                                        <span class="badge ${statusBadge}">${status.toUpperCase()}</span>
                                                    </div>
                                                    <p class="text-muted small mb-1">Business: ${product.businessName || product.businessId || 'Unknown'}</p>
                                                    <p class="text-success fw-bold mb-1">Price: $${product.price || 'N/A'}</p>
                                                    <p class="text-muted small mb-1">Stock: ${product.stock || product.quantity || 'N/A'}</p>
                                                    ${product.masterProductId ? `<small class="text-info">Master: ${product.masterProductId}</small>` : ''}
                                                </div>
                                                <div class="btn-group-vertical btn-group-sm">
                                                    <button class="btn btn-outline-info btn-sm" onclick="viewBusinessProduct('${product.id}')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    ${status === 'pending' ? `
                                                        <button class="btn btn-success btn-sm" onclick="approveBusinessProduct('${product.id}')">
                                                            <i class="fas fa-check"></i> Approve
                                                        </button>
                                                        <button class="btn btn-danger btn-sm" onclick="rejectBusinessProduct('${product.id}')">
                                                            <i class="fas fa-times"></i> Reject
                                                        </button>
                                                    ` : status === 'approved' ? `
                                                        <span class="badge bg-success">âœ… Approved</span>
                                                    ` : `
                                                        <button class="btn btn-success btn-sm" onclick="approveBusinessProduct('${product.id}')">
                                                            <i class="fas fa-redo"></i> Re-approve
                                                        </button>
                                                    `}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        businessProductsHtml += '</div>';
                    } else {
                        businessProductsHtml = `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                No business products found with status: ${statusFilter}
                            </div>
                        `;
                    }
                } else {
                    businessProductsHtml = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No business product listings found. Businesses will add pricing once master products exist.
                        </div>
                    `;
                }
                
                document.getElementById('businessProductsContent').innerHTML = businessProductsHtml;
                
            } catch (error) {
                console.error('Error loading business products:', error);
                document.getElementById('businessProductsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading business products: ${error.message}
                    </div>
                `;
            }
        };

        // Approve Business Product - Fixed to handle status properly
        window.approveBusinessProduct = async (productId) => {
            try {
                await updateDoc(doc(db, 'business_products', productId), {
                    status: 'approved',
                    approvedAt: new Date(),
                    approvedBy: 'admin'
                });
                
                showNotification('âœ… Business product approved successfully!', 'success');
                
                // Refresh the business products list
                setTimeout(() => {
                    loadBusinessProductsData();
                }, 1000);
                
            } catch (error) {
                console.error('Error approving business product:', error);
                showNotification(`âŒ Error approving product: ${error.message}`, 'error');
            }
        };

        // Reject Business Product
        window.rejectBusinessProduct = async (productId) => {
            try {
                await updateDoc(doc(db, 'business_products', productId), {
                    status: 'rejected',
                    rejectedAt: new Date(),
                    rejectedBy: 'admin'
                });
                
                showNotification('âŒ Business product rejected', 'warning');
                
                // Refresh the business products list
                setTimeout(() => {
                    loadBusinessProductsData();
                }, 1000);
                
            } catch (error) {
                console.error('Error rejecting business product:', error);
                showNotification(`âŒ Error rejecting product: ${error.message}`, 'error');
            }
        };

        // Filter Business Products
        window.filterBusinessProducts = (status) => {
            loadBusinessProductsData(status);
        };

        // Placeholder functions for modals and other actions
        window.showAddCategoryModal = () => {
            showNotification('Category management will be implemented', 'info');
        };

        window.showAddMasterProductModal = () => {
            showNotification('Master product creation will be implemented', 'info');
        };

        window.viewBusinessProduct = (productId) => {
            showNotification(`Viewing business product: ${productId}`, 'info');
        };

        window.viewMasterProduct = (productId) => {
            showNotification(`Viewing master product: ${productId}`, 'info');
        };

        window.editCategory = (categoryId) => {
            showNotification(`Editing category: ${categoryId}`, 'info');
        };

        window.deleteCategory = (categoryId) => {
            showNotification(`Deleting category: ${categoryId}`, 'info');
        };

        window.editMasterProduct = (productId) => {
            showNotification(`Editing master product: ${productId}`, 'info');
        };

        window.deleteMasterProduct = (productId) => {
            showNotification(`Deleting master product: ${productId}`, 'info');
        };

        window.loadAnalytics = () => {
            document.getElementById('analyticsContent').innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-chart-line me-2"></i>
                    Analytics dashboard will show:
                    <ul class="mt-2 mb-0">
                        <li>Price comparison trends</li>
                        <li>Popular products by category</li>
                        <li>Business participation rates</li>
                        <li>Approval/rejection statistics</li>
                    </ul>
                </div>
            `;
        };

        // Auto-load dashboard on start
        setTimeout(() => {
            refreshDashboard();
        }, 1000);

        // Show welcome message
        setTimeout(() => {
            showNotification('ðŸŽ‰ Enhanced Product Admin Loaded Successfully!', 'success');
        }, 2000);
    </script>
</body>
</html>
