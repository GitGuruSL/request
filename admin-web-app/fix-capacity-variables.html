<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Capacity Variables</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            deleteDoc, 
            doc,
            addDoc,
            query,
            where,
            orderBy
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBhz3Bh9BM87p5xJBhvCdOTITVTfBE-44k",
            authDomain: "request-marketplace-89dd4.firebaseapp.com",
            projectId: "request-marketplace-89dd4",
            storageBucket: "request-marketplace-89dd4.firebasestorage.app",
            messagingSenderId: "704374194045",
            appId: "1:704374194045:web:fd48b83d17df80cea44bb4",
            measurementId: "G-58JQ3SN8GB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.collection = collection;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.addDoc = addDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;

        // Make functions available globally
        window.fixCapacityVariables = fixCapacityVariables;
        window.showCurrentVariables = showCurrentVariables;

        async function showCurrentVariables() {
            try {
                console.log('=== Current Custom Variables ===');
                const snapshot = await getDocs(collection(db, 'custom_product_variables'));
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log(`ID: ${doc.id}`);
                    console.log(`Name: ${data.name}`);
                    console.log(`Type: ${data.type}`);
                    console.log(`Values: ${JSON.stringify(data.possibleValues)}`);
                    console.log(`Created: ${data.createdAt}`);
                    console.log('---');
                });
                
                console.log(`Total: ${snapshot.size} variables`);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function fixCapacityVariables() {
            try {
                console.log('ðŸ”§ Starting capacity variables fix...');
                
                // Step 1: Delete all existing "Capacity" variables
                console.log('ðŸ—‘ï¸ Step 1: Deleting existing Capacity variables...');
                const capacityQuery = query(
                    collection(db, 'custom_product_variables'),
                    where('name', '==', 'Capacity')
                );
                const capacitySnapshot = await getDocs(capacityQuery);
                
                const deletePromises = [];
                capacitySnapshot.forEach(doc => {
                    console.log(`Deleting: ${doc.id}`);
                    deletePromises.push(deleteDoc(doc(db, 'custom_product_variables', doc.id)));
                });
                
                await Promise.all(deletePromises);
                console.log(`âœ… Deleted ${deletePromises.length} duplicate Capacity variables`);
                
                // Step 2: Create properly formatted capacity variables
                console.log('âž• Step 2: Creating individual capacity variables...');
                
                const capacityVariables = [
                    {
                        name: 'Capacity 128GB',
                        type: 'number',
                        possibleValues: ['128'],
                        usageCount: 0,
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'Capacity 256GB',
                        type: 'number',
                        possibleValues: ['256'],
                        usageCount: 0,
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'Capacity 512GB',
                        type: 'number',
                        possibleValues: ['512'],
                        usageCount: 0,
                        createdAt: new Date().toISOString()
                    }
                ];
                
                const createPromises = [];
                capacityVariables.forEach(variable => {
                    console.log(`Creating: ${variable.name} with value: ${variable.possibleValues[0]}`);
                    createPromises.push(addDoc(collection(db, 'custom_product_variables'), variable));
                });
                
                await Promise.all(createPromises);
                console.log(`âœ… Created ${createPromises.length} individual capacity variables`);
                
                // Step 3: Show results
                console.log('ðŸ“‹ Step 3: Showing updated variables...');
                await showCurrentVariables();
                
                console.log('ðŸŽ‰ Fix completed successfully!');
                
            } catch (error) {
                console.error('âŒ Error fixing capacity variables:', error);
            }
        }

        // Auto-run on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ðŸ”§ Capacity Variables Fix Tool');
            console.log('ðŸ“‹ Use showCurrentVariables() to see current state');
            console.log('ðŸ”§ Use fixCapacityVariables() to fix the capacity variables');
            
            await showCurrentVariables();
        });
    </script>
</head>
<body>
    <div style="padding: 20px; font-family: Arial, sans-serif;">
        <h1>Fix Capacity Variables</h1>
        <p>This tool will fix the capacity variables to show individual values instead of duplicates.</p>
        
        <div style="margin: 20px 0;">
            <button onclick="showCurrentVariables()" style="padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px;">
                Show Current Variables
            </button>
            <button onclick="fixCapacityVariables()" style="padding: 10px 20px; margin: 5px; background: #28a745; color: white; border: none; border-radius: 5px;">
                Fix Capacity Variables
            </button>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
            <h3>What this will do:</h3>
            <ol>
                <li><strong>Delete</strong> all existing "Capacity" variables (the 3 duplicates)</li>
                <li><strong>Create</strong> individual capacity variables:
                    <ul>
                        <li>"Capacity 128GB" with value: 128</li>
                        <li>"Capacity 256GB" with value: 256</li>
                        <li>"Capacity 512GB" with value: 512</li>
                    </ul>
                </li>
                <li><strong>Show</strong> the updated list</li>
            </ol>
        </div>
        
        <div style="background: #d4edda; padding: 15px; border-radius: 5px; margin: 20px 0; border: 1px solid #c3e6cb;">
            <h4>Expected Result:</h4>
            <p>Instead of 3 identical "Capacity" entries showing "128, 256, 512", you'll have:</p>
            <ul>
                <li><strong>Capacity 128GB</strong> â†’ Values: 128</li>
                <li><strong>Capacity 256GB</strong> â†’ Values: 256</li>
                <li><strong>Capacity 512GB</strong> â†’ Values: 512</li>
            </ul>
        </div>
    </div>
</body>
</html>
