import React, { useState, useEffect } from 'react';
import {
  Container,
  Typography,
  Card,
  CardContent,
  Button,
  Box,
  Chip,
  Grid,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Alert,
  Avatar,
  IconButton,
  CircularProgress,
  Tabs,
  Tab,
  CardHeader,
  CardMedia,
  CardActions
} from '@mui/material';
import {
  Person as PersonIcon,
  CheckCircle as ApproveIcon,
  Cancel as RejectIcon,
  Visibility as ViewIcon,
  Phone as PhoneIcon,
  Email as EmailIcon,
  LocationOn as LocationIcon,
  DriveEta as CarIcon,
  Image as ImageIcon,
  CheckCircleOutline as CheckIcon,
  RadioButtonUnchecked as PendingIcon,
  Error as ErrorIcon,
  TwoWheeler,
  DirectionsCar,
  LocalTaxi,
  AirportShuttle,
  People,
  LocalShipping,
  Assignment as AssignmentIcon,
  Description as DescriptionIcon,
  Security as SecurityIcon
} from '@mui/icons-material';
import { useAuth } from '../contexts/AuthContext';
import { db } from '../firebase/config';
import { 
  collection, 
  getDocs, 
  doc, 
  updateDoc,
  query,
  where,
  orderBy,
  Timestamp,
  getDoc
} from 'firebase/firestore';

const DriverVerificationEnhanced = () => {
  const { adminData, isCountryAdmin, isSuperAdmin } = useAuth();
  const [drivers, setDrivers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedDriver, setSelectedDriver] = useState(null);
  const [detailsOpen, setDetailsOpen] = useState(false);
  const [filterStatus, setFilterStatus] = useState('all');
  const [filterVehicleType, setFilterVehicleType] = useState('all');
  const [tabValue, setTabValue] = useState(0);
  const [vehicleTypes, setVehicleTypes] = useState({});
  
  // Document verification states
  const [rejectionDialog, setRejectionDialog] = useState({ open: false, target: null, type: '' });
  const [rejectionReason, setRejectionReason] = useState('');
  const [actionLoading, setActionLoading] = useState(false);

  // Vehicle type icons mapping
  const vehicleIcons = {
    'TwoWheeler': <TwoWheeler />,
    'DirectionsCar': <DirectionsCar />,
    'LocalTaxi': <LocalTaxi />,
    'AirportShuttle': <AirportShuttle />,
    'People': <People />,
    'LocalShipping': <LocalShipping />
  };

  useEffect(() => {
    loadVehicleTypes();
  }, []);

  useEffect(() => {
    loadDrivers();
  }, [filterStatus, filterVehicleType]);

  const loadVehicleTypes = async () => {
    try {
      const vehicleTypesQuery = query(collection(db, 'vehicle_types'));
      const snapshot = await getDocs(vehicleTypesQuery);
      const vehicleTypesMap = {};
      
      snapshot.docs.forEach(doc => {
        const data = doc.data();
        vehicleTypesMap[doc.id] = {
          name: data.name,
          icon: data.icon
        };
      });
      
      setVehicleTypes(vehicleTypesMap);
    } catch (error) {
      console.error('Error loading vehicle types:', error);
    }
  };

  const getDocumentStatus = (driver, docType) => {
    const docVerification = driver.documentVerification?.[docType];
    if (docVerification?.status) return docVerification.status;
    
    // Fallback to flat status fields
    switch (docType) {
      case 'driverImage': return driver.driverImageStatus || 'pending';
      case 'licenseFront': return driver.licenseFrontStatus || 'pending';
      case 'licenseBack': return driver.licenseBackStatus || 'pending';
      case 'licenseDocument': return driver.licenseDocumentStatus || 'pending';
      case 'vehicleInsurance': return driver.vehicleInsuranceStatus || 'pending';
      case 'vehicleRegistration': return driver.vehicleRegistrationStatus || 'pending';
      default: return 'pending';
    }
  };

  const getDocumentUrl = (driver, docType) => {
    switch (docType) {
      case 'driverImage': return driver.driverImageUrl;
      case 'licenseFront': return driver.licenseFrontUrl;
      case 'licenseBack': return driver.licenseBackUrl;
      case 'licenseDocument': return driver.licenseDocumentUrl;
      case 'vehicleInsurance': return driver.insuranceDocumentUrl;
      case 'vehicleRegistration': return driver.vehicleRegistrationUrl;
      default: return null;
    }
  };

  const getVehicleTypeDisplay = (vehicleTypeId) => {
    if (!vehicleTypeId || !vehicleTypes[vehicleTypeId]) {
      return { name: vehicleTypeId || 'Unknown', icon: <CarIcon /> };
    }
    const vehicleType = vehicleTypes[vehicleTypeId];
    return {
      name: vehicleType.name,
      icon: vehicleIcons[vehicleType.icon] || <CarIcon />
    };
  };

  useEffect(() => {
    loadDrivers();
  }, [filterStatus]);

  const loadDrivers = async () => {
    try {
      setLoading(true);
      console.log('ðŸ”„ Loading drivers...');
      
      let driverQuery = collection(db, 'new_driver_verifications');
      const conditions = [];
      
      // Country-based filtering for country admins
      if (isCountryAdmin && adminData?.country) {
        conditions.push(where('country', '==', adminData.country));
      }
      
      // Status filtering
      if (filterStatus !== 'all') {
        conditions.push(where('status', '==', filterStatus));
      }
      
      if (conditions.length > 0) {
        driverQuery = query(driverQuery, ...conditions);
      }

      const snapshot = await getDocs(driverQuery);
      const driverList = [];
      const missingCountryDrivers = [];
      
      for (const docSnapshot of snapshot.docs) {
        const data = docSnapshot.data();
        const driverData = { id: docSnapshot.id, ...data };
        
        // Auto-migrate missing country field
        if (!data.country && data.userId && isSuperAdmin) {
          missingCountryDrivers.push({ docRef: docSnapshot.ref, data: driverData });
        }
        
        driverList.push(driverData);
      }
      
      // Fix missing country data
      for (const { docRef, data } of missingCountryDrivers) {
        try {
          const userDoc = await getDoc(doc(db, 'users', data.userId));
          let countryToSet = 'LK';
          let countryNameToSet = 'Sri Lanka';
          
          if (userDoc.exists()) {
            const userData = userDoc.data();
            if (userData.countryCode) {
              countryToSet = userData.countryCode;
              countryNameToSet = userData.countryName || 'Unknown';
            }
          }
          
          await updateDoc(docRef, {
            country: countryToSet,
            countryName: countryNameToSet,
            updatedAt: Timestamp.now()
          });
          
          const driverIndex = driverList.findIndex(d => d.id === data.id);
          if (driverIndex !== -1) {
            driverList[driverIndex].country = countryToSet;
            driverList[driverIndex].countryName = countryNameToSet;
          }
        } catch (error) {
          console.error(`Failed to update country for driver ${data.name}:`, error);
        }
      }
      
      // Sort by created date
      driverList.sort((a, b) => {
        const aTime = a.submittedAt?.toDate?.() || a.createdAt?.toDate?.() || new Date(0);
        const bTime = b.submittedAt?.toDate?.() || b.createdAt?.toDate?.() || new Date(0);
        return bTime - aTime;
      });

      // Client-side filtering by vehicle type
      let filteredDrivers = driverList;
      if (filterVehicleType !== 'all') {
        filteredDrivers = driverList.filter(driver => driver.vehicleType === filterVehicleType);
      }
      
      setDrivers(filteredDrivers);
      console.log(`Loaded ${filteredDrivers.length} drivers (filtered from ${driverList.length})`);
    } catch (error) {
      console.error('Error loading drivers:', error);
    } finally {
      setLoading(false);
    }
  };

  const getStatusColor = (status) => {
    switch (status?.toLowerCase()) {
      case 'approved': return 'success';
      case 'rejected': return 'error';
      case 'pending': return 'warning';
      default: return 'default';
    }
  };

  const getStatusIcon = (status) => {
    switch (status?.toLowerCase()) {
      case 'approved': return <CheckIcon />;
      case 'rejected': return <ErrorIcon />;
      case 'pending': return <PendingIcon />;
      default: return <PendingIcon />;
    }
  };

  const handleDocumentAction = async (driver, docType, action) => {
    if (action === 'reject') {
      setRejectionDialog({ 
        open: true, 
        target: driver,
        type: 'document',
        docType: docType
      });
      return;
    }

    setActionLoading(true);
    try {
      const updateData = {
        [`documentVerification.${docType}.status`]: action,
        [`${docType}Status`]: action,
        updatedAt: Timestamp.now()
      };

      if (action === 'approved') {
        updateData[`documentVerification.${docType}.approvedAt`] = Timestamp.now();
      }

      await updateDoc(doc(db, 'new_driver_verifications', driver.id), updateData);
      await loadDrivers(); // Refresh data
      console.log(`âœ… Document ${docType} ${action} for ${driver.name}`);
    } catch (error) {
      console.error(`Error updating document status:`, error);
    } finally {
      setActionLoading(false);
    }
  };

  const handleDriverAction = async (driver, action) => {
    if (action === 'reject') {
      setRejectionDialog({ 
        open: true, 
        target: driver,
        type: 'driver'
      });
      return;
    }

    if (action === 'approve') {
      // Check if all documents are approved
      const docTypes = ['licenseImage', 'idImage', 'vehicleRegistration', 'profileImage'];
      const allDocsApproved = docTypes.every(docType => {
        const status = getDocumentStatus(driver, docType);
        const url = getDocumentUrl(driver, docType);
        return !url || status === 'approved'; // Skip missing documents
      });

      if (!allDocsApproved) {
        alert('All submitted documents must be approved before approving the driver.');
        return;
      }

      // Check contact verification (similar to business verification)
      try {
        const userDoc = await getDoc(doc(db, 'users', driver.userId));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          const linkedCredentials = userData.linkedCredentials || {};
          const phoneVerified = linkedCredentials.linkedPhoneVerified || false;
          const emailVerified = linkedCredentials.linkedEmailVerified || false;

          if (!phoneVerified || !emailVerified) {
            const missing = [];
            if (!phoneVerified) missing.push('phone');
            if (!emailVerified) missing.push('email');
            alert(`Cannot approve driver. User must verify: ${missing.join(', ')}`);
            return;
          }
        }
      } catch (error) {
        console.error('Error checking contact verification:', error);
      }
    }

    setActionLoading(true);
    try {
      const updateData = {
        status: action,
        updatedAt: Timestamp.now()
      };

      if (action === 'approved') {
        updateData.approvedAt = Timestamp.now();
        updateData.isVerified = true;
      }

      await updateDoc(doc(db, 'new_driver_verifications', driver.id), updateData);
      await loadDrivers();
      console.log(`âœ… Driver ${action}: ${driver.name}`);
    } catch (error) {
      console.error(`Error ${action} driver:`, error);
    } finally {
      setActionLoading(false);
    }
  };

  const handleRejection = async () => {
    if (!rejectionReason.trim()) {
      alert('Please provide a reason for rejection');
      return;
    }

    const { target, type, docType, imageIndex } = rejectionDialog;
    setActionLoading(true);

    try {
      let updateData = {
        updatedAt: Timestamp.now()
      };

      if (type === 'document') {
        updateData[`documentVerification.${docType}.status`] = 'rejected';
        updateData[`documentVerification.${docType}.rejectionReason`] = rejectionReason;
        updateData[`documentVerification.${docType}.rejectedAt`] = Timestamp.now();
        updateData[`${docType}Status`] = 'rejected';
        updateData[`${docType}RejectionReason`] = rejectionReason;
      } else if (type === 'vehicleImage') {
        updateData[`vehicleImageVerification.${imageIndex}.status`] = 'rejected';
        updateData[`vehicleImageVerification.${imageIndex}.rejectionReason`] = rejectionReason;
        updateData[`vehicleImageVerification.${imageIndex}.rejectedAt`] = Timestamp.now();
      } else {
        updateData.status = 'rejected';
        updateData.rejectionReason = rejectionReason;
        updateData.rejectedAt = Timestamp.now();
        updateData.isVerified = false;
      }

      await updateDoc(doc(db, 'new_driver_verifications', target.id), updateData);
      await loadDrivers();
      
      setRejectionDialog({ open: false, target: null, type: '' });
      setRejectionReason('');
      console.log(`âœ… ${type} rejected: ${target.name}`);
    } catch (error) {
      console.error(`Error rejecting ${type}:`, error);
    } finally {
      setActionLoading(false);
    }
  };

  const renderEnhancedDocumentCard = (docType, title, description, required = true) => {
    const url = getDocumentUrl(selectedDriver, docType);
    const status = getDocumentStatus(selectedDriver, docType);
    const rejectionReason = selectedDriver.documentVerification?.[docType]?.rejectionReason || 
                           selectedDriver[`${docType}RejectionReason`];
    
    // Determine if driver is already approved - if so, all docs should show as approved
    const isDriverApproved = selectedDriver.status === 'approved';
    const displayStatus = isDriverApproved ? 'approved' : status;

    return (
      <Grid item xs={12} md={6} key={docType}>
        <Card 
          variant="outlined" 
          sx={{ 
            height: '100%',
            opacity: !url ? 0.7 : 1,
            border: displayStatus === 'approved' ? 2 : 1,
            borderColor: displayStatus === 'approved' ? 'success.main' : 
                        displayStatus === 'rejected' ? 'error.main' : 'divider'
          }}
        >
          <CardHeader
            avatar={
              <Avatar sx={{ 
                bgcolor: displayStatus === 'approved' ? 'success.main' : 
                        displayStatus === 'rejected' ? 'error.main' : 'grey.400' 
              }}>
                {getDocumentIcon(docType)}
              </Avatar>
            }
            title={
              <Box display="flex" alignItems="center" gap={1}>
                <Typography variant="subtitle1">{title}</Typography>
                {required && displayStatus !== 'approved' && !isDriverApproved && (
                  <Chip label="Required" size="small" color="warning" />
                )}
                {displayStatus === 'approved' && (
                  <Chip label="Verified" size="small" color="success" />
                )}
              </Box>
            }
            subheader={description}
            action={
              <Chip 
                label={displayStatus ? displayStatus.charAt(0).toUpperCase() + displayStatus.slice(1) : 'Not Submitted'} 
                color={getStatusColor(displayStatus)} 
                icon={getStatusIcon(displayStatus)}
                variant="filled"
                size="small"
              />
            }
          />
          
          {url && (
            <CardMedia
              component="img"
              height="120"
              image={url}
              alt={title}
              sx={{ 
                objectFit: 'cover',
                cursor: 'pointer',
                '&:hover': { opacity: 0.8 }
              }}
              onClick={() => viewDocument(url)}
            />
          )}
          
          <CardContent>
            {!url ? (
              <Alert severity="warning" size="small">
                Document not submitted
              </Alert>
            ) : (
              <Box>
                {displayStatus === 'approved' && isDriverApproved && (
                  <Alert severity="success" size="small" sx={{ mb: 1 }}>
                    <Typography variant="caption">
                      <strong>Document Verified:</strong> This document has been approved as part of the driver verification.
                    </Typography>
                  </Alert>
                )}
                
                {rejectionReason && displayStatus === 'rejected' && (
                  <Alert severity="error" size="small" sx={{ mb: 1 }}>
                    <Typography variant="caption">
                      <strong>Rejection Reason:</strong> {rejectionReason}
                    </Typography>
                  </Alert>
                )}
                
                <Box display="flex" justifyContent="space-between" alignItems="center" mt={1}>
                  <Button
                    size="small"
                    startIcon={<ViewIcon />}
                    onClick={() => viewDocument(url)}
                  >
                    View Full Size
                  </Button>
                </Box>
              </Box>
            )}
          </CardContent>
          
          {url && displayStatus === 'pending' && !isDriverApproved && (
            <CardActions>
              <Button 
                size="small"
                color="success"
                startIcon={<CheckIcon />}
                onClick={() => handleDocumentAction(selectedDriver, docType, 'approved')}
                disabled={actionLoading}
              >
                Approve
              </Button>
              <Button 
                size="small"
                color="error"
                startIcon={<ErrorIcon />}
                onClick={() => handleDocumentAction(selectedDriver, docType, 'reject')}
                disabled={actionLoading}
              >
                Reject
              </Button>
            </CardActions>
          )}
          
          {displayStatus === 'approved' && (
            <CardActions>
              <Box display="flex" alignItems="center" gap={1} px={1}>
                <CheckIcon color="success" fontSize="small" />
                <Typography variant="caption" color="success.main">
                  Document verified and approved
                </Typography>
              </Box>
            </CardActions>
          )}
        </Card>
      </Grid>
    );
  };

  // Helper function to get document icons
  const getDocumentIcon = (docType) => {
    switch (docType) {
      case 'driverImage': return <PersonIcon />;
      case 'licenseFront': return <AssignmentIcon />;
      case 'licenseBack': return <AssignmentIcon />;
      case 'licenseDocument': return <DescriptionIcon />;
      case 'vehicleInsurance': return <SecurityIcon />;
      case 'vehicleRegistration': return <AssignmentIcon />;
      default: return <DescriptionIcon />;
    }
  };
    if (url) {
      window.open(url, '_blank');
    }
  };

  const handleVehicleImageAction = async (driver, imageIndex, action) => {
    if (action === 'reject') {
      setRejectionDialog({ 
        open: true, 
        target: driver,
        type: 'vehicleImage',
        imageIndex: imageIndex
      });
      return;
    }

    setActionLoading(true);
    try {
      const updateData = {
        [`vehicleImageVerification.${imageIndex}.status`]: action,
        updatedAt: Timestamp.now()
      };

      if (action === 'approved') {
        updateData[`vehicleImageVerification.${imageIndex}.approvedAt`] = Timestamp.now();
      }

      await updateDoc(doc(db, 'new_driver_verifications', driver.id), updateData);
      await loadDrivers(); // Refresh data
      console.log(`âœ… Vehicle image ${imageIndex} ${action} for ${driver.name}`);
    } catch (error) {
      console.error(`Error updating vehicle image status:`, error);
    } finally {
      setActionLoading(false);
    }
  };

  const renderDriverCard = (driver) => {
    const overallStatus = driver.status || 'pending';
    const documentsCount = ['driverImage', 'licenseFront', 'licenseBack', 'vehicleInsurance', 'vehicleRegistration']
      .filter(docType => getDocumentUrl(driver, docType)).length;
    const approvedDocsCount = ['driverImage', 'licenseFront', 'licenseBack', 'vehicleInsurance', 'vehicleRegistration']
      .filter(docType => {
        const url = getDocumentUrl(driver, docType);
        const status = getDocumentStatus(driver, docType);
        return url && status === 'approved';
      }).length;

    return (
      <Card key={driver.id} sx={{ mb: 2 }}>
        <CardContent>
          <Box display="flex" justifyContent="space-between" alignItems="flex-start">
            <Box flex={1}>
              <Box display="flex" alignItems="center" gap={1} mb={1}>
                <PersonIcon color="primary" />
                <Typography variant="h6">{driver.name || 'Unknown Driver'}</Typography>
                <Chip 
                  label={overallStatus}
                  color={getStatusColor(overallStatus)}
                  size="small"
                  icon={getStatusIcon(overallStatus)}
                />
              </Box>
              
              <Grid container spacing={1} sx={{ mb: 2 }}>
                <Grid item xs={12} sm={6}>
                  <Box display="flex" alignItems="center" gap={1}>
                    <LocationIcon fontSize="small" color="action" />
                    <Typography variant="body2">{driver.country || 'Unknown'} â€¢ {driver.address || 'No address'}</Typography>
                  </Box>
                </Grid>
                <Grid item xs={12} sm={6}>
                  <Box display="flex" alignItems="center" gap={1}>
                    <EmailIcon fontSize="small" color="action" />
                    <Typography variant="body2">{driver.email || 'No email'}</Typography>
                  </Box>
                </Grid>
                <Grid item xs={12} sm={6}>
                  <Box display="flex" alignItems="center" gap={1}>
                    <PhoneIcon fontSize="small" color="action" />
                    <Typography variant="body2">{driver.phoneNumber || 'No phone'}</Typography>
                  </Box>
                </Grid>
                <Grid item xs={12} sm={6}>
                  <Box display="flex" alignItems="center" gap={1}>
                    {(() => {
                      const vehicleDisplay = getVehicleTypeDisplay(driver.vehicleType);
                      return (
                        <>
                          {vehicleDisplay.icon}
                          <Typography variant="body2">{vehicleDisplay.name}</Typography>
                        </>
                      );
                    })()}
                  </Box>
                </Grid>
                <Grid item xs={12}>
                  <Typography variant="body2">
                    Applied: {driver.submittedAt?.toDate?.()?.toLocaleDateString() || 'Unknown'}
                  </Typography>
                </Grid>
              </Grid>

              <Box display="flex" alignItems="center" gap={2}>
                <Typography variant="body2" color="text.secondary">
                  Documents: {approvedDocsCount}/{documentsCount} approved
                </Typography>
              </Box>
            </Box>

            <Box display="flex" flexDirection="column" gap={1}>
              <Button
                startIcon={<ViewIcon />}
                onClick={() => { setSelectedDriver(driver); setDetailsOpen(true); }}
                size="small"
              >
                View Details
              </Button>
              
              {driver.status === 'pending' && (
                <>
                  <Button
                    startIcon={<ApproveIcon />}
                    color="success"
                    onClick={() => handleDriverAction(driver, 'approve')}
                    disabled={actionLoading}
                    size="small"
                  >
                    Approve
                  </Button>
                  <Button
                    startIcon={<RejectIcon />}
                    color="error"
                    onClick={() => handleDriverAction(driver, 'reject')}
                    disabled={actionLoading}
                    size="small"
                  >
                    Reject
                  </Button>
                </>
              )}
            </Box>
          </Box>
        </CardContent>
      </Card>
    );
  };

  // Helper function to get document icons
  const getDocumentIcon = (docType) => {
    switch (docType) {
      case 'driverImage': return <PersonIcon />;
      case 'licenseFront': return <AssignmentIcon />;
      case 'licenseBack': return <AssignmentIcon />;
      case 'licenseDocument': return <DescriptionIcon />;
      case 'vehicleInsurance': return <SecurityIcon />;
      case 'vehicleRegistration': return <AssignmentIcon />;
      default: return <DescriptionIcon />;
    }
  };

  const renderDocumentCard = (driver, docType, title, description = 'Document verification', required = true) => {
    const url = getDocumentUrl(driver, docType);
    const status = getDocumentStatus(driver, docType);
    const rejectionReason = driver.documentVerification?.[docType]?.rejectionReason || 
                           driver[`${docType}RejectionReason`];
    
    // Determine if driver is already approved - if so, all docs should show as approved
    const isDriverApproved = driver.status === 'approved';
    const displayStatus = isDriverApproved ? 'approved' : status;

    return (
      <Grid item xs={12} md={6} key={docType}>
        <Card 
          variant="outlined" 
          sx={{ 
            height: '100%',
            opacity: !url ? 0.7 : 1,
            border: displayStatus === 'approved' ? 2 : 1,
            borderColor: displayStatus === 'approved' ? 'success.main' : 
                        displayStatus === 'rejected' ? 'error.main' : 'divider'
          }}
        >
          <CardHeader
            avatar={
              <Avatar sx={{ 
                bgcolor: displayStatus === 'approved' ? 'success.main' : 
                        displayStatus === 'rejected' ? 'error.main' : 'grey.400' 
              }}>
                {getDocumentIcon(docType)}
              </Avatar>
            }
            title={
              <Box display="flex" alignItems="center" gap={1}>
                <Typography variant="subtitle1">{title}</Typography>
                {required && displayStatus !== 'approved' && !isDriverApproved && (
                  <Chip label="Required" size="small" color="warning" />
                )}
                {displayStatus === 'approved' && (
                  <Chip label="Verified" size="small" color="success" />
                )}
              </Box>
            }
            subheader={description}
            action={
              <Chip 
                label={displayStatus ? displayStatus.charAt(0).toUpperCase() + displayStatus.slice(1) : 'Not Submitted'} 
                color={getStatusColor(displayStatus)} 
                icon={getStatusIcon(displayStatus)}
                variant="filled"
                size="small"
              />
            }
          />
          
          {url && (
            <CardMedia
              component="img"
              height="120"
              image={url}
              alt={title}
              sx={{ 
                objectFit: 'cover',
                cursor: 'pointer',
                '&:hover': { opacity: 0.8 }
              }}
              onClick={() => viewDocument(url)}
            />
          )}
          
          <CardContent>
            {!url ? (
              <Alert severity="warning" size="small">
                Document not submitted
              </Alert>
            ) : (
              <Box>
                {displayStatus === 'approved' && isDriverApproved && (
                  <Alert severity="success" size="small" sx={{ mb: 1 }}>
                    <Typography variant="caption">
                      <strong>Document Verified:</strong> This document has been approved as part of the driver verification.
                    </Typography>
                  </Alert>
                )}
                
                {rejectionReason && displayStatus === 'rejected' && (
                  <Alert severity="error" size="small" sx={{ mb: 1 }}>
                    <Typography variant="caption">
                      <strong>Rejection Reason:</strong> {rejectionReason}
                    </Typography>
                  </Alert>
                )}
                
                <Box display="flex" justifyContent="space-between" alignItems="center" mt={1}>
                  <Button
                    size="small"
                    startIcon={<ViewIcon />}
                    onClick={() => viewDocument(url)}
                  >
                    View Full Size
                  </Button>
                </Box>
              </Box>
            )}
          </CardContent>
          
          {url && displayStatus === 'pending' && !isDriverApproved && (
            <CardActions>
              <Button 
                size="small"
                color="success"
                startIcon={<CheckIcon />}
                onClick={() => handleDocumentAction(driver, docType, 'approved')}
                disabled={actionLoading}
              >
                Approve
              </Button>
              <Button 
                size="small"
                color="error"
                startIcon={<ErrorIcon />}
                onClick={() => handleDocumentAction(driver, docType, 'reject')}
                disabled={actionLoading}
              >
                Reject
              </Button>
            </CardActions>
          )}
          
          {displayStatus === 'approved' && (
            <CardActions>
              <Box display="flex" alignItems="center" gap={1} px={1}>
                <CheckIcon color="success" fontSize="small" />
                <Typography variant="caption" color="success.main">
                  Document verified and approved
                </Typography>
              </Box>
            </CardActions>
          )}
        </Card>
      </Grid>
    );
  };

  const renderDriverDetails = () => {
    if (!selectedDriver) return null;

    return (
      <Dialog open={detailsOpen} onClose={() => setDetailsOpen(false)} maxWidth="md" fullWidth>
        <DialogTitle>
          <Box display="flex" alignItems="center" gap={2}>
            <PersonIcon />
            <Box>
              <Typography variant="h6">{selectedDriver.name}</Typography>
              <Chip 
                label={selectedDriver.status || 'pending'} 
                color={getStatusColor(selectedDriver.status)} 
                size="small"
              />
            </Box>
          </Box>
        </DialogTitle>
        
        <DialogContent>
          <Tabs value={tabValue} onChange={(e, v) => setTabValue(v)}>
            <Tab label="Driver Info" />
            <Tab label="Documents" />
            <Tab label="Vehicle Info" />
          </Tabs>

          {tabValue === 0 && (
            <Box sx={{ mt: 2 }}>
              <Grid container spacing={2}>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="Full Name"
                    value={selectedDriver.name || ''}
                    fullWidth
                    disabled
                    margin="normal"
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="Date of Birth"
                    value={selectedDriver.dateOfBirth || ''}
                    fullWidth
                    disabled
                    margin="normal"
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="Email"
                    value={selectedDriver.email || ''}
                    fullWidth
                    disabled
                    margin="normal"
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="Phone"
                    value={selectedDriver.phoneNumber || ''}
                    fullWidth
                    disabled
                    margin="normal"
                  />
                </Grid>
                <Grid item xs={12}>
                  <TextField
                    label="Address"
                    value={selectedDriver.address || ''}
                    fullWidth
                    disabled
                    margin="normal"
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="License Number"
                    value={selectedDriver.licenseNumber || ''}
                    fullWidth
                    disabled
                    margin="normal"
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="ID Number"
                    value={selectedDriver.idNumber || ''}
                    fullWidth
                    disabled
                    margin="normal"
                  />
                </Grid>
              </Grid>
            </Box>
          )}

          {tabValue === 1 && (
            <Box sx={{ mt: 2 }}>
              <Typography variant="h5" gutterBottom sx={{ mb: 4, fontWeight: 'bold', color: 'primary.main' }}>
                Driver Documents
              </Typography>
              <Grid container spacing={3} sx={{ mb: 4 }}>
                {renderDocumentCard(selectedDriver, 'driverImage', 'Driver Photo', 'Professional driver identification photo', true)}
                {renderDocumentCard(selectedDriver, 'licenseFront', 'Driver License (Front)', 'Front side of driving license with photo', true)}
                {renderDocumentCard(selectedDriver, 'licenseBack', 'Driver License (Back)', 'Back side of driving license with details', true)}
                {selectedDriver.licenseDocumentUrl && renderDocumentCard(selectedDriver, 'licenseDocument', 'License Document (Additional)', 'Additional license documentation if required', false)}
              </Grid>
              
              <Typography variant="h5" gutterBottom sx={{ mb: 4, mt: 6, fontWeight: 'bold', color: 'primary.main' }}>
                Vehicle Documents
              </Typography>
              <Grid container spacing={3} sx={{ mb: 4 }}>
                {renderDocumentCard(selectedDriver, 'vehicleInsurance', 'Vehicle Insurance', 'Valid vehicle insurance certificate', true)}
                {renderDocumentCard(selectedDriver, 'vehicleRegistration', 'Vehicle Registration', 'Official vehicle registration document', true)}
              </Grid>
              
              {selectedDriver.vehicleImageUrls && selectedDriver.vehicleImageUrls.length > 0 && (
                <>
                  <Typography variant="h5" gutterBottom sx={{ mb: 4, mt: 6, fontWeight: 'bold', color: 'primary.main' }}>
                    Vehicle Photos
                  </Typography>
                  <Grid container spacing={3}>
                    {selectedDriver.vehicleImageUrls.map((imageUrl, index) => {
                      const vehicleStatus = selectedDriver.vehicleImageVerification?.[index]?.status || 'pending';
                      const isDriverApproved = selectedDriver.status === 'approved';
                      const displayStatus = isDriverApproved ? 'approved' : vehicleStatus;
                      
                      return (
                        <Grid item xs={12} md={6} key={index}>
                          <Card 
                            variant="outlined" 
                            sx={{ 
                              height: '100%',
                              border: displayStatus === 'approved' ? 2 : 1,
                              borderColor: displayStatus === 'approved' ? 'success.main' : 
                                          displayStatus === 'rejected' ? 'error.main' : 'divider'
                            }}
                          >
                            <CardHeader
                              avatar={
                                <Avatar sx={{ 
                                  bgcolor: displayStatus === 'approved' ? 'success.main' : 
                                          displayStatus === 'rejected' ? 'error.main' : 'grey.400' 
                                }}>
                                  <ImageIcon />
                                </Avatar>
                              }
                              title={
                                <Box display="flex" alignItems="center" gap={1}>
                                  <Typography variant="subtitle1">
                                    {index === 0 ? 'Vehicle Front with Plate' : 
                                     index === 1 ? 'Vehicle Rear with Plate' : 
                                     `Additional Photo ${index - 1}`}
                                  </Typography>
                                  {displayStatus === 'approved' && (
                                    <Chip label="Verified" size="small" color="success" />
                                  )}
                                </Box>
                              }
                              subheader="Vehicle identification photo"
                              action={
                                <Chip 
                                  label={displayStatus ? displayStatus.charAt(0).toUpperCase() + displayStatus.slice(1) : 'Pending'} 
                                  color={getStatusColor(displayStatus)} 
                                  icon={getStatusIcon(displayStatus)}
                                  variant="filled"
                                  size="small"
                                />
                              }
                            />
                            
                            <CardMedia
                              component="img"
                              height="120"
                              image={imageUrl}
                              alt={`Vehicle Photo ${index + 1}`}
                              sx={{ 
                                objectFit: 'cover',
                                cursor: 'pointer',
                                '&:hover': { opacity: 0.8 }
                              }}
                              onClick={() => viewDocument(imageUrl)}
                            />
                            
                            <CardContent>
                              <Box display="flex" justifyContent="space-between" alignItems="center" mt={1}>
                                <Button
                                  size="small"
                                  startIcon={<ViewIcon />}
                                  onClick={() => viewDocument(imageUrl)}
                                >
                                  View Full Size
                                </Button>
                              </Box>
                            </CardContent>
                            
                            {displayStatus === 'pending' && !isDriverApproved && (
                              <CardActions>
                                <Button 
                                  size="small"
                                  color="success"
                                  startIcon={<CheckIcon />}
                                  onClick={() => handleVehicleImageAction(selectedDriver, index, 'approved')}
                                  disabled={actionLoading}
                                >
                                  Approve
                                </Button>
                                <Button 
                                  size="small"
                                  color="error"
                                  startIcon={<ErrorIcon />}
                                  onClick={() => handleVehicleImageAction(selectedDriver, index, 'reject')}
                                  disabled={actionLoading}
                                >
                                  Reject
                                </Button>
                              </CardActions>
                            )}
                            
                            {displayStatus === 'approved' && (
                              <CardActions>
                                <Box display="flex" alignItems="center" gap={1} px={1}>
                                  <CheckIcon color="success" fontSize="small" />
                                  <Typography variant="caption" color="success.main">
                                    Photo verified and approved
                                  </Typography>
                                </Box>
                              </CardActions>
                            )}
                          </Card>
                        </Grid>
                      );
                    })}
                </>
              )}
            </Box>
          )}

          {tabValue === 2 && (
            <Box sx={{ mt: 2 }}>
              <Grid container spacing={2}>
                <Grid item xs={12} sm={6}>
                  <Box sx={{ mb: 2 }}>
                    <Typography variant="subtitle2" gutterBottom>
                      Vehicle Type
                    </Typography>
                    <Box display="flex" alignItems="center" gap={1} sx={{ 
                      p: 2, 
                      border: '1px solid #e0e0e0', 
                      borderRadius: 1,
                      backgroundColor: '#fafafa'
                    }}>
                      {(() => {
                        const vehicleDisplay = getVehicleTypeDisplay(selectedDriver.vehicleType);
                        return (
                          <>
                            {vehicleDisplay.icon}
                            <Typography>{vehicleDisplay.name}</Typography>
                          </>
                        );
                      })()}
                    </Box>
                  </Box>
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="Country"
                    value={selectedDriver.country || ''}
                    fullWidth
                    disabled
                    margin="normal"
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="Vehicle Make & Model"
                    value={selectedDriver.vehicleModel || ''}
                    fullWidth
                    disabled
                    margin="normal"
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="Vehicle Year"
                    value={selectedDriver.vehicleYear || ''}
                    fullWidth
                    disabled
                    margin="normal"
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="License Plate"
                    value={selectedDriver.vehicleNumber || ''}
                    fullWidth
                    disabled
                    margin="normal"
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="Vehicle Color"
                    value={selectedDriver.vehicleColor || ''}
                    fullWidth
                    disabled
                    margin="normal"
                  />
                </Grid>
              </Grid>
            </Box>
          )}
        </DialogContent>

        <DialogActions>
          <Button onClick={() => setDetailsOpen(false)}>Close</Button>
          {selectedDriver.status === 'pending' && (
            <>
              <Button 
                color="error"
                onClick={() => handleDriverAction(selectedDriver, 'reject')}
                disabled={actionLoading}
              >
                Reject Driver
              </Button>
              <Button 
                color="success" 
                variant="contained"
                onClick={() => handleDriverAction(selectedDriver, 'approve')}
                disabled={actionLoading}
              >
                Approve Driver
              </Button>
            </>
          )}
        </DialogActions>
      </Dialog>
    );
  };

  if (loading) {
    return (
      <Container maxWidth="lg" sx={{ mt: 4 }}>
        <Box display="flex" justifyContent="center" alignItems="center" minHeight="200px">
          <CircularProgress />
        </Box>
      </Container>
    );
  }

  return (
    <Container maxWidth="lg" sx={{ mt: 4, mb: 4 }}>
      <Typography variant="h4" gutterBottom>
        Driver Verification
      </Typography>
      
      <Typography variant="subtitle1" color="text.secondary" gutterBottom>
        Manage driver verifications for {adminData?.country || 'all countries'}
      </Typography>

      <Box display="flex" gap={2} mb={3}>
        <FormControl size="small" sx={{ minWidth: 120 }}>
          <InputLabel>Status Filter</InputLabel>
          <Select
            value={filterStatus}
            onChange={(e) => setFilterStatus(e.target.value)}
            label="Status Filter"
          >
            <MenuItem value="all">All Status</MenuItem>
            <MenuItem value="pending">Pending</MenuItem>
            <MenuItem value="approved">Approved</MenuItem>
            <MenuItem value="rejected">Rejected</MenuItem>
          </Select>
        </FormControl>
        
        <FormControl size="small" sx={{ minWidth: 140 }}>
          <InputLabel>Vehicle Type</InputLabel>
          <Select
            value={filterVehicleType}
            onChange={(e) => setFilterVehicleType(e.target.value)}
            label="Vehicle Type"
          >
            <MenuItem value="all">All Vehicles</MenuItem>
            {Object.entries(vehicleTypes).map(([id, vehicleType]) => (
              <MenuItem key={id} value={id}>
                <Box display="flex" alignItems="center" gap={1}>
                  {vehicleIcons[vehicleType.icon] || <CarIcon />}
                  {vehicleType.name}
                </Box>
              </MenuItem>
            ))}
          </Select>
        </FormControl>
        
        <Button variant="outlined" onClick={loadDrivers}>
          Refresh
        </Button>
      </Box>

      {drivers.length === 0 ? (
        <Alert severity="info">
          No driver verifications found for the selected filters.
        </Alert>
      ) : (
        drivers.map(renderDriverCard)
      )}

      {renderDriverDetails()}

      {/* Rejection Dialog */}
      <Dialog open={rejectionDialog.open} onClose={() => setRejectionDialog({ open: false, target: null, type: '' })}>
        <DialogTitle>
          Reject {rejectionDialog.type === 'document' ? 'Document' : 
                  rejectionDialog.type === 'vehicleImage' ? 'Vehicle Image' : 'Driver'}
        </DialogTitle>
        <DialogContent>
          <Typography variant="body2" sx={{ mb: 2 }}>
            Please provide a reason for rejection:
          </Typography>
          <TextField
            fullWidth
            multiline
            rows={3}
            value={rejectionReason}
            onChange={(e) => setRejectionReason(e.target.value)}
            placeholder="Enter rejection reason..."
            variant="outlined"
          />
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setRejectionDialog({ open: false, target: null, type: '' })}>
            Cancel
          </Button>
          <Button 
            color="error" 
            variant="contained"
            onClick={handleRejection}
            disabled={actionLoading || !rejectionReason.trim()}
          >
            Confirm Rejection
          </Button>
        </DialogActions>
      </Dialog>
    </Container>
  );
};

export default DriverVerificationEnhanced;
